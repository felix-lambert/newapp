check the models
**********************models******************************
end check of models
///////////CONFIGURATION//////////////////
********************************routes*************************************
create index...
{ status: '400',
  message: 'IndexAlreadyExistsException[[user] already exists]' } { error: 'IndexAlreadyExistsException[[user] already exists]',
  status: 400 } 400
create index...
{ status: '400',
  message: 'IndexAlreadyExistsException[[announce] already exists]' } { error: 'IndexAlreadyExistsException[[announce] already exists]',
  status: 400 } 400
put mapping...
undefined { acknowledged: true } 200
put mapping...
undefined { acknowledged: true } 200
{}
[0mGET /search [32m200 [0m1.906 ms - -[0m
_________________Ensure authentification__________________
undefined
[0mGET /api/notifications/ [33m400 [0m1.358 ms - 19[0m
[0mGET /auth/username-exists [33m400 [0m0.469 ms - 22[0m
test
[0mGET /auth/email-exists [33m400 [0m0.309 ms - 19[0m
[0mGET / [32m200 [0m2.597 ms - -[0m
authentification
{ email: 'frepirtjiupghtr', password: 'frejrpijgtripjgtr' }
null false { message: 'Incorrect username' }
null
[0mPOST /auth/login [33m400 [0m90.352 ms - 28[0m
**********************Register***********************
register user mongo
{ username: 'felix',
  email: 'lambertfelix8@gmail.com',
  password: 'lebarbarelemelon',
  repeatPassword: 'lebarbarelemelon' }
felix
registerUserES
{ __v: 0,
  salt: '2aa41211e3a6b39d2d8d0745bb23e72de28b68734221b8025dea8a21c1a4a542',
  hash: 'b1060a3e6c8079b98965033b2b8976a3cdd7fda4f19670c9d24908c313e5e14da1de25a8886ce481ab51c174d6b0b23c80ad8c5f3b9e3af29a3da2bf2b9c3a190ea960bc5df5af5559046006c976367e101089a9bc2bc15a2ffd14a13d0a664b8d5b4581922026608aa248f3cc80599cb2cb22265e0eaa0b3365859bfc09bf18b9931a06a1ebcce8e134cc6c9081f770f92ccd530826fcc44417b3c59a3abfa9aaa8ee181fb9ca3f8e72ee3fd71d4ec355e6e7a30ac1642478505772cf75bd53afebf5b516bea909570ad30c1855afda5155ee1c83de035645b7f8c0c351b08df74ff206582f8bb117bb8436b3462f28fee141b605b7769096200707600556d76880b9256a9580495e1f2644a09e5dcbcf6634f17dee3721847c9eaab8283ed41ed6ab5bdb1c113433e4faf2d187bca96cd625c9fb18faa1be76bb2b1d1c3aa75e4412dcc6080835a1afb8d1439282d1e442fdb5f45c7cc05c5c3242bc5f53597c3e4da1b88cb5ae47a7bcb78ec07530d0dca44207c2850fd95bdea223fb4891791922a50bb16d1b80fca114b67e144d6a5a6cb6a43579b3c5ab626a746a0501895d95cd71524a6a63be539c139f29641a74dcf45513c09d7b7a82819e0a65eb59e011db5da25d4e09bdb8e59d9f0a6660247b7e713ecd8b3bb04d4849325ce66a258f139d5bf492d60461d4755fedf109501b620c1be91d7450340a8d465ab6',
  username: 'felix',
  email: 'lambertfelix8@gmail.com',
  profileImage: null,
  _id: 55d202b6d77acc362f902e40,
  DATE_CREATE: Mon Aug 17 2015 17:50:14 GMT+0200 (CEST) }
undefined { _index: 'user',
  _type: 'usr',
  _id: '55d202b6d77acc362f902e40',
  _version: 1,
  created: true }
[0mPOST /auth/register [32m200 [0m21.524 ms - 246[0m
**********************Register***********************
register user mongo
{ email: 'lambertfelix8@gmail.com',
  password: 'lebarbarelemelon',
  repeatPassword: 'lebarbarelemelon' }
undefined
[0mPOST /auth/register [33m400 [0m0.613 ms - 31[0m
**********************Register***********************
register user mongo
{ username: 'felix',
  password: 'lebarbarelemelon',
  repeatPassword: 'lebarbarelemelon' }
felix
[0mPOST /auth/register [33m400 [0m0.501 ms - 31[0m
authentification
{ email: 'lambertfelix8@gmail.com',
  password: 'lebarbarelemelon' }
null false { message: 'Incorrect username' }
null
[0mPOST /auth/login [33m400 [0m1.090 ms - 28[0m
authentification
{ email: 'premier@gmail.com', password: 'premiere' }
null false { message: 'Incorrect username' }
null
[0mPOST /auth/login [33m400 [0m0.965 ms - 28[0m
**********************Register***********************
register user mongo
{ email: 'lambertfelix8@gmail.com',
  password: 'lebarbarelemelodn',
  repeatPassword: 'frergtrgtrtgr' }
[0mPOST /auth/register [33m400 [0m0.380 ms - 37[0m
**********************Register***********************
register user mongo
{ email: 'bobby@gmail.com',
  password: 'lebarbarelemelon',
  confPassword: 'lebarbarelemelon' }
[0mPOST /auth/register [33m400 [0m0.381 ms - 37[0m
**********************Register***********************
register user mongo
{ username: 'bambam',
  email: 'bambam@gmail.com',
  password: 'lebarbarelemelon',
  repeatPassword: 'lebarbarelemelon' }
bambam
registerUserES
{ __v: 0,
  salt: '51d70e58e1dd3a4d4b05b37e0b0f1932109625a7b0e4c0f9de1882622a755401',
  hash: 'edb904b1cc2506acf69fb07f38cdc409c5a3bcaea97a7168933e092ed32e2077177004071d2f68fdfbef25426e037aa7fb143aa7769cf08b7b1c61f7765ffeca973b238e2be2a54867302e1c3e19e112577718e9d330b66853ecb377915ac332e5ee8599e5b3ad647b15fe2fa71149399632d8f127a247366da52345680bd94d8b829f02ca9f945c77e447162c5bde7d9548813d8ed2666f9cce8af53162aad2308fbd140f3530405c73edbd2abbf3db05b50d4a498eee52b8c334fc4555f56c4f1442306a6f63aeedebb76bcaa9881989ec4ebbaec0b8db5bde313c5f954cdeb414ee588a09c85094c64cb3db6ceb7d9703ac15765453f135be126e28660013d30a40d4d17180746e918877cb619e0d4f35b8c910b910de784fa7e41923dc94ede865c7ddbe2169f5cae31e59dd94c24f71f0bc49c6578c86d69f5fce92dce2608ef0a59bce4fa0ea4be7647e2f9cbbf4dec87c30b5e43e6d2d62b51fd9690589215340756b205c9b3b8d5c5c7b1047ccab14fbd03d8706bd374e6b41b5981c96755bb501091719d9dff415ec7f6e5b22ebd0559cf7f2610945721bd5938a2c51da4324ea405b15cee14386cdcca8ecf663cd91a236ae90bb7a1e9669519be4c64e7aa6a099f4ffb397f7630533b827e1f1267a4c82414236b9a07683e48a4962d6e5d0fdb3ee5334112ed2d16c6b48cec4fe0eda5433fc77fbc3ccfc67413f',
  username: 'bambam',
  email: 'bambam@gmail.com',
  profileImage: null,
  _id: 55d202b6d77acc362f902e42,
  DATE_CREATE: Mon Aug 17 2015 17:50:14 GMT+0200 (CEST) }
undefined { _index: 'user',
  _type: 'usr',
  _id: '55d202b6d77acc362f902e42',
  _version: 1,
  created: true }
[0mPOST /auth/register [32m200 [0m10.241 ms - 231[0m
_________________Ensure authentification__________________
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJlbWFpbCI6ImJhbWJhbUBnbWFpbC5jb20ifQ.IjTtiDaOTLu4Uay219v2-NWIqfTKo1-1FoyFgZ6HVzk
test response
{ __v: 0,
  _id: 55d202b6d77acc362f902e42,
  email: 'bambam@gmail.com',
  hash: 'edb904b1cc2506acf69fb07f38cdc409c5a3bcaea97a7168933e092ed32e2077177004071d2f68fdfbef25426e037aa7fb143aa7769cf08b7b1c61f7765ffeca973b238e2be2a54867302e1c3e19e112577718e9d330b66853ecb377915ac332e5ee8599e5b3ad647b15fe2fa71149399632d8f127a247366da52345680bd94d8b829f02ca9f945c77e447162c5bde7d9548813d8ed2666f9cce8af53162aad2308fbd140f3530405c73edbd2abbf3db05b50d4a498eee52b8c334fc4555f56c4f1442306a6f63aeedebb76bcaa9881989ec4ebbaec0b8db5bde313c5f954cdeb414ee588a09c85094c64cb3db6ceb7d9703ac15765453f135be126e28660013d30a40d4d17180746e918877cb619e0d4f35b8c910b910de784fa7e41923dc94ede865c7ddbe2169f5cae31e59dd94c24f71f0bc49c6578c86d69f5fce92dce2608ef0a59bce4fa0ea4be7647e2f9cbbf4dec87c30b5e43e6d2d62b51fd9690589215340756b205c9b3b8d5c5c7b1047ccab14fbd03d8706bd374e6b41b5981c96755bb501091719d9dff415ec7f6e5b22ebd0559cf7f2610945721bd5938a2c51da4324ea405b15cee14386cdcca8ecf663cd91a236ae90bb7a1e9669519be4c64e7aa6a099f4ffb397f7630533b827e1f1267a4c82414236b9a07683e48a4962d6e5d0fdb3ee5334112ed2d16c6b48cec4fe0eda5433fc77fbc3ccfc67413f',
  profileImage: null,
  salt: '51d70e58e1dd3a4d4b05b37e0b0f1932109625a7b0e4c0f9de1882622a755401',
  token: 
   { DATE_CREATED: Mon Aug 17 2015 17:50:14 GMT+0200 (CEST),
     _id: 55d202b6d77acc362f902e43,
     token: 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJlbWFpbCI6ImJhbWJhbUBnbWFpbC5jb20ifQ.IjTtiDaOTLu4Uay219v2-NWIqfTKo1-1FoyFgZ6HVzk' },
  username: 'bambam',
  DATE_CREATE: Mon Aug 17 2015 17:50:14 GMT+0200 (CEST) }
_____________POST /api/announces_____
***************presave announce*****************
_____save item_____
55d202b6d77acc362f902e44
ID : 55d202b6d77acc362f902e44
undefined { _index: 'announce',
  _type: 'ann',
  _id: '55d202b6d77acc362f902e44',
  _version: 1,
  created: true }
null { __v: 0,
  FORMATTED_DATE: '17/08/2015, 5PM:50',
  created: Mon Aug 17 2015 17:50:14 GMT+0200 (CEST),
  title: 'bambam',
  slug: 'bambam',
  type: 'lebarbarelemelon',
  price: undefined,
  creator: 55d202b6d77acc362f902e42,
  activated: undefined,
  category: 'lebarbarelemelon',
  nbComment: 0,
  _id: 55d202b6d77acc362f902e44,
  updated: 
   [ Mon Aug 17 2015 17:50:14 GMT+0200 (CEST),
     Mon Aug 17 2015 17:50:14 GMT+0200 (CEST) ],
  status: 1,
  content: 'bambam@gmail.com',
  tags: undefined }
[0mPOST /api/announces [32m200 [0m12.908 ms - 363[0m
_________________Ensure authentification__________________
edJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJlbWFpbCI6ImJhbWJhbUBnbWFpbC5jb20ifQ.IjTtiDaOTLu4Uay219v2-NWIqfTKo1-1FoyFgZ6HVzk
ERROR
Invalide Token
[0mPOST /api/announces [33m400 [0m0.447 ms - 20[0m
<!DOCTYPE html><html><head><title>Coverage</title><meta charset="utf-8"><script>

headings = [];

onload = function(){
  headings = document.querySelectorAll('h2');
};

onscroll = function(e){
  var heading = find(window.scrollY);
  if (!heading) return;
  var links = document.querySelectorAll('#menu a')
    , link;

  for (var i = 0, len = links.length; i < len; ++i) {
    link = links[i];
    link.className = link.getAttribute('href') == '#' + heading.id
      ? 'active'
      : '';
  }
};

function find(y) {
  var i = headings.length
    , heading;

  while (i--) {
    heading = headings[i];
    if (y >= heading.offsetTop) {
      return heading;
    }
  }
}
</script>
<style>

body {
  font: 14px/1.6 "Helvetica Neue", Helvetica, Arial, sans-serif;
  margin: 0;
  color: #2C2C2C;
  border-top: 2px solid #ddd;
}

#coverage {
  padding: 60px 400px 60px 60px;
}

h1 a {
  color: inherit;
  font-weight: inherit;
}

h1 a:hover {
  text-decoration: none;
}

.onload h1 {
  opacity: 1;
}

h2 {
  width: 80%;
  margin-top: 80px;
  margin-bottom: 0;
  font-weight: 100;
  letter-spacing: 1px;
  border-bottom: 1px solid #eee;
}

a {
  color: #8A6343;
  font-weight: bold;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

ul {
  margin-top: 20px;
  padding: 0 15px;
  width: 100%;
}

ul li {
  float: left;
  width: 40%;
  margin-top: 5px;
  margin-right: 60px;
  list-style: none;
  border-bottom: 1px solid #eee;
  padding: 5px 0;
  font-size: 12px;
}

ul::after {
  content: '.';
  height: 0;
  display: block;
  visibility: hidden;
  clear: both;
}

code {
  font: 12px monaco, monospace;
}

pre {
  margin: 30px;
  padding: 30px;
  border: 1px solid #eee;
  border-bottom-color: #ddd;
  -webkit-border-radius: 2px;
  -moz-border-radius: 2px;
  border-radius: 2px;
  -webkit-box-shadow: inset 0 0 10px #eee;
  -moz-box-shadow: inset 0 0 10px #eee;
  box-shadow: inset 0 0 10px #eee;
  overflow-x: auto;
}

img {
  margin: 30px;
  padding: 1px;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  border-radius: 3px;
  -webkit-box-shadow: 0 3px 10px #dedede, 0 1px 5px #888;
  -moz-box-shadow: 0 3px 10px #dedede, 0 1px 5px #888;
  box-shadow: 0 3px 10px #dedede, 0 1px 5px #888;
  max-width: 100%;
}

footer {
  background: #eee;
  width: 100%;
  padding: 50px 0;
  text-align: right;
  border-top: 1px solid #ddd;
}

footer span {
  display: block;
  margin-right: 30px;
  color: #888;
  font-size: 12px;
}

#menu {
  position: fixed;
  font-size: 12px;
  overflow-y: auto;
  top: 0;
  right: 0;
  margin: 0;
  height: 100%;
  padding: 15px 0;
  text-align: right;
  border-left: 1px solid #eee;
  max-width: 400px;
  overflow: auto;
  white-space: nowrap;
  
  -moz-box-shadow: 0 0 2px #888
     , inset 5px 0 20px rgba(0,0,0,.5)
     , inset 5px 0 3px rgba(0,0,0,.3);
  -webkit-box-shadow: 0 0 2px #888
     , inset 5px 0 20px rgba(0,0,0,.5)
     , inset 5px 0 3px rgba(0,0,0,.3);
  box-shadow: 0 0 2px #888
     , inset 5px 0 20px rgba(0,0,0,.5)
     , inset 5px 0 3px rgba(0,0,0,.3);
  -webkit-font-smoothing: antialiased;
  background: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGYAAABmCAMAAAAOARRQAAABelBMVEUjJSU6OzshIyM5OjoqKy02NjgsLS01NTYjJCUzNTUgISMlJSc0NTUvMDA6PDwlJyg1NjYoKis2NjYrLS02ODkpKyw0NDYrLC04ODovLzA4Ojo0NDUtLy86OjwjIyU4OTosLS82ODgtLS8hIyQvMTEnKCooKSsrKy0qLCwkJSUnKCkrLCwpKiwwMjIxMzMqLC0tLS0pKissLC00NTYwMDIwMTQpKysoKSovMDEtLzA2OTkxMzUrKywvLy8qKyszNTY5OzsqKiw6OjswMDExNDUoKiozNDUvMDIyNDY1Njg2Njk5OTozMzU0NjY4ODkiIyUiIyQ4OTkuMDEmKCowMjQwMTErLS4qKywwMTMhIiMpKiopKy0tLjAkJScxNDQvLzExNDYyNDQmKCk5OTslJig5OjskJSYxMzQrLS8gISIwMTIoKCk1NTUlJSUnJygwMDA4ODgiIiMhISI8PDw6Ojo5OTkpKSojIyQ7OzsyMjIpKSssLCw6Ozw1NjlrfLakAAAg2UlEQVR42jR6i3ea6rYvPgANIAhVXh8WvkQlioUiFlFcBtAmoiRNdzxqu9p0J7vrdK29zuPeex77nnvO/35n1r1ndHRktI0jTOacv/l7lCBK5UqVpOha/YxmWK7BC4TQFKVXrbYsnimqxuuMVlOQ0XltWjUdCwRJ1M+tC1KudOs9q6+da2adUewG0SC0SwELfHtgDds93VEuydEbl3QMWeNoYkR7b/0x1ZRobGI3mLwzAhePqTAwhg6aogjNsGy7/jwQ4rkdqe7CWLxF8k9LfMVFyRS7VJqtkrW8Vt/bkR8FZJao16ipknbC3Yw2lM7laO6HBEOadEZ2tpf65c4v8e3u7FyU6qbiNNyCuzXZ6pawgnwgmrpTT/Q7w2EZmiIJ0dzWDI7mhQ80IfRnMu2kzA5r5r1pIFoia+/d93HRYp1GV8TbrkWoU/+jdI0Ff6yGwTjT1Hn8J+8m1rKpGiYPuNiHnMtNMIv+zpsk84MYTNW1/+DpwXLvckdOCMYowVNPREe0QlM8xRHXXFhcNDzupwsSmb5pH+0t0RP2Qk+QtI7F1Qm6JRC6ZPBtPq/dq/kH+jxtCljn9TIpW6rQIgmSVyj6lPICIw4N/taka41PFUInth0je9+jO6Kt1G4/a7V2LEgG02B0pHVuCZrgltSKMuIl5SyufUv9mYuQi+mFgzbBEtFo2g+Dh4sSTrLNu8JPh00sQydpb00tqXBvqRN7Q7kqzcnIxCGnvZt/WmJacoOEO6Dcn8Qre03pOCSQxbMOXUuDNx9SxuLz4W1I18gvjViQ67zV0rxdWL8Te/TQkuo8STS41DR48W7L6YP2uWIqiUV8rd6Gbf/rnegKZeG8TpAM6afhGze9JAOxbLjsnUXEbrZ9vLYd7MT32cPF5mKKxmjy7huaoD9n62GOxni3iIJwv0IzZAZjdZkUtolCNLVfYZNaquFjGszVVf+J0vrz4CawoKdHnOzb0NMH7CDBOybfYNJ4rfeMyFNjkFYVTzMFs87rnPGXLUOeNKRVc0LnU7/UIgelzsy3CMuth0YfvnY0wsD3vODUL3eJcKqHQpm8yM3XZQWJxO6Un9iYloyyLpOwN2obHy6W6gbpcb44XmyC+mg+itAcaprGcrwZCqMj/GmtKn0zPvpTz/Cv1dw21XwP3cRupg3H3MF/S71eTKj1YrdwKdc2Mw0fRmb2sFf8lW3aU6JbIZSEPqvXvjM7G/aApyXlXeqKfMq0g/Su3rUGJPSPrtGElgknrZM3xUXqsAP6zMCNVn5u8aJnSNpJv2uru7t2jfRziW2+GuhqfldUNbPk71olwo+46ePUo1U3WKk/e5YK07F/wGRgcpODmQnIlVeHCWBE4puBi2jq28UKpqiN1/4UOrGz59TNYrrQHtd+11sG40BGD+pXdelNqGOg4NXe8W4eacJV/NS9/2Umtym6WQqveqR9xdCMElpxnbkalM4Vf9uaEcWZaKdyibEIjWKxJZPN95niCL3GiaXyssIrHxoLkqkzLCXULN46/f2h3tQJgyip+Tk9EAjJ9aJshq7t8X45aowSKspMSvPf7r9R8yxNptIaHS5ozuEm6luPDApugyNP8OaqiQ4BjaequXA54SLC83eHIY2r+CZp4409Xqw8Aa2oI7XkCrQi+in0w5AqF/kLNrcUz+qkl/lAobY1jSnx5OJNhyXIz3qfNFlXc0TKaglNwdWkWYt9QQ1Kr6W8zue21iNrdJk+N5oCr2O9nEtWKC7IS5J/zdDEYrmnAYfg6agCy+qcgz7ZofeDc4PbUWSvkshWuAc7OjiUyLkj+RAtdlwXJcjxdpkTTHDhK8lBCi8+JtvDVL1W6elmOM++YS0LuSlaP1oUvAeiW3cFnvTr8EbTz1tsSMYdGeZe40sRWu5uAfj7q+ZoKv2FNQ0p5XY1lmlcigHZqTPpabufEVrNuNPi165w3uCVQJHyJqmSJ7ZHnguqwtCmwViIJijj04ba2JNYtB+yORf5gg1/9t9iw4vUpeqiunSAbf+IBdj/b+iG2qrHvuNP0Vd/+ThVZT/lrvHYjjgDbbyxaqgHNM2uhxa1GW3UedZYhMMwM4mQhltouK+IV4NdbIQNM+8Yv311RZk9kT4tiYR4LkyFcuPpdcjuhUuFqBAWRZa11lcZ3gEBlXywsNhrt+plISZP5DlsV9l4EgY6J3yZPTUcMrgaWAT3oI79eSbGEbcJpr6BD8kyDiVt+G0/hXosQN4NFXKlfWIfsIs0BHODVok1/IGnKFHJYIquh8Xo+2+bkQNTGgWmN/fZ0Y33LSj6lr1GyV7mWIKg7ZTRZPGuhF/zjRNcQ1UPtSYgnWQxSs0yrVhwNDcdGMNSNe2JT3WuzbAM3HykyAajS3Uphf6STKEqxLas9EnmnhA/lyj9Uj+JoY7SVgVmGLl46Rm2u98sbkap2lzAdKBG4r6LgulQOSSjQv1GWdQ0jtDUK/mAaqM1Uqjpu4k3Rvfvxv7YTxLSK+wN3E5jVIzmF23uZ7hiH/sVP49D7tvoKp4S8b1LuvRlivVB/algbhcFITYVXvDpLzpDfplR2uD5V4XJFxpjmIpLc9Y5sB2TpBRix7Bme6GZIq+06v3XzNeTcA4obQIKxrnT4C2JpOqD92dbmSX8MGazly5EsZVMvSU1f4RZwyu8iQXbVdeLlZrjuTT1jrY1uk5c7iZ7RsvhhluqAkq4JpVQAg7RJFtSu+xgJ8Pv6O1j5DkLxT8mkbfyRW5DrQmG7hiDIjCgBsADbjuof6YHLGeV6a5Q1Smx9joUXPpdaaDx97A/Wq00oJkdR7ZYuQRfS533JtxO1erduqWOYIt3wh0wpbLuCNIYkwxbswbikCUu2CDCS+Q+7rgVtfRcm+SOcdKPRlZ/rE7wNVUEE39KTS5uvUKN1PUnkloPkyzhyGQ8qkouEjJ3H/VXdqG6asSRiw3ecMlBvDDt8dDhBHXMwZ2Cajzjr7/76T+IavqPYvz6r7//E/3X3+N//h/0QozbjPgPiir69P/8X3/9F/yv8b/827/++98WItPu5/Hvwd8YPf5bp/2/lX/T/+Of/0MJ/lYTa+L/Ef+d9vN/3/2T6P/+jyTzu/evf6U7vxN7B6pJkRtAF6jUr8I+P8RsP/ptGhfqFk+pQ/DgAy6NJtRYJdXmp4gK7WLqLKJ+MaKhGjOojvL+SnIWrkpy0SLHDe4QuyNzaEA15mLMCcmE8Em+4HdOihW4/ZWuppJEmzeAwcDtv7MuLc9y2V5atvxXNe3S4DUMt5/Qy2LM9kSYKiVWBuKlfp4nxTntpuW03JbIlkiRvBXmT23g1I2OYe6IizUHPIq6zm6mbfsbteKmi/sg9J+ocQBMctGFO7iljo8TPN+z3jxw4do+ZwfqoR9dkNTKHyM305GpTkfhcHexVkPVGEbUOjuo9f0UMPHBFlGEx0SLvJvVRKTwW7PSew5oPme+E42+frJa9cGt2njS3dK5kIif2eYbhuSEQXEqMVfUjhGIuin0G0/W5ezJyJQy3SpMLai4M0JUWb5u1k9tny5bd1pPwYBpQuDCXZl62xg4CdVEAtflXHs6JKmP/pH6mOl796Lgopj0o8d5kKh00hxG3OSdEE/QBo9Hgr8JJqAeLDwJohG5j/DGh61Rc/+tf22/8kEnxHNCEjo0ElvvGfESZkqmz2BDcKV1H1buSkhkdg7p1IMGs2s17nYjpblrWuE2K9WEO/hcRp5e9oOF/QBmOaDtgil+oaU6szPrdwW65fOB0KUTsVUn7LFU7J8e6cxJIl9+FHw5MQMzuQJ+4oxMH3iW/5GK+hWuG0T+gTLs+fAjdtUd58TmIUq04EeyRCYCjkldow234aIgR5bqwrtZosZ+6YEqAmDqatJ9lWasz4IquKALPtd92hGI3Z2BdzzZue+REl1Om4DIWD+RrtUTOJLI+S0jHowXXdAxsGLSd40zYNuEUlOGhrwL6c7tcOtUOvpJCP7QBQS19H+GvZn05ewjlVLz+IGKoC9TyfQjLMBNmXCuqqtTdOSukZW48B0HqgSTCBrBnlFvF4CG2Su7yFzqmJFURK3UmTT3ru050r0ptUpMilYnBJWfl2Bv6kPlUuE1kxxpdzui9AubsR2N2boVSu81OulAwBqoSr1LZ0LLYOomyZHmjqnXlP72s8LnDouEJjtodBvdHaG1jMySYO7crWd90MpCRyCG14vb5IE7Arupw/y/RcCm/Tm3zK6zYj8PYNaGldiUfkB/LHWcmf2lVM+mwyU27a0qq2tscrQ/vzBjN26DnntIrOyGizzXK35yKQdYnUABkyN4saz3WD/viF+eCcsXnIajdWYJWaYHRstIis9CS+tqnFGmz2j5uzfr3Z4prqgK4XOT/PyftvjZqIm8lhkfxJ7Ol3CJF1piYBGAG8wtAk56Drw1YwmOpcz+NdfkSpSLplRXLXHL0Rquj6YW/gabqgK7Dgr6NwtH0B/AN7XrN+MVJ6AmXmUuqmQulrNNYPmH0RoDogydOKLo/QbfYNARSQQKISRCzRXU+q9WWJFL3LZW6u34CkeG97xC0NNGaJ0bvK6SnZS3zPskr5EtuCgjMWR5o2x5BqhKmDWJPRe7JMEOyRb5uUKlHaGVtq5ivSOaSliSXp9SQm2qk8MRJh10MAp9QQ2H5t59J8rjiwSZtoIfMGjlLPVNdYl/LBR0AO6WLGDmkLkIPRE45Y9MftdAK/yNu1Hn6tzOQTesgQ+8fSzB19wO91vCnO23vOWQdwJ63SJrYjdfKFW6W281PKs2k8iT9ai1cgJ4sa3xqdvmtxR8/+D1B8AKc2u+6JftryRhMWSQtoSBgIyyQGyxcnELuAasXN12oSriU4RMz1DD6RL0TSV+om7i1Yt+jEE/jnawM8cX/UhN4nkiv/w9eALrzNhXuQfOzFL0Fi6SjF7/4Qn8rLYBoa85cvgAnkCEBP+HPbEnquVXCZsMS/yzYw2Vru60P/+nJPYKkzZFjmbykzUoEqV836T5q3fP/L383dF82tx18/AZgZczMAgyeWYKmSZIqtHL+e+O4ZRcq9VI3g/qPeCoiK4pcgEqdbS0S/Be54sbVQOuJVPNBblIghzeasNu7h/g+Sz1IdhI5lCwq1nUb3Ji4OCIcqQZqtqJ5w7rXrg/DA9IgVmEGhDgGecEwnCTHffXcXs0V3OCEVzYDKS1vp/oX+ng+6XVU86UjA6FMO2RXOOOrqY1GgPvrAk9HV/BXtCu5RuwF8qgdGDLsBcui4E33ymdBip1X8uKyhIWT8qNRDsXz+gvO9UiEC0d8RG4Tf2x8H4slljgHtCBcxHLTWOYJm5H/fCPCzOgf9qgOUxTRZ0Pc6ha5yLuLVT9ntvIa6gacE99mCovdUumTQdRP4RPsS9129eEe2uSvvGh0bV4Y3QPPhPZMqhZWSMa5R0Hc1SGO4IVOQc0FrirlibTVfKRrYkD8kz3b+X65/QkUNaZdrdl3mCap0Hf3YcCw/LiouJYNbqz88UqeDYv93yO7vvXtgl4XCyAO4ODkY6W+83+LZU//p3/zXNGGrUKClCiOnL27iJZbNWDF02XXAOeFlB7IaADoMH1Yqr+UP9biyZDEa/iJt4MDeIz6GKTdLVBfWGVtRN4fdT2rgReX8UXwF2zOrradm4J0nyTgdPnai3RvzpZvCKDUqjOwD/QA6EDaMCLewX6QWYVnHY1sx1bd8ovYnPm1ZvPH+rE20lWjOCnZ66/xDt0QAl15FjfBcZp+i9OU0RNPQ0t3x2pSNWo8eiYudwsnuP1Hq6iH1LJCJynkYsfgJ0p3pF6SoQk2l+jqE8CPk+ziGJRSKjs+W5AO185umPdkYzlK4wl7TC9NxyyDP7ZoyYVoXiuS6SjnInlLWrwz1i8bGTKXX0AVQWkSfIlglW3zRJRJ8bg5VgE6ZEnqNu9B++0GNQvDQJvFize4ESNKBJP+8vA3LM4AX5SIBq08Mob+7QMTCZx4nwP/64+4BnlZC+8WtlP/CXw6t1PwMwkJ3jhP1FiXLhDF/3I6FGUzO2DSi9ABxKyyL9paZxSEz40ZCPQToDAJu1959k7QdbVxgB4icsu2s4zsTPJhcEDo+N1GX4zSk/wriRh8AqwL62972i9HJHd1ydaLXVzvKvOfGGw5RVcUVMiKXFH4APdkQU/dc5BX0YfKTNZYXCW9mb8bc8mufoQP6BbdQmT99ZjoYfr/go4TgQX9IDgztim7wyFeGMfbNaeqj8Dzs38pgcqwSv2hbqB3oSGKWKy+sesY7p57wAHldqE6NDudk/W7s/zjrK4rZFlFvaGxnSZdHbc1y47qDN6xkoK8O3bfr2j41dlJZ71rB4dlDqapPFa8N6xBrprUdtenUCHwxKNhw1uuTBh+9uU45k4REpQABN2bAO9DSLqoIL26gNroWgup5pUMxHUNSq4Gyz47vBPvilpo5f9OYI2ddAqTqmnxXERxQJ3UK8fHbVE9HagHi3+tqNRoNsArdmAxHA5LwtQo9ZAaNKUTljnokljo2x8scqVpEEIPc01fPCdHOCg0DeWBz8D5TVAAfx8aRH5X2ZYNI3ebKDZdeJ+oBDAxmRqJ30Eh2/DaeAy5diVNMpEDmXiPDsGTzBLXy8eVDdJoIafgx/gxMyQi454QrW56nCyeELgSuNNEmYkflF+t3CZQOVRWjKhIuCclmQSlAXT3+4JGG75B4t/5hQ+ldMP4LsAW6z3XmU6IJJwpnGVnsgUZhoY1fZlwTR8wSU7xRejf2uCx9Z5trVTRRJP9KnEb134dEieil6eCOGWgboI7xsqsqM99jfJLTePjygKlH2CVxxsse9QRzTBFjD/Kjqitr/CCTBt/SJ6nLxz7cKP9pFqBpp0lN5y+adKNsZjrPuroemZauH9aTTFD3EKHW8S55XBLFQAt1jgxTQCTwxmx/JyfsZDN1RroN3VaxpSenpIX7K+ZbL8VdlQDcI4Cbzg3QJLa9yVqNxUelu+EtxLVqeekaAvSJkO6sSVqbUajxqhKshNpvZqoeApF0k/0P0ikkwUcbdwc4A1ejN7Oo0O15kG7hTMoK3hZRBCX7YYeLW0wvcXx/18n/u37yLgzBYVBUvORGli+sfRcX/74uD6P4hq+7xu54TlWJLFzT63uwUDwuEDdOjJQqx7JV+ZjaEAPi7t0MMrR4Q8Rkf18uxD6RK0RKh0hL8YU+DeL97i4pa5ZSyAfXKwZRS/8gXcxdZXm62RBDj8U3sN8x95b5PpPs/mCBKYvpaA50pN5Ct/499AFTtwQ5vgeSh+NHrKIi4NVpwM/XzRaNfJD856lPE6M21zWPguFsH7jbLVyEDfRmt4VwrhCJ5VTYmcSPfGgO5clfN+vbaDZ7sakU5+2vZ2WCDY031NxJarVytfDDVtiafcTGO2rJ/taoL3zChN2qmjxofczTOYQPPVQPh0JVtYgdUQINcSiNEEy58UdYXX1MpWUCEBx7LbcGtAm8XWRQTVOaoV3ySri4RShhs/B/0m4jX6OAwXOvcA09bNSG4czEGv/Wey6V/jbTCNTW6awXdNTcA1GsPe1E9fZdGl7R0vyoVpIdJtfC6d32NNErrvq/R+d65VG+YOwRXppXxOCYyGNSf1K3x6VxAW/vtz4EC1SgCOSPdN62sLsoIzuDfg8GwZAbquVO8HIuFP/ToVoeUB7nnwMF35a1wK1tI6fkrqFKhQdeJpwyls0pIy8AZde3/6LUUbFaYJthyUJSU/kqDXTLQElnn0Jr4B2RVghNrmNmoEn7pXIeshPguXVsvwoTdmClq49JJU3LWhHyWTrJL9bRP6VKv3tZoA/th77p5Jw++OEENvyvWy/pNeExiDUVQaXIRGh8xySZTI36yueFaSXo1uJY0RnXYgEOoWWOJHeaVuX/bGNhHsh2yinznl/++NJcE9j6fBPRcBdq9hb8awNw8U7Bl6GM7x69EDOIIbX/npZ++amlHR9L/35mE/2Ss4gb0xCcY4VyTFLRE796vHysLAamqcyO+aFQyJIDBNslbH2/MrAvZiSEIedc/cqjmv4fbda2pXbv+F5a2szSsdkm9noiNURXt8edUhGUF6fSZWd1IJaXKFwD+49R6eCXD4Bkef7j9tRtNMVgW8BhRz/Qpy1TmeYk0doyjZoJSbePOReVHgkFsCFuQJ+Lgc4BxeAsK/cOiNDRmdNw0ctYhn/nQ498dYI5znzGLoJi1rav7Cn88rL3wLePVtDK5gl77Tki3gHEsIAQ2+IKgarj7Y8W1IQzV5V9N+0TjLqbg68WfKcOmBCOj3JkwJhVIkwDhc+JorXuZEPMEh0vvH3x7iqf+VAwXgd4diZiaJD1zHL9Snx6Wfg4IugreyhabQkcir+y5XgDtdx3Avs7lkeeCBwDvZoTUCXx5QrZkcEqWfYEiEYRs/EphmRALSNGR1Iclgdr5VFoELpzF4++f35w3/j0t5ucW3n2ch4PQCLuUXupsPRR7UA5FjSKrMtPcKAZJfagO4lGE7FH3YKMjorpK0ZxAv+i2JkJhtAMWWWFej4RhPR/cJ3DxwocCvXDi4SGZU4cu+K32XndiFWgopAl+0GApcwf1XvymJcFs39jExIBO4yUjU9MExBLQYc9H+W7+IgdESPRpciT+rKZPebVtaVq+1GYO/5xTAL3HASjNTGIgMvdjWbgc7JvdE1zIFpuC0U9ESiZyzBixzxWxj4Kwh8My34q+FK3KNLtmsA1qyrmKSNQOXCPUZd+ONelBTvFoUI/CYsqa/RhtKiyMf2CgSFqEPk59Y3uqnlZ8gFpswfSYyko23yVZYxzKGxGm49Zqxg1l8oz5Ra9XaRwHkuxepmgyhm0SoNy2KlbcEqK+9QqS9PNx9Ihm9U7gsR55SSJ1FBDNnkuWKxIZ0SDpXuOGwZdoUbOMDPHP4vBAgz2VlSEJAHZGJVbYIg7l/FO5KfIVvxC8pPPxMGcNMoevFDeStt2iqztE10n2TA4dgJH76YS9HDhKHD3iCx6ieFX84BAI3QQnngh76f5ruPQVbr5qZmck/5UjDc26lfrOvUBWy0Ogl8bCoOkMOns81TnC3cuUS9KW8+9A+fe3XYZOFUPG1u5epSSmDLw0s5s2F0W30ANeo+zJkJQz9SPZgzwYpEoktofhGVfmLOAB20boCbW1QWq/NpET/hnMecw/uSyAH4NJc3ECOU4nnkK1fj3S/i5dwb3R7k00AqQQUwt7Ie1qV0aY/VQX0J8hLPy7eBNXMHYZYDNxHZ2Qh6AuXJxq+AeRec/Q+JLhZV6hpXwQEzw7bf5v9uUf2vpq3qlhmy0IIGTkwYdCfSAFmqbdo+3XvDTDjFJde0mbeQLcn2n31xaAqJ0ixO/CLsT4I4G4DoncVTgRGNBtsCcjISWT+oeXZ4Iedw/8OsJI1aPnNKLX/60VvcZb94uasRxCkqlPQ11u1Sa2hHvB80WQENxVyzjns0/PiEByyil21Te6oisk3mNCEMrhouCFO3yEZTHHOCMy9eb/4Tmi8cVf3Lf7P53SY2hX3PSN033As3ETIMLHWumWEO9JXHA2y2SIBlIPpLGG2qvNsCIlIr+B1SWAqRKm2w6Blf7U+zCSBwJrfHG5i8J5Gax/cVonMlon7aHJX/gSvucIncRP93XCqkv7D8IFKFsLiBgHqUpXhE3pYjEcV1dk/JD9zFVCfEaQIVX8Jmfz7IIofcBKQ4OaG+C3xC2veX9CD+iAFXDNaGg9eTVxvkbJRJlW4Nk9Wk13kn696jWppRDe/8pDrYMO9ZyxZ98ReKSz9kWKLLyk2zCZgAniCkLJVX3n1M9DYbomyahWiv/KixRIV9hj/oFz87I+HLznbPTjpa+D+bZQnMuRsljTpv90vQUt/pK7jCFnA30B/jtroSF2/m/gpWn1aQs5WeA6ghzF8SdqWI20fghdSeDOCSCmLgTkfaGgGDmw7nHFkRzGtag57IHS2na06I+gzEphXo1w/Zx2BM/jKL2nZoFjHggtFQjYi8nSVRSXIE58RPbBObXk7uuIL9+rs/5Zo7suJInEUxgsiZZAWS25iBtpEiZeBgDtghEoAE0sjcayNq85M4tbu/LF5h51335PsGzQ09O875+vUS89lkWMyNOFoip2PuyWyMP/iU2XIZdfCCJNDjebDoBLQdpy7QQZC7s9c0wjHJervQNDu2jWzBW5MSAJMr7bP+Iv92BkS/GGgzjEn7MF1IRKFwwzbjbS4/slGOmhx9cZrFu7HSEefojNv3r0UaKfKOWzXsq1zEugbzlMDFsacRJJI/iJlK3vtkZ+PLZIVMFlKA32wbq2Kd5T0uCLZ1CPkAfCdzkz2EYscjDcZq2AWfziN2covN4kXE1lQXPPLTNM1xx3tbiepcO/t3SWm4w87qfh99SL0ZnY+LKFPLPeXVM2mIIoVWt+9Nk0I7nY4O79iGYqxZ8RVz289an6NVdJWnSKZvJQCAuHNiVaDxPAFoH392t9wot5t0/qmU95eEWNbU2udUW5sN9JVqcYlvAIfLeYC33oUzzxZgSktsv21mA7Uly1FA5VnoJFh6N244Wmv3YJGFv/TCPryaw+ZORlpZjQdq/2DYXr3EZskfed0G61P09ipTKmlTQ1067Rg5+PAk5FlQ9e0SWbGf2B/08kqymOTMVOznsALHHNFH4LFRKl2F/NOiYFl9khNHnSu9Ak5sq26Ynl/i2fdTle29Y1ugqmR5Yj4YT9pvslFyYCbw0mNFr5rVQm1LvkG27QMq9ph3t8fmn6r6SQ4oSbr5tz+J1kIawGzDxb6VYOvvWhobDTXfBeNv3b4aNm5XUinsCGqG2q/45m3+LoCOsddFceYhRx1Tsss9PLdPfJdErFMjYd3gddjiP0+XQjcRadZP6bwNLySvunFf20Czy6JqdEW2a96KxdYdOryBv1BjbuUq2yCHeh+6sk7fGmmPi50pe/1l5TyPe5oHW9oPnhPswLyf2TFDdCyYlhwBCstv5C1HwlW7xWoGT9XZt4qVj5WryLPLLD6h/5cMLEjWzgCeAIKNsLak92aBqBsHl4AJwl2N4jfvbSkBExGimv0nFvv09uDScQbjx+w4kPQjgjlW+g9ws9VEJvI2k8N6XxVu0uIwovgTFdunG24gBtaDi+y1YLQwZ8mwbip5fVlO3k0n0AEr/ETbtu8Vjkm+nNSiEb7X/3fMjBL5A8PdgG+/FnbexbFFExmEfetXAnisEKy5z44WVPpQZjSy/jzeGn4yDRsFGqhh87QPaDBWhlo37IFbe/C0xynS91d2tP/AJoJS0sVF6iwAAAAAElFTkSuQmCC");
}

#menu::after {
  display: block;
  content: '';
  padding-top: 80px;
}

#logo {
  position: fixed;
  bottom: 10px;
  right: 10px;
  background: rgba(255,255,255,.1);
  font-size: 11px;
  display: block;
  width: 20px;
  height: 20px;
  line-height: 20px;
  text-align: center;
  -webkit-border-radius: 20px;
  -moz-border-radius: 20px;
  border-radius: 20px;
  -webkit-box-shadow: 0 0 3px rgba(0,0,0,.2);
  -moz-box-shadow: 0 0 3px rgba(0,0,0,.2);
  box-shadow: 0 0 3px rgba(0,0,0,.2);
  color: inherit;
}

#menu li a {
  display: block;
  color: white;
  padding: 0 35px 0 25px;
  -webkit-transition: background 300ms;
  -moz-transition: background 300ms;
}

#menu li {
  position: relative;
  list-style: none;
}

#menu a:hover,
#menu a.active {
  text-decoration: none;
  background: rgba(255,255,255,.1);
}

#menu li:hover .cov {
  opacity: 1;
}

#menu li .dirname {
  opacity: .60;
  padding-right: 2px;
}

#menu li .basename {
  opacity: 1;
}

#menu .cov {
  background: rgba(0,0,0,.4);
  position: absolute;
  top: 0;
  right: 8px;
  font-size: 9px;
  opacity: .6;
  text-align: left;
  width: 17px;
  -webkit-border-radius: 10px;
  -moz-border-radius: 10px;
  border-radius: 10px;
  padding: 2px 3px;
  text-align: center;
}

#stats:nth-child(2n) {
  display: inline-block;
  margin-top: 15px;
  border: 1px solid #eee;
  padding: 10px;
  -webkit-box-shadow: inset 0 0 2px #eee;
  -moz-box-shadow: inset 0 0 2px #eee;
  box-shadow: inset 0 0 2px #eee;
  -webkit-border-radius: 5px;
  -moz-border-radius: 5px;
  border-radius: 5px;
}

#stats div {
  float: left;
  padding: 0 5px;
}

#stats::after {
  display: block;
  content: '';
  clear: both;
}

#stats .sloc::after {
  content: ' SLOC';
  color: #b6b6b6;
}

#stats .percentage::after {
  content: ' coverage';
  color: #b6b6b6;
}

#stats .hits,
#stats .misses {
  display: none;
}

.high {
  color: #00d4b4;
}
.medium {
  color: #e87d0d;
}
.low {
  color: #d4081a;
}
.terrible {
  color: #d4081a;
  font-weight: bold;
}

table {
  width: 80%;
  margin-top: 10px;
  border-collapse: collapse;
  border: 1px solid #cbcbcb;
  color: #363636;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  border-radius: 3px;
}

table thead {
  display: none;
}

table td.line,
table td.hits {
  width: 20px;
  background: #eaeaea;
  text-align: center;
  font-size: 11px;
  padding: 0 10px;
  color: #949494;
}

table td.hits {
  width: 10px;
  padding: 2px 5px;
  color: rgba(0,0,0,.2);
  background: #f0f0f0;
}

tr.miss td.line,
tr.miss td.hits {
  background: #e6c3c7;
}

tr.miss td {
  background: #f8d5d8;
}

td.source {
  padding-left: 15px;
  line-height: 15px;
  white-space: pre;
  font: 12px monaco, monospace;
}

code .comment { color: #ddd }
code .init { color: #2F6FAD }
code .string { color: #5890AD }
code .keyword { color: #8A6343 }
code .number { color: #2F6FAD }
</style>
</head><body><div id="coverage"><h1 id="overview">Coverage</h1><div id="menu"><li><a href="#overview">overview</a></li><li><span class="cov high">100</span><a href="#/home/lemelon/EIPmaster/newapp/backend/authentification/auth.js"><span class="dirname">/home/lemelon/EIPmaster/newapp/backend/authentification/</span><span class="basename">auth.js</span></a></li><li><span class="cov high">100</span><a href="#/home/lemelon/EIPmaster/newapp/backend/authentification/passportStrategy.js"><span class="dirname">/home/lemelon/EIPmaster/newapp/backend/authentification/</span><span class="basename">passportStrategy.js</span></a></li><li><span class="cov terrible">10</span><a href="#/home/lemelon/EIPmaster/newapp/backend/chatServer/chatServer.js"><span class="dirname">/home/lemelon/EIPmaster/newapp/backend/chatServer/</span><span class="basename">chatServer.js</span></a></li><li><span class="cov low">30</span><a href="#/home/lemelon/EIPmaster/newapp/backend/chatServer/room.js"><span class="dirname">/home/lemelon/EIPmaster/newapp/backend/chatServer/</span><span class="basename">room.js</span></a></li><li><span class="cov high">83</span><a href="#/home/lemelon/EIPmaster/newapp/backend/config/config.js"><span class="dirname">/home/lemelon/EIPmaster/newapp/backend/config/</span><span class="basename">config.js</span></a></li><li><span class="cov terrible">15</span><a href="#/home/lemelon/EIPmaster/newapp/backend/controllers/actualityCtrl.js"><span class="dirname">/home/lemelon/EIPmaster/newapp/backend/controllers/</span><span class="basename">actualityCtrl.js</span></a></li><li><span class="cov terrible">10</span><a href="#/home/lemelon/EIPmaster/newapp/backend/controllers/announces/announcesCommentsCtrl.js"><span class="dirname">/home/lemelon/EIPmaster/newapp/backend/controllers/announces/</span><span class="basename">announcesCommentsCtrl.js</span></a></li><li><span class="cov terrible">21</span><a href="#/home/lemelon/EIPmaster/newapp/backend/controllers/announces/announcesCtrl.js"><span class="dirname">/home/lemelon/EIPmaster/newapp/backend/controllers/announces/</span><span class="basename">announcesCtrl.js</span></a></li><li><span class="cov terrible">5</span><a href="#/home/lemelon/EIPmaster/newapp/backend/controllers/friendsCtrl.js"><span class="dirname">/home/lemelon/EIPmaster/newapp/backend/controllers/</span><span class="basename">friendsCtrl.js</span></a></li><li><span class="cov terrible">11</span><a href="#/home/lemelon/EIPmaster/newapp/backend/controllers/imagesCtrl.js"><span class="dirname">/home/lemelon/EIPmaster/newapp/backend/controllers/</span><span class="basename">imagesCtrl.js</span></a></li><li><span class="cov medium">65</span><a href="#/home/lemelon/EIPmaster/newapp/backend/controllers/session/sessionCtrl.js"><span class="dirname">/home/lemelon/EIPmaster/newapp/backend/controllers/session/</span><span class="basename">sessionCtrl.js</span></a></li><li><span class="cov low">42</span><a href="#/home/lemelon/EIPmaster/newapp/backend/controllers/users/findCtrl.js"><span class="dirname">/home/lemelon/EIPmaster/newapp/backend/controllers/users/</span><span class="basename">findCtrl.js</span></a></li><li><span class="cov medium">58</span><a href="#/home/lemelon/EIPmaster/newapp/backend/models/schemas/actualitySchemas/ActualityModel.js"><span class="dirname">/home/lemelon/EIPmaster/newapp/backend/models/schemas/actualitySchemas/</span><span class="basename">ActualityModel.js</span></a></li><li><span class="cov medium">50</span><a href="#/home/lemelon/EIPmaster/newapp/backend/models/schemas/actualitySchemas/StatusModel.js"><span class="dirname">/home/lemelon/EIPmaster/newapp/backend/models/schemas/actualitySchemas/</span><span class="basename">StatusModel.js</span></a></li><li><span class="cov low">47</span><a href="#/home/lemelon/EIPmaster/newapp/backend/models/schemas/announceSchemas/AnnounceCommentModel.js"><span class="dirname">/home/lemelon/EIPmaster/newapp/backend/models/schemas/announceSchemas/</span><span class="basename">AnnounceCommentModel.js</span></a></li><li><span class="cov high">79</span><a href="#/home/lemelon/EIPmaster/newapp/backend/models/schemas/announceSchemas/AnnounceModel.js"><span class="dirname">/home/lemelon/EIPmaster/newapp/backend/models/schemas/announceSchemas/</span><span class="basename">AnnounceModel.js</span></a></li><li><span class="cov high">100</span><a href="#/home/lemelon/EIPmaster/newapp/backend/models/schemas/announceSchemas/CategoryModel.js"><span class="dirname">/home/lemelon/EIPmaster/newapp/backend/models/schemas/announceSchemas/</span><span class="basename">CategoryModel.js</span></a></li><li><span class="cov medium">59</span><a href="#/home/lemelon/EIPmaster/newapp/backend/models/schemas/chatSchemas/MessageModel.js"><span class="dirname">/home/lemelon/EIPmaster/newapp/backend/models/schemas/chatSchemas/</span><span class="basename">MessageModel.js</span></a></li><li><span class="cov low">41</span><a href="#/home/lemelon/EIPmaster/newapp/backend/models/schemas/chatSchemas/RoomModel.js"><span class="dirname">/home/lemelon/EIPmaster/newapp/backend/models/schemas/chatSchemas/</span><span class="basename">RoomModel.js</span></a></li><li><span class="cov low">26</span><a href="#/home/lemelon/EIPmaster/newapp/backend/models/schemas/notificationSchemas/FriendModel.js"><span class="dirname">/home/lemelon/EIPmaster/newapp/backend/models/schemas/notificationSchemas/</span><span class="basename">FriendModel.js</span></a></li><li><span class="cov low">30</span><a href="#/home/lemelon/EIPmaster/newapp/backend/models/schemas/notificationSchemas/NotificationModel.js"><span class="dirname">/home/lemelon/EIPmaster/newapp/backend/models/schemas/notificationSchemas/</span><span class="basename">NotificationModel.js</span></a></li><li><span class="cov medium">58</span><a href="#/home/lemelon/EIPmaster/newapp/backend/models/schemas/userSchemas/ImageModel.js"><span class="dirname">/home/lemelon/EIPmaster/newapp/backend/models/schemas/userSchemas/</span><span class="basename">ImageModel.js</span></a></li><li><span class="cov medium">66</span><a href="#/home/lemelon/EIPmaster/newapp/backend/models/schemas/userSchemas/TokenModel.js"><span class="dirname">/home/lemelon/EIPmaster/newapp/backend/models/schemas/userSchemas/</span><span class="basename">TokenModel.js</span></a></li><li><span class="cov medium">55</span><a href="#/home/lemelon/EIPmaster/newapp/backend/models/schemas/userSchemas/UserModel.js"><span class="dirname">/home/lemelon/EIPmaster/newapp/backend/models/schemas/userSchemas/</span><span class="basename">UserModel.js</span></a></li><li><span class="cov high">100</span><a href="#/home/lemelon/EIPmaster/newapp/backend/routes/actualityRoutes.js"><span class="dirname">/home/lemelon/EIPmaster/newapp/backend/routes/</span><span class="basename">actualityRoutes.js</span></a></li><li><span class="cov high">100</span><a href="#/home/lemelon/EIPmaster/newapp/backend/routes/announces/announceRoutes.js"><span class="dirname">/home/lemelon/EIPmaster/newapp/backend/routes/announces/</span><span class="basename">announceRoutes.js</span></a></li><li><span class="cov high">100</span><a href="#/home/lemelon/EIPmaster/newapp/backend/routes/announces/announcesCommentsRoutes.js"><span class="dirname">/home/lemelon/EIPmaster/newapp/backend/routes/announces/</span><span class="basename">announcesCommentsRoutes.js</span></a></li><li><span class="cov high">100</span><a href="#/home/lemelon/EIPmaster/newapp/backend/routes/imageRoutes.js"><span class="dirname">/home/lemelon/EIPmaster/newapp/backend/routes/</span><span class="basename">imageRoutes.js</span></a></li><li><span class="cov high">90</span><a href="#/home/lemelon/EIPmaster/newapp/backend/routes/routes.js"><span class="dirname">/home/lemelon/EIPmaster/newapp/backend/routes/</span><span class="basename">routes.js</span></a></li><li><span class="cov high">100</span><a href="#/home/lemelon/EIPmaster/newapp/backend/routes/sessions/sessionRoutes.js"><span class="dirname">/home/lemelon/EIPmaster/newapp/backend/routes/sessions/</span><span class="basename">sessionRoutes.js</span></a></li><li><span class="cov high">100</span><a href="#/home/lemelon/EIPmaster/newapp/backend/routes/sockets/friendsRoutes.js"><span class="dirname">/home/lemelon/EIPmaster/newapp/backend/routes/sockets/</span><span class="basename">friendsRoutes.js</span></a></li><li><span class="cov high">100</span><a href="#/home/lemelon/EIPmaster/newapp/backend/routes/sockets/messageRoutes.js"><span class="dirname">/home/lemelon/EIPmaster/newapp/backend/routes/sockets/</span><span class="basename">messageRoutes.js</span></a></li><li><span class="cov high">100</span><a href="#/home/lemelon/EIPmaster/newapp/backend/routes/sockets/notificationRoutes.js"><span class="dirname">/home/lemelon/EIPmaster/newapp/backend/routes/sockets/</span><span class="basename">notificationRoutes.js</span></a></li><li><span class="cov high">100</span><a href="#/home/lemelon/EIPmaster/newapp/backend/routes/sockets/roomsRoutes.js"><span class="dirname">/home/lemelon/EIPmaster/newapp/backend/routes/sockets/</span><span class="basename">roomsRoutes.js</span></a></li><li><span class="cov high">100</span><a href="#/home/lemelon/EIPmaster/newapp/backend/routes/statusRoutes.js"><span class="dirname">/home/lemelon/EIPmaster/newapp/backend/routes/</span><span class="basename">statusRoutes.js</span></a></li><li><span class="cov high">100</span><a href="#/home/lemelon/EIPmaster/newapp/backend/routes/users/findRoutes.js"><span class="dirname">/home/lemelon/EIPmaster/newapp/backend/routes/users/</span><span class="basename">findRoutes.js</span></a></li><a id="logo" href="http://mochajs.org/">m</a></div><div id="stats" class="low"><div class="percentage">40%</div><div class="sloc">1023</div><div class="hits">414</div><div class="misses">609</div></div><div id="files"><div class="file"><h2 id="/home/lemelon/EIPmaster/newapp/backend/authentification/auth.js">/home/lemelon/EIPmaster/newapp/backend/authentification/auth.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">16</div><div class="hits">16</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">// MODULE DEPENDENCIES //////////////////////////////////////////</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">/////////////////////////////////////////////////////////////////</td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">var mongoose = require('mongoose');</td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">var User     = mongoose.model('User');</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">/////////////////////////////////////////////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">// AUTH TOKEN Route middleware to ensure user is authenticated //</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">////////////////////////////////////////////////////////////////////////////////////////////////////////</td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">exports.ensureAuthenticated = function ensureAuthenticated(req, res, next) {</td></tr><tr class="hit"><td class="line">11</td><td class="hits">3</td><td class="source">  'use strict';</td></tr><tr class="hit"><td class="line">12</td><td class="hits">3</td><td class="source">  console.log('_________________Ensure authentification__________________');</td></tr><tr class="hit"><td class="line">13</td><td class="hits">3</td><td class="source">  var incomingToken = req.headers['auth-token'];</td></tr><tr class="hit"><td class="line">14</td><td class="hits">3</td><td class="source">  console.log(incomingToken);</td></tr><tr class="hit"><td class="line">15</td><td class="hits">3</td><td class="source">  if (incomingToken) {</td></tr><tr class="hit"><td class="line">16</td><td class="hits">2</td><td class="source">    User.decode(incomingToken, function(err, user) {</td></tr><tr class="hit"><td class="line">17</td><td class="hits">2</td><td class="source">      if (err) {</td></tr><tr class="hit"><td class="line">18</td><td class="hits">1</td><td class="source">        console.log('ERROR');</td></tr><tr class="hit"><td class="line">19</td><td class="hits">1</td><td class="source">        console.log(err);</td></tr><tr class="hit"><td class="line">20</td><td class="hits">1</td><td class="source">        return res.status(400).json('Issue finding user');</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="hit"><td class="line">22</td><td class="hits">1</td><td class="source">        req.user = user;</td></tr><tr class="hit"><td class="line">23</td><td class="hits">1</td><td class="source">        next();</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">  } else {</td></tr><tr class="hit"><td class="line">27</td><td class="hits">1</td><td class="source">    res.status(400).json('There is no token');</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/home/lemelon/EIPmaster/newapp/backend/authentification/passportStrategy.js">/home/lemelon/EIPmaster/newapp/backend/authentification/passportStrategy.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">7</div><div class="hits">7</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">// MODULE DEPENDENCIES //////////////////////////////////////////</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">/////////////////////////////////////////////////////////////////</td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">var passport = require('passport');</td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">var mongoose = require('mongoose');</td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">var User     = mongoose.model('User');</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">/////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">// AUTHENTIFICATION STRATEGY ////////////////////////////////////</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">/////////////////////////////////////////////////////////////////</td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">module.exports = function(app) {</td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">  'use strict';</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">  ///////////////////////////////////////////////////////////////</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">  // USE PASSPORT SESSION ///////////////////////////////////////</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">  ///////////////////////////////////////////////////////////////</td></tr><tr class="hit"><td class="line">16</td><td class="hits">1</td><td class="source">  app.use(passport.initialize());</td></tr><tr class="hit"><td class="line">17</td><td class="hits">1</td><td class="source">  passport.use(User.createStrategy());</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/home/lemelon/EIPmaster/newapp/backend/chatServer/chatServer.js">/home/lemelon/EIPmaster/newapp/backend/chatServer/chatServer.js</h2><div id="stats" class="terrible"><div class="percentage">10%</div><div class="sloc">74</div><div class="hits">8</div><div class="misses">66</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">// HOOK SOCKET.IO INTO EXPRESS //////////////////////////////////</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">/////////////////////////////////////////////////////////////////</td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">var rooms   = {};</td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">var people  = {};</td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">var _       = require('underscore')._;</td></tr><tr class="hit"><td class="line">7</td><td class="hits">1</td><td class="source">var sockets = [];</td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">var Room    = require('./room');</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">module.exports = function(server) {</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">  var io = require('socket.io').listen(server);</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">15</td><td class="hits">1</td><td class="source">  io.sockets.on('connection', function(socket) {</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">17</td><td class="hits">0</td><td class="source">    totalPeopleOnline = _.size(people);</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">19</td><td class="hits">0</td><td class="source">    io.sockets.emit('updatePeopleCount', {count: totalPeopleOnline});</td></tr><tr class="miss"><td class="line">20</td><td class="hits">0</td><td class="source">    io.sockets.emit('updateUserDetail', people);</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="source">    totalRooms = _.size(rooms);</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">24</td><td class="hits">0</td><td class="source">    io.sockets.emit('updateRoomsCount', {count: totalRooms});</td></tr><tr class="miss"><td class="line">25</td><td class="hits">0</td><td class="source">    socket.emit('connectingToSocketServer', {</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">      status: 'online',</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">29</td><td class="hits">0</td><td class="source">    socket.on('sendFriendRequest', function(user) {</td></tr><tr class="miss"><td class="line">30</td><td class="hits">0</td><td class="source">      io.sockets.emit('receiveFriendRequest', user);</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="source">    socket.on('sendLike', function(user) {</td></tr><tr class="miss"><td class="line">34</td><td class="hits">0</td><td class="source">      console.log('__________SEND LIKE___________');</td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="source">      io.sockets.emit('receiveLike', user);</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">38</td><td class="hits">0</td><td class="source">    socket.on('sendAcceptFriendRequest', function(user) {</td></tr><tr class="miss"><td class="line">39</td><td class="hits">0</td><td class="source">      console.log('receiveAcceptFriendRequest');</td></tr><tr class="miss"><td class="line">40</td><td class="hits">0</td><td class="source">      io.sockets.emit('receiveAcceptFriendRequest', user);</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">43</td><td class="hits">0</td><td class="source">    socket.on('sendMessage', function(data) {</td></tr><tr class="miss"><td class="line">44</td><td class="hits">0</td><td class="source">      console.log('SEND MESSAGE');</td></tr><tr class="miss"><td class="line">45</td><td class="hits">0</td><td class="source">      console.log(socket.room);</td></tr><tr class="miss"><td class="line">46</td><td class="hits">0</td><td class="source">      io.sockets.in(socket.room).emit('sendChatMessage', data);</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="source">    socket.on('typing', function(data) {</td></tr><tr class="miss"><td class="line">50</td><td class="hits">0</td><td class="source">      console.log(data);</td></tr><tr class="miss"><td class="line">51</td><td class="hits">0</td><td class="source">      console.log(socket.room);</td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="source">      io.sockets.in(socket.room).emit('isTyping',</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">        {isTyping: data.isTyping, person: data.user});</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">56</td><td class="hits">0</td><td class="source">    socket.on('disconnect', function() {</td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="source">      console.log('disconnect');</td></tr><tr class="miss"><td class="line">58</td><td class="hits">0</td><td class="source">      if (typeof people[socket.id] !== 'undefined') { //this handles the refresh of the name screen</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">        // purgatory.purge(socket, 'disconnect');</td></tr><tr class="miss"><td class="line">60</td><td class="hits">0</td><td class="source">        console.log('disconnect');</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">64</td><td class="hits">0</td><td class="source">    socket.on('joinSocketServer', function(data) {</td></tr><tr class="miss"><td class="line">65</td><td class="hits">0</td><td class="source">      var exists = false;</td></tr><tr class="miss"><td class="line">66</td><td class="hits">0</td><td class="source">      _.find(people, function(k, v) {</td></tr><tr class="miss"><td class="line">67</td><td class="hits">0</td><td class="source">        if (k.name.toLowerCase() === data.name.toLowerCase()) {</td></tr><tr class="miss"><td class="line">68</td><td class="hits">0</td><td class="source">          exists = true;</td></tr><tr class="miss"><td class="line">69</td><td class="hits">0</td><td class="source">          return exists;</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">73</td><td class="hits">0</td><td class="source">      if (!exists) {</td></tr><tr class="miss"><td class="line">74</td><td class="hits">0</td><td class="source">        people[socket.id]        = {name: data.name};</td></tr><tr class="miss"><td class="line">75</td><td class="hits">0</td><td class="source">        people[socket.id].inroom = null;</td></tr><tr class="miss"><td class="line">76</td><td class="hits">0</td><td class="source">        people[socket.id].owns   = null;</td></tr><tr class="miss"><td class="line">77</td><td class="hits">0</td><td class="source">        totalPeopleOnline        = _.size(people);</td></tr><tr class="miss"><td class="line">78</td><td class="hits">0</td><td class="source">        totalRooms               = _.size(rooms);</td></tr><tr class="miss"><td class="line">79</td><td class="hits">0</td><td class="source">        io.sockets.emit('updateRoomsCount', {count: totalRooms});</td></tr><tr class="miss"><td class="line">80</td><td class="hits">0</td><td class="source">        io.sockets.emit('updateUserDetail', people);</td></tr><tr class="miss"><td class="line">81</td><td class="hits">0</td><td class="source">        io.sockets.emit('updatePeopleCount', {count: totalPeopleOnline});</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">83</td><td class="hits">0</td><td class="source">        io.sockets.emit('joinedSuccessfully');</td></tr><tr class="miss"><td class="line">84</td><td class="hits">0</td><td class="source">        io.sockets.emit('updateUserDetail', people);</td></tr><tr class="miss"><td class="line">85</td><td class="hits">0</td><td class="source">        sockets.push(socket);</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">89</td><td class="hits">0</td><td class="source">    socket.on('joinRoom', function(roomId, roomName) {</td></tr><tr class="miss"><td class="line">90</td><td class="hits">0</td><td class="source">      console.log('________________JOIN ROOM_______________');</td></tr><tr class="miss"><td class="line">91</td><td class="hits">0</td><td class="source">      var room = rooms[roomId];</td></tr><tr class="miss"><td class="line">92</td><td class="hits">0</td><td class="source">      socket.room = roomName;</td></tr><tr class="miss"><td class="line">93</td><td class="hits">0</td><td class="source">      socket.join(socket.room);</td></tr><tr class="miss"><td class="line">94</td><td class="hits">0</td><td class="source">      io.sockets.emit('updateUserDetail', people);</td></tr><tr class="miss"><td class="line">95</td><td class="hits">0</td><td class="source">      io.sockets.emit('sendUserDetail', people[socket.id]);</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">98</td><td class="hits">0</td><td class="source">    socket.on('createRoom', function(roomId, roomName) {</td></tr><tr class="miss"><td class="line">99</td><td class="hits">0</td><td class="source">      console.log('NEW ROOM_________ CRETA ROOOM');</td></tr><tr class="miss"><td class="line">100</td><td class="hits">0</td><td class="source">      console.log('createRoom');</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">102</td><td class="hits">0</td><td class="source">      var room = new Room(roomName, roomID, socket.id);</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">104</td><td class="hits">0</td><td class="source">      people[socket.id].roomname = roomName;</td></tr><tr class="miss"><td class="line">105</td><td class="hits">0</td><td class="source">      room.addPerson(socket.id);</td></tr><tr class="miss"><td class="line">106</td><td class="hits">0</td><td class="source">      rooms[uniqueRoomID] = room;</td></tr><tr class="miss"><td class="line">107</td><td class="hits">0</td><td class="source">      socket.room         = roomName;</td></tr><tr class="miss"><td class="line">108</td><td class="hits">0</td><td class="source">      socket.join(socket.room);</td></tr><tr class="miss"><td class="line">109</td><td class="hits">0</td><td class="source">      totalRooms = _.size(rooms);</td></tr><tr class="miss"><td class="line">110</td><td class="hits">0</td><td class="source">      io.sockets.emit('updateRoomsCount', {count: totalRooms});</td></tr><tr class="miss"><td class="line">111</td><td class="hits">0</td><td class="source">      io.sockets.emit('updateRoomsCount', {count: totalRooms});</td></tr><tr class="miss"><td class="line">112</td><td class="hits">0</td><td class="source">      io.sockets.emit('listAvailableChatRooms', rooms);</td></tr><tr class="miss"><td class="line">113</td><td class="hits">0</td><td class="source">      io.sockets.emit('updateUserDetail', people);</td></tr><tr class="miss"><td class="line">114</td><td class="hits">0</td><td class="source">      socket.emit('sendUserDetail', people[socket.id]);</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/home/lemelon/EIPmaster/newapp/backend/chatServer/room.js">/home/lemelon/EIPmaster/newapp/backend/chatServer/room.js</h2><div id="stats" class="low"><div class="percentage">30%</div><div class="sloc">10</div><div class="hits">3</div><div class="misses">7</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">function Room(name, id, owner) {</td></tr><tr class="miss"><td class="line">2</td><td class="hits">0</td><td class="source">  this.name   = name;</td></tr><tr class="miss"><td class="line">3</td><td class="hits">0</td><td class="source">  this.id     = id;</td></tr><tr class="miss"><td class="line">4</td><td class="hits">0</td><td class="source">  this.owner  = owner;</td></tr><tr class="miss"><td class="line">5</td><td class="hits">0</td><td class="source">  this.people = [];</td></tr><tr class="miss"><td class="line">6</td><td class="hits">0</td><td class="source">  this.status = 'available';</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">9</td><td class="hits">1</td><td class="source">Room.prototype.addPerson = function(personID) {</td></tr><tr class="miss"><td class="line">10</td><td class="hits">0</td><td class="source">  if (this.status === 'available') {</td></tr><tr class="miss"><td class="line">11</td><td class="hits">0</td><td class="source">    this.people.push(personID);</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">15</td><td class="hits">1</td><td class="source">module.exports = Room;</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/home/lemelon/EIPmaster/newapp/backend/config/config.js">/home/lemelon/EIPmaster/newapp/backend/config/config.js</h2><div id="stats" class="high"><div class="percentage">83%</div><div class="sloc">24</div><div class="hits">20</div><div class="misses">4</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">// MODULE DEPENDENCIES //////////////////////////////////////////</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">/////////////////////////////////////////////////////////////////</td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">var path           = require('path');</td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">var morgan         = require('morgan');</td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">var methodOverride = require('method-override');</td></tr><tr class="hit"><td class="line">7</td><td class="hits">1</td><td class="source">var expressSession = require('express-session');</td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">var mongoStore     = require('connect-mongo')(expressSession);</td></tr><tr class="hit"><td class="line">9</td><td class="hits">1</td><td class="source">var compress       = require('compression');</td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">var bodyParser     = require('body-parser');</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">/////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">// CONFIGURATION ////////////////////////////////////////////////</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">/////////////////////////////////////////////////////////////////</td></tr><tr class="hit"><td class="line">15</td><td class="hits">1</td><td class="source">exports = module.exports = function(app, express, config) {</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">17</td><td class="hits">1</td><td class="source">  console.log('///////////CONFIGURATION//////////////////');</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">19</td><td class="hits">1</td><td class="source">  if (process.env.NODE_ENV === 'production') {</td></tr><tr class="miss"><td class="line">20</td><td class="hits">0</td><td class="source">    console.log('///////////production//////////////////');</td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="source">    app.set('views', __dirname + '/../../dist/views');</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">  } else {</td></tr><tr class="hit"><td class="line">23</td><td class="hits">1</td><td class="source">    app.set('views', __dirname + '/../../frontend/views');</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">26</td><td class="hits">1</td><td class="source">  app.engine('html', require('ejs').renderFile);</td></tr><tr class="hit"><td class="line">27</td><td class="hits">1</td><td class="source">  app.set('view engine', 'html');</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">29</td><td class="hits">1</td><td class="source">  app.use(compress());</td></tr><tr class="hit"><td class="line">30</td><td class="hits">1</td><td class="source">  app.use(morgan('dev'));</td></tr><tr class="hit"><td class="line">31</td><td class="hits">1</td><td class="source">  app.use(bodyParser.urlencoded({</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">    extended: true</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">  }));</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">35</td><td class="hits">1</td><td class="source">  app.use(bodyParser.json());</td></tr><tr class="hit"><td class="line">36</td><td class="hits">1</td><td class="source">  app.use(methodOverride());</td></tr><tr class="hit"><td class="line">37</td><td class="hits">1</td><td class="source">  if (process.env.NODE_ENV === 'production') {</td></tr><tr class="miss"><td class="line">38</td><td class="hits">0</td><td class="source">    console.log('inside production');</td></tr><tr class="miss"><td class="line">39</td><td class="hits">0</td><td class="source">    app.use(express.static(path.join(__dirname, '/../../dist')));</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">  } else {</td></tr><tr class="hit"><td class="line">41</td><td class="hits">1</td><td class="source">    app.use(express.static(path.join(__dirname, '/../../frontend')));</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/home/lemelon/EIPmaster/newapp/backend/controllers/actualityCtrl.js">/home/lemelon/EIPmaster/newapp/backend/controllers/actualityCtrl.js</h2><div id="stats" class="terrible"><div class="percentage">15%</div><div class="sloc">26</div><div class="hits">4</div><div class="misses">22</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">// MODULE DEPENDENCIES //////////////////////////////////////////</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">/////////////////////////////////////////////////////////////////</td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">var mongoose  = require('mongoose');</td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">var Actuality = mongoose.model('Actuality');</td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">var User      = mongoose.model('User');</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">module.exports = {</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">  // GET STATUS ///////////////////////////////////////////////////</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">  getActualities: function(req, res) {</td></tr><tr class="miss"><td class="line">14</td><td class="hits">0</td><td class="source">    console.log('_____GET /api/actuality');</td></tr><tr class="miss"><td class="line">15</td><td class="hits">0</td><td class="source">    Actuality.find()</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">    .sort('-date')</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">    .exec(function(err, actualities) {</td></tr><tr class="miss"><td class="line">18</td><td class="hits">0</td><td class="source">      return res.status(err ? 501 : 200).json(err ? err : actualities);</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">  // CREATE COMMENT ///////////////////////////////////////////////</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">  addActuality: function(req, res) {</td></tr><tr class="miss"><td class="line">26</td><td class="hits">0</td><td class="source">    console.log('_______ADD Actuality_____');</td></tr><tr class="miss"><td class="line">27</td><td class="hits">0</td><td class="source">    var actuality     = new Actuality();</td></tr><tr class="miss"><td class="line">28</td><td class="hits">0</td><td class="source">    actuality.content = req.body.content;</td></tr><tr class="miss"><td class="line">29</td><td class="hits">0</td><td class="source">    actuality.status  = req.body.status;</td></tr><tr class="miss"><td class="line">30</td><td class="hits">0</td><td class="source">    actuality.creator = req.user._id;</td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="source">    actuality.save(function(err) {</td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="source">      res.status(err ? 400 : 200).json(err ? err : null);</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">  // DELETE ACTUALITY /////////////////////////////////////////////</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">  removeActuality: function(req, res) {</td></tr><tr class="miss"><td class="line">40</td><td class="hits">0</td><td class="source">    console.log('______DELETE /api/actuality___');</td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="source">    function findOneActuality(findOneActualityCallback) {</td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="source">      Actuality.findOne({</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">        _id: req.params.id</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">      }, function(err, result) {</td></tr><tr class="miss"><td class="line">45</td><td class="hits">0</td><td class="source">        findOneActualityCallback(err ? err : null, result);</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="source">    function removeActuality(result, removeActualityCallback) {</td></tr><tr class="miss"><td class="line">50</td><td class="hits">0</td><td class="source">      if (req.user._id == result.creator) {</td></tr><tr class="miss"><td class="line">51</td><td class="hits">0</td><td class="source">        Actuality.remove(result, function(err) {</td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="source">          removeActualityCallback(err ? err : null);</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="miss"><td class="line">55</td><td class="hits">0</td><td class="source">        removeActualityCallback('error in remove actuality');</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">    // Faire une promise</td></tr><tr class="miss"><td class="line">60</td><td class="hits">0</td><td class="source">    async.waterfall([findOneActuality, removeActuality], function(error) {</td></tr><tr class="miss"><td class="line">61</td><td class="hits">0</td><td class="source">      console.log(error ? error : null);</td></tr><tr class="miss"><td class="line">62</td><td class="hits">0</td><td class="source">      res.status(error ? 400 : 200).json(error ? error : null);</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/home/lemelon/EIPmaster/newapp/backend/controllers/announces/announcesCommentsCtrl.js">/home/lemelon/EIPmaster/newapp/backend/controllers/announces/announcesCommentsCtrl.js</h2><div id="stats" class="terrible"><div class="percentage">10%</div><div class="sloc">57</div><div class="hits">6</div><div class="misses">51</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">// MODULE DEPENDENCIES //////////////////////////////////////////</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">/////////////////////////////////////////////////////////////////</td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">var mongoose = require('mongoose');</td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">var Comment  = mongoose.model('AnnounceComment');</td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">var Announce = mongoose.model('Announce');</td></tr><tr class="hit"><td class="line">7</td><td class="hits">1</td><td class="source">var moment   = require('moment');</td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">var async    = require('async');</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">module.exports = {</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">  // CREATE COMMENT ///////////////////////////////////////////////</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">  addComment: function(req, res) {</td></tr><tr class="miss"><td class="line">16</td><td class="hits">0</td><td class="source">    console.log('_______ADD COMMENT_____');</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">18</td><td class="hits">0</td><td class="source">    function findOneAnnounce(findOneAnnounceCallback) {</td></tr><tr class="miss"><td class="line">19</td><td class="hits">0</td><td class="source">      Announce.findOne({</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">          _id: req.params.announceId</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">      }, function(error, result) {</td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="source">        findOneAnnounceCallback(error ? error : null, result);</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">26</td><td class="hits">0</td><td class="source">    function saveComment(announce, saveCommentCallback) {</td></tr><tr class="miss"><td class="line">27</td><td class="hits">0</td><td class="source">      var comment      = new Comment();</td></tr><tr class="miss"><td class="line">28</td><td class="hits">0</td><td class="source">      comment.content  = req.body.announceComment;</td></tr><tr class="miss"><td class="line">29</td><td class="hits">0</td><td class="source">      comment.creator  = req.user._id;</td></tr><tr class="miss"><td class="line">30</td><td class="hits">0</td><td class="source">      comment.announce = announce;</td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="source">      comment.save(function(error, comments) {</td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="source">        saveCommentCallback(error ? error : null);</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">    // Faire une promise</td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="source">    async.waterfall([findOneAnnounce, saveComment], function(error) {</td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="source">      console.log(error);</td></tr><tr class="miss"><td class="line">38</td><td class="hits">0</td><td class="source">      res.status(error ? 400 : 200).json(error);</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">  // DELETE COMMENT ///////////////////////////////////////////////</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">  removeComment: function(req, res) {</td></tr><tr class="miss"><td class="line">46</td><td class="hits">0</td><td class="source">    console.log('______DELETE /api/announceComment___');</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">48</td><td class="hits">0</td><td class="source">    function checkRemove(announce) {</td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="source">      if (announce.creator &amp;&amp; req.user._id.equals(announce.creator._id) ||</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">              req.user._id === announce.creator._id) {</td></tr><tr class="miss"><td class="line">51</td><td class="hits">0</td><td class="source">        console.log('true');</td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="source">        return true;</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="miss"><td class="line">54</td><td class="hits">0</td><td class="source">        console.log('false');</td></tr><tr class="miss"><td class="line">55</td><td class="hits">0</td><td class="source">        return false;</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">59</td><td class="hits">0</td><td class="source">    function findAnnounce(findAnnounceCallback) {</td></tr><tr class="miss"><td class="line">60</td><td class="hits">0</td><td class="source">      console.log('find announce');</td></tr><tr class="miss"><td class="line">61</td><td class="hits">0</td><td class="source">      console.log(req.params.id);</td></tr><tr class="miss"><td class="line">62</td><td class="hits">0</td><td class="source">      Comment.findOne({</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">        _id: req.params.id</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">      }, function(error, result) {</td></tr><tr class="miss"><td class="line">65</td><td class="hits">0</td><td class="source">        console.log('test');</td></tr><tr class="miss"><td class="line">66</td><td class="hits">0</td><td class="source">        findAnnounceCallback(error ? error : null, result);</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">70</td><td class="hits">0</td><td class="source">    function removeComment(comment, removeCommentCallback) {</td></tr><tr class="miss"><td class="line">71</td><td class="hits">0</td><td class="source">      console.log('remove comment');</td></tr><tr class="miss"><td class="line">72</td><td class="hits">0</td><td class="source">      if (checkRemove(comment)) {</td></tr><tr class="miss"><td class="line">73</td><td class="hits">0</td><td class="source">        console.log('inside comment');</td></tr><tr class="miss"><td class="line">74</td><td class="hits">0</td><td class="source">        console.log(comment);</td></tr><tr class="miss"><td class="line">75</td><td class="hits">0</td><td class="source">        console.log(comment._id);</td></tr><tr class="miss"><td class="line">76</td><td class="hits">0</td><td class="source">        Comment.remove({'_id': comment._id}, function(error, response) {</td></tr><tr class="miss"><td class="line">77</td><td class="hits">0</td><td class="source">          console.log('___callback___');</td></tr><tr class="miss"><td class="line">78</td><td class="hits">0</td><td class="source">          removeCommentCallback(error ? error : null, comment);</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="miss"><td class="line">81</td><td class="hits">0</td><td class="source">        console.log('___no callback___');</td></tr><tr class="miss"><td class="line">82</td><td class="hits">0</td><td class="source">        removeCommentCallback('you can\'t remove this announce');</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">    // Faire une promise</td></tr><tr class="miss"><td class="line">87</td><td class="hits">0</td><td class="source">    async.waterfall([findAnnounce, removeComment], function(error, response) {</td></tr><tr class="miss"><td class="line">88</td><td class="hits">0</td><td class="source">      res.status(error ? 400 : 200).json(error ? error : response);</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">  // GET COMMENTS /////////////////////////////////////////////////</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">  getComments: function(req, res) {</td></tr><tr class="miss"><td class="line">96</td><td class="hits">0</td><td class="source">    console.log('_____GET /api/announceComment/' + req.params.announceId);</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">98</td><td class="hits">0</td><td class="source">    function getComments(comments) {</td></tr><tr class="miss"><td class="line">99</td><td class="hits">0</td><td class="source">      var retComments = [];</td></tr><tr class="miss"><td class="line">100</td><td class="hits">0</td><td class="source">      comments.forEach(function(item) {</td></tr><tr class="miss"><td class="line">101</td><td class="hits">0</td><td class="source">        if (item.FORMATTED_DATE) {</td></tr><tr class="miss"><td class="line">102</td><td class="hits">0</td><td class="source">          var m               = moment(item.FORMATTED_DATE, 'DD/MM/YYYY, hA:mm');</td></tr><tr class="miss"><td class="line">103</td><td class="hits">0</td><td class="source">          item.FORMATTED_DATE = m.fromNow();</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">105</td><td class="hits">0</td><td class="source">        retComments.push(item);</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">      });</td></tr><tr class="miss"><td class="line">107</td><td class="hits">0</td><td class="source">      return retComments;</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">110</td><td class="hits">0</td><td class="source">    Comment.find({</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">      announce: req.params.announceId</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">    })</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source">    .sort('-date')</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">    .exec(function(error, comments) {</td></tr><tr class="miss"><td class="line">115</td><td class="hits">0</td><td class="source">      res.status(error ? 400 : 200).json(error ? error : getComments(comments));</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/home/lemelon/EIPmaster/newapp/backend/controllers/announces/announcesCtrl.js">/home/lemelon/EIPmaster/newapp/backend/controllers/announces/announcesCtrl.js</h2><div id="stats" class="terrible"><div class="percentage">21%</div><div class="sloc">135</div><div class="hits">29</div><div class="misses">106</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">// MODULE DEPENDENCIES //////////////////////////////////////////</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">/////////////////////////////////////////////////////////////////</td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">var mongoose      = require('mongoose');</td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">var Announce      = mongoose.model('Announce');</td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">var Comment       = mongoose.model('AnnounceComment');</td></tr><tr class="hit"><td class="line">7</td><td class="hits">1</td><td class="source">var async         = require('async');</td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">var moment        = require('moment');</td></tr><tr class="hit"><td class="line">9</td><td class="hits">1</td><td class="source">var async         = require('async');</td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">var elasticsearch = require(&quot;elasticsearch&quot;);</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">if (process.env.NODE_ENV === 'production') {</td></tr><tr class="miss"><td class="line">13</td><td class="hits">0</td><td class="source">  var ES = new elasticsearch.Client({</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">    host: &quot;http://paas:f669a84c8a68e09959b4e8e88df26bf5@dwalin-us-east-1.searchly.com&quot;</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">} else {</td></tr><tr class="hit"><td class="line">17</td><td class="hits">1</td><td class="source">  var ES = new elasticsearch.Client({</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">    host: &quot;localhost:9200&quot;</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">22</td><td class="hits">1</td><td class="source">module.exports = {</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">  // CREATE AN ANNOUNCE ///////////////////////////////////////////</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">  postAnnounce: function(req, res) {</td></tr><tr class="hit"><td class="line">28</td><td class="hits">1</td><td class="source">    console.log('_____________POST /api/announces_____');</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">30</td><td class="hits">1</td><td class="source">    function saveAnnounceMongo(saveAnnounceMongoCallback) {</td></tr><tr class="hit"><td class="line">31</td><td class="hits">1</td><td class="source">      if (req.body.title &amp;&amp; req.body.content) {</td></tr><tr class="hit"><td class="line">32</td><td class="hits">1</td><td class="source">        var announce = new Announce({</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">          title: req.body.title,</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">          content: req.body.content,</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">          type: req.body.type,</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">          price: req.body.price,</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">          creator : req.user._id,</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">          activated: req.body.activated,</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">          category: req.body.category,</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">          tags: req.body.tags,</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">          nbComment: 0,</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">        });</td></tr><tr class="hit"><td class="line">43</td><td class="hits">1</td><td class="source">        announce.save(function(err, saveItem) {</td></tr><tr class="hit"><td class="line">44</td><td class="hits">1</td><td class="source">          saveAnnounceMongoCallback(err ? err : null, announce, saveItem);</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="miss"><td class="line">47</td><td class="hits">0</td><td class="source">        saveAnnounceMongoCallback('You need to have a title or a content in the announces');</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">51</td><td class="hits">1</td><td class="source">    function saveAnnounceES(announce, saveItem, saveAnnounceESCallback) {</td></tr><tr class="hit"><td class="line">52</td><td class="hits">1</td><td class="source">      console.log('_____save item_____');</td></tr><tr class="hit"><td class="line">53</td><td class="hits">1</td><td class="source">      console.log(saveItem._id.toHexString());</td></tr><tr class="hit"><td class="line">54</td><td class="hits">1</td><td class="source">      console.log('ID : ' + saveItem._id.toHexString());</td></tr><tr class="hit"><td class="line">55</td><td class="hits">1</td><td class="source">      var FORMATTED_DATE;</td></tr><tr class="hit"><td class="line">56</td><td class="hits">1</td><td class="source">      if (announce.isNew) {</td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="source">        announce.created        = Date.now();</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">59</td><td class="hits">1</td><td class="source">      announce.updated.push(Date.now());</td></tr><tr class="hit"><td class="line">60</td><td class="hits">1</td><td class="source">      ES.create({</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">        index: 'announce',</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">        type: 'ann',</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">        id: saveItem._id.toHexString(),</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">        body: {</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">          created: Date.now(),</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">          title: req.body.title,</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">          content: req.body.content,</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">          type: req.body.type,</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">          price: req.body.price,</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">          creator : req.user._id,</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">          activated: req.body.activated,</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">          category: req.body.category,</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">          tags: req.body.tags,</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">          nbComment: 0,</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">          FORMATTED_DATE: moment(announce.DATE_CREATED).format('DD/MM/YYYY, hA:mm')</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">      }, function(err, res) {</td></tr><tr class="hit"><td class="line">78</td><td class="hits">1</td><td class="source">        console.log(err, res);</td></tr><tr class="hit"><td class="line">79</td><td class="hits">1</td><td class="source">        saveAnnounceESCallback(err ? err : null, announce);</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">    // Faire une promise</td></tr><tr class="hit"><td class="line">84</td><td class="hits">1</td><td class="source">    async.waterfall([saveAnnounceMongo, saveAnnounceES], function(error, announce) {</td></tr><tr class="hit"><td class="line">85</td><td class="hits">1</td><td class="source">      console.log(error ? error : null, announce);</td></tr><tr class="hit"><td class="line">86</td><td class="hits">1</td><td class="source">      res.status(error ? 400 : 200).json(error ? error : announce);</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">  // UPDATE AN ANNOUNCE ///////////////////////////////////////////</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">  updateAnnounce: function(req, res) {</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">95</td><td class="hits">0</td><td class="source">    console.log('*****************Update announce*******************');</td></tr><tr class="miss"><td class="line">96</td><td class="hits">0</td><td class="source">    console.log(req.params);</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">98</td><td class="hits">0</td><td class="source">    function findOneAnnounce(findOneAnnounceCallback) {</td></tr><tr class="miss"><td class="line">99</td><td class="hits">0</td><td class="source">      Announce.findOne({</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">        '_id': req.params.announceId</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">      }, function(err, result) {</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">103</td><td class="hits">0</td><td class="source">        if (err || !result) {</td></tr><tr class="miss"><td class="line">104</td><td class="hits">0</td><td class="source">          findOneAnnounceCallback(err ? err : 'There is no announce to update');</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="miss"><td class="line">106</td><td class="hits">0</td><td class="source">          findOneAnnounceCallback(null, result);</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">111</td><td class="hits">0</td><td class="source">    function updateAnnounce(result, updateAnnounceCallback) {</td></tr><tr class="miss"><td class="line">112</td><td class="hits">0</td><td class="source">      console.log('result');</td></tr><tr class="miss"><td class="line">113</td><td class="hits">0</td><td class="source">      if (result.creator._id.equals(req.user._id)) {</td></tr><tr class="miss"><td class="line">114</td><td class="hits">0</td><td class="source">        result.title   = req.body.title;</td></tr><tr class="miss"><td class="line">115</td><td class="hits">0</td><td class="source">        result.content = req.body.content;</td></tr><tr class="miss"><td class="line">116</td><td class="hits">0</td><td class="source">        result.price = req.body.price;</td></tr><tr class="miss"><td class="line">117</td><td class="hits">0</td><td class="source">        result.save(function(err) {</td></tr><tr class="miss"><td class="line">118</td><td class="hits">0</td><td class="source">          updateAnnounceCallback(err ? err : null, result);</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="miss"><td class="line">121</td><td class="hits">0</td><td class="source">        updateAnnounceCallback('You can only update your own announce.');</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">    // Faire une promise</td></tr><tr class="miss"><td class="line">126</td><td class="hits">0</td><td class="source">    async.waterfall([findOneAnnounce, updateAnnounce], function(error, result) {</td></tr><tr class="miss"><td class="line">127</td><td class="hits">0</td><td class="source">      res.status(error ? 400 : 200).json(error ? error : result);</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">  // SHOW AN ANNOUNCE /////////////////////////////////////////////</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">  show: function(req, res) {</td></tr><tr class="miss"><td class="line">135</td><td class="hits">0</td><td class="source">    console.log('***************load announce*********************');</td></tr><tr class="miss"><td class="line">136</td><td class="hits">0</td><td class="source">    console.log(req.params.announceId);</td></tr><tr class="miss"><td class="line">137</td><td class="hits">0</td><td class="source">    Announce.findOne({'_id': req.params.announceId},</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source">      function(err, announce) {</td></tr><tr class="miss"><td class="line">139</td><td class="hits">0</td><td class="source">      if (err || !announce) {</td></tr><tr class="miss"><td class="line">140</td><td class="hits">0</td><td class="source">        res.status(400).json(err ? err : 'There is no announce to load');</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="miss"><td class="line">142</td><td class="hits">0</td><td class="source">        Announce.organizeAnnounceData(announce, function(result) {</td></tr><tr class="miss"><td class="line">143</td><td class="hits">0</td><td class="source">          res.status(200).json(result);</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">148</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source">  // CHANGE STATUS OF ANNOUNCE /////////////////////////////////////////////</td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source">  changeStatusAnnounce: function(req, res) {</td></tr><tr class="miss"><td class="line">153</td><td class="hits">0</td><td class="source">    console.log('***************status announce*********************');</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">155</td><td class="hits">0</td><td class="source">    function findOneAnnounce(findOneAnnounceCallback) {</td></tr><tr class="miss"><td class="line">156</td><td class="hits">0</td><td class="source">      console.log('findOneAnnounces');</td></tr><tr class="miss"><td class="line">157</td><td class="hits">0</td><td class="source">      console.log(req.params.announceId);</td></tr><tr class="miss"><td class="line">158</td><td class="hits">0</td><td class="source">      Announce.findOne({</td></tr><tr><td class="line">159</td><td class="hits"></td><td class="source">        '_id': req.params.announceId</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source">      }, function(err, result) {</td></tr><tr class="miss"><td class="line">161</td><td class="hits">0</td><td class="source">        if (err || !result) {</td></tr><tr class="miss"><td class="line">162</td><td class="hits">0</td><td class="source">          findOneAnnounceCallback(err ? err : 'There is no announce to change status');</td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="miss"><td class="line">164</td><td class="hits">0</td><td class="source">          findOneAnnounceCallback(null, result);</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">169</td><td class="hits">0</td><td class="source">    function updateAnnounceStatus(announce, updateAnnounceStatusCallback) {</td></tr><tr class="miss"><td class="line">170</td><td class="hits">0</td><td class="source">      console.log('update announce status');</td></tr><tr><td class="line">171</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">172</td><td class="hits">0</td><td class="source">      if (announce.creator._id.equals(req.user._id)) {</td></tr><tr class="miss"><td class="line">173</td><td class="hits">0</td><td class="source">        announce.activated = req.params.status;</td></tr><tr class="miss"><td class="line">174</td><td class="hits">0</td><td class="source">        announce.save(function(err) {</td></tr><tr class="miss"><td class="line">175</td><td class="hits">0</td><td class="source">          updateAnnounceStatusCallback(err ? err : null, announce);</td></tr><tr><td class="line">176</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="miss"><td class="line">178</td><td class="hits">0</td><td class="source">        updateAnnounceStatusCallback('You can only update your own announce.');</td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source">    // Faire une promise</td></tr><tr class="miss"><td class="line">183</td><td class="hits">0</td><td class="source">    async.waterfall([findOneAnnounce, updateAnnounceStatus], function(error, result) {</td></tr><tr class="miss"><td class="line">184</td><td class="hits">0</td><td class="source">      res.status(error ? 400 : 200).json(error ? error : result);</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">187</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">189</td><td class="hits"></td><td class="source">  // SEARCH AN ANNOUNCE ///////////////////////////////////////////</td></tr><tr><td class="line">190</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">191</td><td class="hits"></td><td class="source">  searchAnnounces: function(req, res) {</td></tr><tr class="miss"><td class="line">192</td><td class="hits">0</td><td class="source">    console.log('_____________________search announce____________');</td></tr><tr class="miss"><td class="line">193</td><td class="hits">0</td><td class="source">    var terms = req.params.terms || req.body.searchField;</td></tr><tr class="miss"><td class="line">194</td><td class="hits">0</td><td class="source">    ES.search({</td></tr><tr><td class="line">195</td><td class="hits"></td><td class="source">      index: 'announce',</td></tr><tr><td class="line">196</td><td class="hits"></td><td class="source">      body: {</td></tr><tr><td class="line">197</td><td class="hits"></td><td class="source">        'size' : 1000,</td></tr><tr><td class="line">198</td><td class="hits"></td><td class="source">        'query': {</td></tr><tr><td class="line">199</td><td class="hits"></td><td class="source">          'match': {</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source">            'title': terms</td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">202</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">203</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source">    }).then(function (resp) {</td></tr><tr><td class="line">205</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">206</td><td class="hits">0</td><td class="source">      var announces = resp.hits.hits;</td></tr><tr class="miss"><td class="line">207</td><td class="hits">0</td><td class="source">      console.log('/////////////////////////////////////////////');</td></tr><tr><td class="line">208</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">209</td><td class="hits">0</td><td class="source">      var initAnnounces = function(announce, doneCallback) {</td></tr><tr class="miss"><td class="line">210</td><td class="hits">0</td><td class="source">        announce.title   = announce._source.title.length &gt; 34 ?</td></tr><tr><td class="line">211</td><td class="hits"></td><td class="source">        announce._source.title.substring(0, 35) + '...' :</td></tr><tr><td class="line">212</td><td class="hits"></td><td class="source">        announce._source.title;</td></tr><tr class="miss"><td class="line">213</td><td class="hits">0</td><td class="source">        announce.content = announce._source.content.length &gt; 34 ?</td></tr><tr><td class="line">214</td><td class="hits"></td><td class="source">        announce._source.content.substring(0, 35) + '...' :</td></tr><tr><td class="line">215</td><td class="hits"></td><td class="source">        announce._source.content;</td></tr><tr class="miss"><td class="line">216</td><td class="hits">0</td><td class="source">        announce.price   = announce._source.price;</td></tr><tr class="miss"><td class="line">217</td><td class="hits">0</td><td class="source">        if (announce._source.FORMATTED_DATE) {</td></tr><tr class="miss"><td class="line">218</td><td class="hits">0</td><td class="source">          var m                   = moment(announce._source.FORMATTED_DATE, 'DD/MM/YYYY, hA:mm');</td></tr><tr class="miss"><td class="line">219</td><td class="hits">0</td><td class="source">          announce.FORMATTED_DATE = m.fromNow();</td></tr><tr><td class="line">220</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">221</td><td class="hits">0</td><td class="source">        var ObjectID = require('mongodb').ObjectID;</td></tr><tr class="miss"><td class="line">222</td><td class="hits">0</td><td class="source">        Announce.findOne({</td></tr><tr><td class="line">223</td><td class="hits"></td><td class="source">          'creator': announce._source.creator</td></tr><tr><td class="line">224</td><td class="hits"></td><td class="source">        }, function(err, result) {</td></tr><tr class="miss"><td class="line">225</td><td class="hits">0</td><td class="source">          announce.creator = result.creator;</td></tr><tr class="miss"><td class="line">226</td><td class="hits">0</td><td class="source">          var _id = new ObjectID(announce._id);</td></tr><tr class="miss"><td class="line">227</td><td class="hits">0</td><td class="source">          Comment.count({announce: _id}).exec(function(err, result) {</td></tr><tr class="miss"><td class="line">228</td><td class="hits">0</td><td class="source">            announce.nbComment = result;</td></tr><tr class="miss"><td class="line">229</td><td class="hits">0</td><td class="source">            doneCallback(err ? err : null, announce);</td></tr><tr><td class="line">230</td><td class="hits"></td><td class="source">          });</td></tr><tr><td class="line">231</td><td class="hits"></td><td class="source">        }); </td></tr><tr><td class="line">232</td><td class="hits"></td><td class="source">      };</td></tr><tr><td class="line">233</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">234</td><td class="hits">0</td><td class="source">      async.map(announces, initAnnounces, function(err, result) {</td></tr><tr class="miss"><td class="line">235</td><td class="hits">0</td><td class="source">        console.log('ùùùùùùùùùùùùùùùùùùùùùùùùùùùùùùùùùù');</td></tr><tr class="miss"><td class="line">236</td><td class="hits">0</td><td class="source">        console.log(result);</td></tr><tr class="miss"><td class="line">237</td><td class="hits">0</td><td class="source">        return res.status(err ? 400 : 200).json(err ? err : {</td></tr><tr><td class="line">238</td><td class="hits"></td><td class="source">          total: resp.hits.total,</td></tr><tr><td class="line">239</td><td class="hits"></td><td class="source">          announce: result</td></tr><tr><td class="line">240</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">241</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">242</td><td class="hits"></td><td class="source">    }, function (err) {</td></tr><tr class="miss"><td class="line">243</td><td class="hits">0</td><td class="source">      console.log(err);</td></tr><tr class="miss"><td class="line">244</td><td class="hits">0</td><td class="source">      res.status(400).json(err.message);</td></tr><tr><td class="line">245</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">246</td><td class="hits"></td><td class="source">    // Announce.search({</td></tr><tr><td class="line">247</td><td class="hits"></td><td class="source">    //   query:{</td></tr><tr><td class="line">248</td><td class="hits"></td><td class="source">    //     'multi_match': {</td></tr><tr><td class="line">249</td><td class="hits"></td><td class="source">    //       'fields':  ['content', 'title'],</td></tr><tr><td class="line">250</td><td class="hits"></td><td class="source">    //         'query':terms,</td></tr><tr><td class="line">251</td><td class="hits"></td><td class="source">    //         &quot;analyzer&quot;: &quot;standard&quot;,</td></tr><tr><td class="line">252</td><td class="hits"></td><td class="source">    //         'fuzziness': 'AUTO',</td></tr><tr><td class="line">253</td><td class="hits"></td><td class="source">    //   }</td></tr><tr><td class="line">254</td><td class="hits"></td><td class="source">    // }}, function(err, results) {</td></tr><tr><td class="line">255</td><td class="hits"></td><td class="source">    //   if (err) {</td></tr><tr><td class="line">256</td><td class="hits"></td><td class="source">    //     ee.emit('error', err);</td></tr><tr><td class="line">257</td><td class="hits"></td><td class="source">    //     res.status(400).json(err);</td></tr><tr><td class="line">258</td><td class="hits"></td><td class="source">    //   } else {</td></tr><tr><td class="line">259</td><td class="hits"></td><td class="source">    //     console.log(results);</td></tr><tr><td class="line">260</td><td class="hits"></td><td class="source">    //     var announces = results.hits.hits;</td></tr><tr><td class="line">261</td><td class="hits"></td><td class="source">    //     </td></tr><tr><td class="line">262</td><td class="hits"></td><td class="source">    //   }</td></tr><tr><td class="line">263</td><td class="hits"></td><td class="source">    // });</td></tr><tr><td class="line">264</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">265</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">266</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">267</td><td class="hits"></td><td class="source">  // DELETE AN ANNOUNCE ///////////////////////////////////////////</td></tr><tr><td class="line">268</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">269</td><td class="hits"></td><td class="source">  deleteAnnounce: function(req, res) {</td></tr><tr class="miss"><td class="line">270</td><td class="hits">0</td><td class="source">    console.log('_____________________destroy announce____________');</td></tr><tr><td class="line">271</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">272</td><td class="hits">0</td><td class="source">    function deleteAnnounceMongo(deleteAnnounceMongoCallback) {</td></tr><tr class="miss"><td class="line">273</td><td class="hits">0</td><td class="source">      console.log('delete announce mongo');</td></tr><tr class="miss"><td class="line">274</td><td class="hits">0</td><td class="source">      Announce.findByIdAndRemove(req.params.announceId, function(err, announce) {</td></tr><tr class="miss"><td class="line">275</td><td class="hits">0</td><td class="source">        deleteAnnounceMongoCallback(err ? err : null, announce);</td></tr><tr><td class="line">276</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">277</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">278</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">279</td><td class="hits">0</td><td class="source">    function deleteAnnounceES(announce, deleteAnnounceESCallback) {</td></tr><tr class="miss"><td class="line">280</td><td class="hits">0</td><td class="source">      ES.delete({</td></tr><tr><td class="line">281</td><td class="hits"></td><td class="source">        index: 'announce',</td></tr><tr><td class="line">282</td><td class="hits"></td><td class="source">        type: 'ann',</td></tr><tr><td class="line">283</td><td class="hits"></td><td class="source">        id : req.params.announceId</td></tr><tr><td class="line">284</td><td class="hits"></td><td class="source">      }, function(err) {</td></tr><tr class="miss"><td class="line">285</td><td class="hits">0</td><td class="source">        deleteAnnounceESCallback(err ? err : null, announce);</td></tr><tr><td class="line">286</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">287</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">288</td><td class="hits"></td><td class="source">    // Faire une promise</td></tr><tr class="miss"><td class="line">289</td><td class="hits">0</td><td class="source">    async.waterfall([deleteAnnounceMongo, deleteAnnounceES], function(error, announce) {</td></tr><tr class="miss"><td class="line">290</td><td class="hits">0</td><td class="source">      if (error) {</td></tr><tr class="miss"><td class="line">291</td><td class="hits">0</td><td class="source">        return res.status(400).json(error);  </td></tr><tr><td class="line">292</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="miss"><td class="line">293</td><td class="hits">0</td><td class="source">        console.log('result');</td></tr><tr class="miss"><td class="line">294</td><td class="hits">0</td><td class="source">        console.log(announce);</td></tr><tr class="miss"><td class="line">295</td><td class="hits">0</td><td class="source">        console.log(error);</td></tr><tr class="miss"><td class="line">296</td><td class="hits">0</td><td class="source">        return res.status(200).json(announce);</td></tr><tr><td class="line">297</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">298</td><td class="hits"></td><td class="source">      </td></tr><tr><td class="line">299</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">300</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">301</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">302</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">303</td><td class="hits"></td><td class="source">  // ANNOUNCE PAGINATION //////////////////////////////////////////</td></tr><tr><td class="line">304</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">305</td><td class="hits"></td><td class="source">  listPagination: function(req, res) {</td></tr><tr class="miss"><td class="line">306</td><td class="hits">0</td><td class="source">    var findAnnounces = function(next) {</td></tr><tr class="miss"><td class="line">307</td><td class="hits">0</td><td class="source">      Announce</td></tr><tr><td class="line">308</td><td class="hits"></td><td class="source">        .find()</td></tr><tr><td class="line">309</td><td class="hits"></td><td class="source">        .sort('-created')</td></tr><tr><td class="line">310</td><td class="hits"></td><td class="source">        .where('activated').equals(true)</td></tr><tr><td class="line">311</td><td class="hits"></td><td class="source">        .skip((10 * req.params.page) - 10)</td></tr><tr><td class="line">312</td><td class="hits"></td><td class="source">        .limit(10)</td></tr><tr><td class="line">313</td><td class="hits"></td><td class="source">        .exec(next);</td></tr><tr><td class="line">314</td><td class="hits"></td><td class="source">    };</td></tr><tr class="miss"><td class="line">315</td><td class="hits">0</td><td class="source">    var countAnnounces = function(next) {</td></tr><tr class="miss"><td class="line">316</td><td class="hits">0</td><td class="source">      Announce.count().exec(next);</td></tr><tr><td class="line">317</td><td class="hits"></td><td class="source">    };</td></tr><tr class="miss"><td class="line">318</td><td class="hits">0</td><td class="source">    async.parallel({</td></tr><tr><td class="line">319</td><td class="hits"></td><td class="source">      find: findAnnounces,</td></tr><tr><td class="line">320</td><td class="hits"></td><td class="source">      count: countAnnounces</td></tr><tr><td class="line">321</td><td class="hits"></td><td class="source">    }, function done(err, results) {</td></tr><tr><td class="line">322</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">323</td><td class="hits">0</td><td class="source">      var countComments = function(item, doneCallback) {</td></tr><tr class="miss"><td class="line">324</td><td class="hits">0</td><td class="source">        if (item.FORMATTED_DATE) {</td></tr><tr class="miss"><td class="line">325</td><td class="hits">0</td><td class="source">          var m               = moment(item.FORMATTED_DATE, 'DD/MM/YYYY, hA:mm');</td></tr><tr class="miss"><td class="line">326</td><td class="hits">0</td><td class="source">          item.FORMATTED_DATE = m.fromNow();</td></tr><tr><td class="line">327</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">328</td><td class="hits">0</td><td class="source">        Comment.count({announce: item._id}).exec(function(err, result) {</td></tr><tr class="miss"><td class="line">329</td><td class="hits">0</td><td class="source">          item.nbComment = result;</td></tr><tr class="miss"><td class="line">330</td><td class="hits">0</td><td class="source">          doneCallback(err ? err : null, item);</td></tr><tr><td class="line">331</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">332</td><td class="hits"></td><td class="source">      };</td></tr><tr class="miss"><td class="line">333</td><td class="hits">0</td><td class="source">      async.map(results.find, countComments, function(err, result) {</td></tr><tr class="miss"><td class="line">334</td><td class="hits">0</td><td class="source">        return res.json({</td></tr><tr><td class="line">335</td><td class="hits"></td><td class="source">          total: results.count,</td></tr><tr><td class="line">336</td><td class="hits"></td><td class="source">          announces: result</td></tr><tr><td class="line">337</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">338</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">339</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">340</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">341</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">342</td><td class="hits"></td><td class="source">  listUserPagination: function(req, res) {</td></tr><tr class="miss"><td class="line">343</td><td class="hits">0</td><td class="source">    var findAnnounces = function(next) {</td></tr><tr class="miss"><td class="line">344</td><td class="hits">0</td><td class="source">      console.log('list user pagination');</td></tr><tr><td class="line">345</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">346</td><td class="hits">0</td><td class="source">      Announce</td></tr><tr><td class="line">347</td><td class="hits"></td><td class="source">        .find({creator: req.user._id})</td></tr><tr><td class="line">348</td><td class="hits"></td><td class="source">        .sort('-created')</td></tr><tr><td class="line">349</td><td class="hits"></td><td class="source">        .select()</td></tr><tr><td class="line">350</td><td class="hits"></td><td class="source">        .skip((10 * req.params.page) - 10)</td></tr><tr><td class="line">351</td><td class="hits"></td><td class="source">        .limit(10)</td></tr><tr><td class="line">352</td><td class="hits"></td><td class="source">        .sort({date_added: -1})</td></tr><tr><td class="line">353</td><td class="hits"></td><td class="source">        .exec(next);</td></tr><tr><td class="line">354</td><td class="hits"></td><td class="source">    };</td></tr><tr class="miss"><td class="line">355</td><td class="hits">0</td><td class="source">    var countAnnounces = function(next) {</td></tr><tr class="miss"><td class="line">356</td><td class="hits">0</td><td class="source">      Announce.count({creator: req.params.user}).exec(next);</td></tr><tr><td class="line">357</td><td class="hits"></td><td class="source">    };</td></tr><tr class="miss"><td class="line">358</td><td class="hits">0</td><td class="source">    async.parallel({</td></tr><tr><td class="line">359</td><td class="hits"></td><td class="source">      find: findAnnounces,</td></tr><tr><td class="line">360</td><td class="hits"></td><td class="source">      count: countAnnounces</td></tr><tr><td class="line">361</td><td class="hits"></td><td class="source">    }, function done(err, results) {</td></tr><tr class="miss"><td class="line">362</td><td class="hits">0</td><td class="source">      return res.status(err ? 400 : 200).json(err ? err : {</td></tr><tr><td class="line">363</td><td class="hits"></td><td class="source">        total: results.count,</td></tr><tr><td class="line">364</td><td class="hits"></td><td class="source">        announces: results.find</td></tr><tr><td class="line">365</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">366</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">367</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">368</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">369</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/home/lemelon/EIPmaster/newapp/backend/controllers/friendsCtrl.js">/home/lemelon/EIPmaster/newapp/backend/controllers/friendsCtrl.js</h2><div id="stats" class="terrible"><div class="percentage">5%</div><div class="sloc">96</div><div class="hits">5</div><div class="misses">91</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">// MODULE DEPENDENCIES //////////////////////////////////////////</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">/////////////////////////////////////////////////////////////////</td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">var mongoose = require('mongoose');</td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">var Friend   = mongoose.model('Friend');</td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">var User     = mongoose.model('User');</td></tr><tr class="hit"><td class="line">7</td><td class="hits">1</td><td class="source">var async    = require('async');</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">9</td><td class="hits">1</td><td class="source">module.exports = {</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">  // CREATE A FRIEND //////////////////////////////////////////////</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">  postFriend: function(req, res) {</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">16</td><td class="hits">0</td><td class="source">    console.log(req.body);</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">18</td><td class="hits">0</td><td class="source">    function saveReceiverFriendRequest(saveReceiverFriendRequestCallback) {</td></tr><tr class="miss"><td class="line">19</td><td class="hits">0</td><td class="source">      console.log('saveReceiverFriendRequest');</td></tr><tr class="miss"><td class="line">20</td><td class="hits">0</td><td class="source">      Friend.saveFriend(req.body.idUser, req.user.username, function(error, result) {</td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="source">        console.log(error, result);</td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="source">        saveReceiverFriendRequestCallback(error ? error : null);</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">26</td><td class="hits">0</td><td class="source">    function saveSenderFriendRequest(saveSenderFriendRequestCallback) {</td></tr><tr class="miss"><td class="line">27</td><td class="hits">0</td><td class="source">      console.log('saveSenderFriendRequest');</td></tr><tr class="miss"><td class="line">28</td><td class="hits">0</td><td class="source">      Friend.saveFriend(req.user._id, req.body.usernameAcceptedFriendRequest, function(error, result) {</td></tr><tr class="miss"><td class="line">29</td><td class="hits">0</td><td class="source">        console.log(error, result);</td></tr><tr class="miss"><td class="line">30</td><td class="hits">0</td><td class="source">        saveSenderFriendRequestCallback(error ? error : null);</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">34</td><td class="hits">0</td><td class="source">    function testIfReceiverFriendRequestDone(testIfReceiverFriendRequestDoneCallback) {</td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="source">      console.log('testIfReceiverFriendRequestDone');</td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="source">      Friend.testIfFriendRequestDone(req.body.idUser, function(result) {</td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="source">        console.log(result);</td></tr><tr class="miss"><td class="line">38</td><td class="hits">0</td><td class="source">        testIfReceiverFriendRequestDoneCallback(result === false ? 'friend request already done' : null);</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="source">    function testIfSenderFriendRequestDone(testIfSenderFriendRequestDoneCallback) {</td></tr><tr class="miss"><td class="line">43</td><td class="hits">0</td><td class="source">      console.log('testIfSenderFriendRequestDone');</td></tr><tr class="miss"><td class="line">44</td><td class="hits">0</td><td class="source">      Friend.testIfFriendRequestDone(req.user._id, function(result) {</td></tr><tr class="miss"><td class="line">45</td><td class="hits">0</td><td class="source">        console.log(result);</td></tr><tr class="miss"><td class="line">46</td><td class="hits">0</td><td class="source">        testIfSenderFriendRequestDoneCallback(result === false ? 'friend request already done' : null);</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">50</td><td class="hits">0</td><td class="source">    function saveWaitReceiverFriendRequest(saveWaitReceiverFriendRequestCallback) {</td></tr><tr class="miss"><td class="line">51</td><td class="hits">0</td><td class="source">      console.log('saveWaitReceiverFriendRequest');</td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="source">      var friend                       = new Friend();</td></tr><tr class="miss"><td class="line">53</td><td class="hits">0</td><td class="source">      var waitFriendRequest            = req.user.username;</td></tr><tr class="miss"><td class="line">54</td><td class="hits">0</td><td class="source">      friend.usernameWaitFriendRequest = waitFriendRequest;</td></tr><tr class="miss"><td class="line">55</td><td class="hits">0</td><td class="source">      friend.creator                   = req.body.idUser;</td></tr><tr class="miss"><td class="line">56</td><td class="hits">0</td><td class="source">      friend.save(function(err, result) {</td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="source">        console.log(err);</td></tr><tr class="miss"><td class="line">58</td><td class="hits">0</td><td class="source">        console.log(result);</td></tr><tr class="miss"><td class="line">59</td><td class="hits">0</td><td class="source">        saveWaitReceiverFriendRequestCallback(err ? err : null);</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">64</td><td class="hits">0</td><td class="source">    function saveWaitSenderFriendRequest(saveWaitSenderFriendRequestCallback) {</td></tr><tr class="miss"><td class="line">65</td><td class="hits">0</td><td class="source">      console.log('saveSenderFriendFriendRequest');</td></tr><tr class="miss"><td class="line">66</td><td class="hits">0</td><td class="source">      var friend                       = new Friend();</td></tr><tr class="miss"><td class="line">67</td><td class="hits">0</td><td class="source">      friend.usernameWaitFriendRequest = req.body.usernameWaitFriendRequest;</td></tr><tr class="miss"><td class="line">68</td><td class="hits">0</td><td class="source">      friend.creator                   = req.user._id;</td></tr><tr class="miss"><td class="line">69</td><td class="hits">0</td><td class="source">      friend.save(function(err) {</td></tr><tr class="miss"><td class="line">70</td><td class="hits">0</td><td class="source">        console.log(err);</td></tr><tr class="miss"><td class="line">71</td><td class="hits">0</td><td class="source">        saveWaitSenderFriendRequestCallback(err ? err : null);</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">76</td><td class="hits">0</td><td class="source">    if (req.body.usernameAcceptedFriendRequest) {</td></tr><tr class="miss"><td class="line">77</td><td class="hits">0</td><td class="source">      console.log('usernameAcceptedFriendRequest');</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">      // Faire une promise</td></tr><tr class="miss"><td class="line">79</td><td class="hits">0</td><td class="source">      async.waterfall([saveReceiverFriendRequest, saveSenderFriendRequest], function(error, result) {</td></tr><tr class="miss"><td class="line">80</td><td class="hits">0</td><td class="source">        console.log(error, result);</td></tr><tr class="miss"><td class="line">81</td><td class="hits">0</td><td class="source">        res.status(error ? 400 : 200).json(error ? error : null);</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">      });</td></tr><tr class="miss"><td class="line">83</td><td class="hits">0</td><td class="source">    } else if (req.body.usernameWaitFriendRequest) {</td></tr><tr class="miss"><td class="line">84</td><td class="hits">0</td><td class="source">      console.log('usernameWaitFriendRequest');</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">      // Faire une promise</td></tr><tr class="miss"><td class="line">86</td><td class="hits">0</td><td class="source">      async.waterfall([</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">        testIfReceiverFriendRequestDone,</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">        testIfSenderFriendRequestDone,</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">        saveWaitReceiverFriendRequest,</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">        saveWaitSenderFriendRequest</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">      ], function(error, result) {</td></tr><tr class="miss"><td class="line">92</td><td class="hits">0</td><td class="source">        console.log(error, result);</td></tr><tr class="miss"><td class="line">93</td><td class="hits">0</td><td class="source">        res.status(error ? 400 : 200).json(error ? error : null);</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">  ///////////////////////////////////////////////////////////////</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">  // DELETE A FRIEND ////////////////////////////////////////////</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">  ///////////////////////////////////////////////////////////////</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">  deleteFriend: function(req, res) {</td></tr><tr class="miss"><td class="line">102</td><td class="hits">0</td><td class="source">    console.log('_________destroy friend_____________');</td></tr><tr class="miss"><td class="line">103</td><td class="hits">0</td><td class="source">    Friend.findOne({</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">      creator: req.params.friendId</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">    }).where('usernameWaitFriendRequest').equals(req.params.user)</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">    .remove(function(err, result) {</td></tr><tr class="miss"><td class="line">107</td><td class="hits">0</td><td class="source">      res.status(err ? 400 : 200).json(err ? err : null);</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">  // LIST ALL FRIENDS FROM USER////////////////////////////////////</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">  getFriendsFromUser: function(req, res) {</td></tr><tr class="miss"><td class="line">115</td><td class="hits">0</td><td class="source">    console.log('************** Get All Friends **********');</td></tr><tr class="miss"><td class="line">116</td><td class="hits">0</td><td class="source">    var sendFriends = [];</td></tr><tr class="miss"><td class="line">117</td><td class="hits">0</td><td class="source">    Friend.find({creator: req.user._id})</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">    .sort('-created')</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">    .exec(function(err, friends) {</td></tr><tr class="miss"><td class="line">120</td><td class="hits">0</td><td class="source">      if (err) {</td></tr><tr class="miss"><td class="line">121</td><td class="hits">0</td><td class="source">        res.status(501).json(err);</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="miss"><td class="line">123</td><td class="hits">0</td><td class="source">        friends.forEach(function(item) {</td></tr><tr class="miss"><td class="line">124</td><td class="hits">0</td><td class="source">          if (item.usernameAcceptedFriendRequest) {</td></tr><tr class="miss"><td class="line">125</td><td class="hits">0</td><td class="source">            sendFriends.push({</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">              accepted: item.usernameAcceptedFriendRequest</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">            });</td></tr><tr class="miss"><td class="line">128</td><td class="hits">0</td><td class="source">          } else if (item.usernameWaitFriendRequest) {</td></tr><tr class="miss"><td class="line">129</td><td class="hits">0</td><td class="source">            sendFriends.push({</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source">              wait: item.usernameWaitFriendRequest</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source">        });</td></tr><tr class="miss"><td class="line">134</td><td class="hits">0</td><td class="source">        res.status(200).json(sendFriends);</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">  testIfFriend: function(req, res) {</td></tr><tr class="miss"><td class="line">140</td><td class="hits">0</td><td class="source">    console.log('************** Test if Friends **********');</td></tr><tr class="miss"><td class="line">141</td><td class="hits">0</td><td class="source">    var testFriend = [];</td></tr><tr class="miss"><td class="line">142</td><td class="hits">0</td><td class="source">    var testWait   = [];</td></tr><tr class="miss"><td class="line">143</td><td class="hits">0</td><td class="source">    Friend.find({creator: req.user._id})</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">    .sort('-created')</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">    .exec(function(err, friends) {</td></tr><tr class="miss"><td class="line">146</td><td class="hits">0</td><td class="source">      if (err) {</td></tr><tr class="miss"><td class="line">147</td><td class="hits">0</td><td class="source">        ee.emit('error', err);</td></tr><tr class="miss"><td class="line">148</td><td class="hits">0</td><td class="source">        res.status(501).json(err);</td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="miss"><td class="line">150</td><td class="hits">0</td><td class="source">        console.log(friends);</td></tr><tr class="miss"><td class="line">151</td><td class="hits">0</td><td class="source">        friends.forEach(function(item) {</td></tr><tr class="miss"><td class="line">152</td><td class="hits">0</td><td class="source">          if (item.usernameAcceptedFriendRequest) {</td></tr><tr class="miss"><td class="line">153</td><td class="hits">0</td><td class="source">            testFriend.push(item.usernameAcceptedFriendRequest);</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source">          } </td></tr><tr class="miss"><td class="line">155</td><td class="hits">0</td><td class="source">          if (item.usernameWaitFriendRequest) {</td></tr><tr class="miss"><td class="line">156</td><td class="hits">0</td><td class="source">            testWait.push(item.usernameWaitFriendRequest);</td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source">        });</td></tr><tr class="miss"><td class="line">159</td><td class="hits">0</td><td class="source">        if (testFriend.indexOf(req.params.user) === 0) {</td></tr><tr class="miss"><td class="line">160</td><td class="hits">0</td><td class="source">          return res.status(200).json(3);</td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="miss"><td class="line">162</td><td class="hits">0</td><td class="source">          res.status(200).json(testWait.indexOf(req.params.user) === 0 ? 2 : 1);</td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source">    /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source">  // LIST ALL FRIENDS FROM USER////////////////////////////////////</td></tr><tr><td class="line">170</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">171</td><td class="hits"></td><td class="source">  countFriends: function(req, res) {</td></tr><tr class="miss"><td class="line">172</td><td class="hits">0</td><td class="source">    console.log('************** Count Friends **********');</td></tr><tr class="miss"><td class="line">173</td><td class="hits">0</td><td class="source">    var sendFriends = [];</td></tr><tr class="miss"><td class="line">174</td><td class="hits">0</td><td class="source">    console.log(req.params.idUser);</td></tr><tr class="miss"><td class="line">175</td><td class="hits">0</td><td class="source">    Friend.find({creator: req.params.idUser})</td></tr><tr><td class="line">176</td><td class="hits"></td><td class="source">      .sort('-created')</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">      .exec(function(err, friends) {</td></tr><tr class="miss"><td class="line">178</td><td class="hits">0</td><td class="source">        if (err) {</td></tr><tr class="miss"><td class="line">179</td><td class="hits">0</td><td class="source">          ee.emit('error', err);</td></tr><tr class="miss"><td class="line">180</td><td class="hits">0</td><td class="source">          res.status(501).json(err);</td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="miss"><td class="line">182</td><td class="hits">0</td><td class="source">          console.log(friends);</td></tr><tr class="miss"><td class="line">183</td><td class="hits">0</td><td class="source">          friends.forEach(function(item) {</td></tr><tr class="miss"><td class="line">184</td><td class="hits">0</td><td class="source">            if (item.usernameAcceptedFriendRequest) {</td></tr><tr class="miss"><td class="line">185</td><td class="hits">0</td><td class="source">              sendFriends.push({</td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source">                accepted: item.usernameAcceptedFriendRequest</td></tr><tr><td class="line">187</td><td class="hits"></td><td class="source">              });</td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">189</td><td class="hits"></td><td class="source">          });</td></tr><tr class="miss"><td class="line">190</td><td class="hits">0</td><td class="source">          res.status(200).json(sendFriends.length);</td></tr><tr><td class="line">191</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">192</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">193</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">194</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">195</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/home/lemelon/EIPmaster/newapp/backend/controllers/imagesCtrl.js">/home/lemelon/EIPmaster/newapp/backend/controllers/imagesCtrl.js</h2><div id="stats" class="terrible"><div class="percentage">11%</div><div class="sloc">102</div><div class="hits">12</div><div class="misses">90</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">// MODULE DEPENDENCIES //////////////////////////////////////////</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">/////////////////////////////////////////////////////////////////</td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">var mongoose  = require('mongoose');</td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">var fs        = require('fs-extra');</td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">var path      = require('path');</td></tr><tr class="hit"><td class="line">7</td><td class="hits">1</td><td class="source">var crypto    = require('crypto');</td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">var User      = mongoose.model('User');</td></tr><tr class="hit"><td class="line">9</td><td class="hits">1</td><td class="source">var Images    = mongoose.model('Image');</td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">var Actuality = mongoose.model('Actuality');</td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">var async    = require('async');</td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">var elasticsearch = require('elasticsearch');</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">14</td><td class="hits">1</td><td class="source">if (process.env.NODE_ENV === 'production') {</td></tr><tr class="miss"><td class="line">15</td><td class="hits">0</td><td class="source">  var ES = new elasticsearch.Client({</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">    host: &quot;http://paas:f669a84c8a68e09959b4e8e88df26bf5@dwalin-us-east-1.searchly.com&quot;</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">} else {</td></tr><tr class="hit"><td class="line">19</td><td class="hits">1</td><td class="source">  var ES = new elasticsearch.Client({</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">    host: &quot;localhost:9200&quot;</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">24</td><td class="hits">1</td><td class="source">module.exports = {</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">  // UPLOAD IMAGE /////////////////////////////////////////////////</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">  upload: function(req, res) {</td></tr><tr class="miss"><td class="line">30</td><td class="hits">0</td><td class="source">    console.log('//////File caracteristics/////////');</td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="source">    var destPath;</td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="source">    destPath = process.env.NODE_ENV === 'production' ?</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">    path.join(__dirname, '../../dist/images/') :</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">    destPath             = path.join(__dirname, '../../frontend/images/');</td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="source">    var originalFilename = req.files.file.originalFilename;</td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="source">    if (originalFilename) {</td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="source">      var hashName    = crypto.createHash('md5').</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">      update(originalFilename).digest('hex') + '.jpeg';</td></tr><tr class="miss"><td class="line">39</td><td class="hits">0</td><td class="source">      var writeStream = req.files.file.ws;</td></tr><tr class="miss"><td class="line">40</td><td class="hits">0</td><td class="source">      while (fs.existsSync(destPath + hashName)) {</td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="source">        hashName  = hashName.substring(0, hashName.length - 5);</td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="source">        var rnd   = crypto.randomBytes(3);</td></tr><tr class="miss"><td class="line">43</td><td class="hits">0</td><td class="source">        var value = new Array(3);</td></tr><tr class="miss"><td class="line">44</td><td class="hits">0</td><td class="source">        var len   = hashName.length;</td></tr><tr class="miss"><td class="line">45</td><td class="hits">0</td><td class="source">        for (var i = 0; i &lt; 3; i++) {</td></tr><tr class="miss"><td class="line">46</td><td class="hits">0</td><td class="source">          value[i] = hashName[rnd[i] % len];</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">48</td><td class="hits">0</td><td class="source">        hashName = hashName + value.join('') + '.jpeg';</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">      }</td></tr><tr class="miss"><td class="line">50</td><td class="hits">0</td><td class="source">      fs.copy(writeStream.path, destPath + hashName, function(err) {</td></tr><tr class="miss"><td class="line">51</td><td class="hits">0</td><td class="source">        if (err) {</td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="source">          return res.send(err);</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">54</td><td class="hits">0</td><td class="source">        fs.chmodSync(destPath + hashName, '755');</td></tr><tr class="miss"><td class="line">55</td><td class="hits">0</td><td class="source">        fs.remove(writeStream.path, function(err) {</td></tr><tr class="miss"><td class="line">56</td><td class="hits">0</td><td class="source">          if (err) {</td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="source">            return res.error(err);</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">      });</td></tr><tr class="miss"><td class="line">61</td><td class="hits">0</td><td class="source">      Images.find({</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">        creator: req.user._id</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">      })</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">      .sort('-created')</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">      .exec(function(err, result) {</td></tr><tr class="miss"><td class="line">66</td><td class="hits">0</td><td class="source">        if (err) {</td></tr><tr class="miss"><td class="line">67</td><td class="hits">0</td><td class="source">          return res.status(501).json(err);</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">69</td><td class="hits">0</td><td class="source">        var profile = true ? result.length === 0 : false;</td></tr><tr class="miss"><td class="line">70</td><td class="hits">0</td><td class="source">        var image   = new Images({</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">          name: hashName,</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">          profileImage: profile,</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">          creator : req.user._id</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">        });</td></tr><tr class="miss"><td class="line">75</td><td class="hits">0</td><td class="source">        if (profile === true) {</td></tr><tr class="miss"><td class="line">76</td><td class="hits">0</td><td class="source">          User.findOne({_id: req.user._id}).exec(function(err, resultForSave) {</td></tr><tr class="miss"><td class="line">77</td><td class="hits">0</td><td class="source">            resultForSave.profileImage = hashName;</td></tr><tr class="miss"><td class="line">78</td><td class="hits">0</td><td class="source">            resultForSave.save();</td></tr><tr class="miss"><td class="line">79</td><td class="hits">0</td><td class="source">            ES.index({</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">              index: 'user',</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">              type: 'usr',</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">              id: resultForSave._id.toHexString(),</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">              body: {</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">                username: resultForSave.username,</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">                profileImage: hashName</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">              }</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">            }, function (error, response) {</td></tr><tr class="miss"><td class="line">88</td><td class="hits">0</td><td class="source">                console.log('put in elasticsearch');</td></tr><tr class="miss"><td class="line">89</td><td class="hits">0</td><td class="source">                console.log(error);</td></tr><tr class="miss"><td class="line">90</td><td class="hits">0</td><td class="source">                console.log(response);</td></tr><tr class="miss"><td class="line">91</td><td class="hits">0</td><td class="source">                var actuality     = new Actuality();</td></tr><tr class="miss"><td class="line">92</td><td class="hits">0</td><td class="source">                actuality.content = hashName;</td></tr><tr class="miss"><td class="line">93</td><td class="hits">0</td><td class="source">                actuality.status  = 2;</td></tr><tr class="miss"><td class="line">94</td><td class="hits">0</td><td class="source">                actuality.creator = req.user._id;</td></tr><tr class="miss"><td class="line">95</td><td class="hits">0</td><td class="source">                actuality.save();</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">              });</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">99</td><td class="hits">0</td><td class="source">        image.save(function(err, result) {</td></tr><tr class="miss"><td class="line">100</td><td class="hits">0</td><td class="source">          return res.status(err ? 400 : 200).json(err ? err : {</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">            images: result.name</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">          });</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="miss"><td class="line">106</td><td class="hits">0</td><td class="source">      res.status(400).json('No images');</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">  getImages: function(req, res, next) {</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">112</td><td class="hits">0</td><td class="source">    console.log('____________get images from user__________');</td></tr><tr class="miss"><td class="line">113</td><td class="hits">0</td><td class="source">    var sendImages = [];</td></tr><tr class="miss"><td class="line">114</td><td class="hits">0</td><td class="source">    Images.find({</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">      creator: req.user._id</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">    })</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">    .sort({profileImage: -1})</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">    .exec(function(err, result) {</td></tr><tr class="miss"><td class="line">119</td><td class="hits">0</td><td class="source">      console.log(result);</td></tr><tr class="miss"><td class="line">120</td><td class="hits">0</td><td class="source">      return res.status(err ? 501 : 200).json(err ? err : result);</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">  deleteImage: function(req, res, next) {</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">126</td><td class="hits">0</td><td class="source">    console.log('____________get images from user__________');</td></tr><tr class="miss"><td class="line">127</td><td class="hits">0</td><td class="source">    Images.findByIdAndRemove(req.params.imageId, function(err, image) {</td></tr><tr class="miss"><td class="line">128</td><td class="hits">0</td><td class="source">      res.status(err ? 400 : 200).json(err ? err : image);</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">  changeImageStatus: function(req, res, next) {</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">134</td><td class="hits">0</td><td class="source">    function findOneUserImage(findOneUserImageCallback) {</td></tr><tr class="miss"><td class="line">135</td><td class="hits">0</td><td class="source">      Images.findOne({'creator': req.user._id})</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">      .where('profileImage').equals(true)</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">      .exec(function(err, result) {</td></tr><tr class="miss"><td class="line">138</td><td class="hits">0</td><td class="source">        console.log('find one user image');</td></tr><tr class="miss"><td class="line">139</td><td class="hits">0</td><td class="source">        console.log(result);</td></tr><tr class="miss"><td class="line">140</td><td class="hits">0</td><td class="source">        findOneUserImageCallback(err ? err : null, result);</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">144</td><td class="hits">0</td><td class="source">    function saveImage(result, saveImageCallback) {</td></tr><tr class="miss"><td class="line">145</td><td class="hits">0</td><td class="source">      if (result !== null) {</td></tr><tr class="miss"><td class="line">146</td><td class="hits">0</td><td class="source">        console.log('save image...');</td></tr><tr class="miss"><td class="line">147</td><td class="hits">0</td><td class="source">        console.log(result);</td></tr><tr class="miss"><td class="line">148</td><td class="hits">0</td><td class="source">        result.profileImage = false;</td></tr><tr class="miss"><td class="line">149</td><td class="hits">0</td><td class="source">        result.save(function(err) {</td></tr><tr class="miss"><td class="line">150</td><td class="hits">0</td><td class="source">          console.log('save done...');</td></tr><tr class="miss"><td class="line">151</td><td class="hits">0</td><td class="source">          console.log(err);</td></tr><tr class="miss"><td class="line">152</td><td class="hits">0</td><td class="source">          console.log('find one image');</td></tr><tr class="miss"><td class="line">153</td><td class="hits">0</td><td class="source">          console.log(req.params.imageId);</td></tr><tr class="miss"><td class="line">154</td><td class="hits">0</td><td class="source">          Images.findOne({</td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source">            '_id': req.params.imageId</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source">          }, function(err, doProfile) {</td></tr><tr class="miss"><td class="line">157</td><td class="hits">0</td><td class="source">            saveImageCallback(err ? err : null, doProfile);</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source">          });</td></tr><tr><td class="line">159</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="miss"><td class="line">161</td><td class="hits">0</td><td class="source">        console.log('error ?????????????????????????');</td></tr><tr class="miss"><td class="line">162</td><td class="hits">0</td><td class="source">        saveImageCallback(null);</td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">166</td><td class="hits">0</td><td class="source">    function saveOneProfileUserImage(doProfile, saveOneProfileUserImageCallback) {</td></tr><tr class="miss"><td class="line">167</td><td class="hits">0</td><td class="source">      console.log('save one profileImage');</td></tr><tr class="miss"><td class="line">168</td><td class="hits">0</td><td class="source">      console.log(doProfile);</td></tr><tr class="miss"><td class="line">169</td><td class="hits">0</td><td class="source">      User.findOne({'_id': req.user._id}).exec(function(err, result) {</td></tr><tr class="miss"><td class="line">170</td><td class="hits">0</td><td class="source">        console.log(req.params.imageName);</td></tr><tr class="miss"><td class="line">171</td><td class="hits">0</td><td class="source">        result.profileImage = req.params.imageName;</td></tr><tr class="miss"><td class="line">172</td><td class="hits">0</td><td class="source">        result.save(function(err, res) {</td></tr><tr class="miss"><td class="line">173</td><td class="hits">0</td><td class="source">          if (err) {</td></tr><tr class="miss"><td class="line">174</td><td class="hits">0</td><td class="source">            saveOneProfileUserImageCallback(err);</td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source">          } else {</td></tr><tr class="miss"><td class="line">176</td><td class="hits">0</td><td class="source">            ES.index({</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">              index: 'user',</td></tr><tr><td class="line">178</td><td class="hits"></td><td class="source">              type: 'usr',</td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source">              id: res._id.toHexString(),</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source">              body: {</td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source">                username: res.username,</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source">                profileImage: req.params.imageName</td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source">              }</td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source">            }, function (error, response) {</td></tr><tr class="miss"><td class="line">185</td><td class="hits">0</td><td class="source">                console.log('put in elasticsearch');</td></tr><tr class="miss"><td class="line">186</td><td class="hits">0</td><td class="source">                console.log(error);</td></tr><tr class="miss"><td class="line">187</td><td class="hits">0</td><td class="source">                doProfile.profileImage = true;</td></tr><tr class="miss"><td class="line">188</td><td class="hits">0</td><td class="source">                doProfile.save(function(err, response) {</td></tr><tr class="miss"><td class="line">189</td><td class="hits">0</td><td class="source">                  saveOneProfileUserImageCallback(err ? err : null);</td></tr><tr><td class="line">190</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">191</td><td class="hits"></td><td class="source">              });</td></tr><tr><td class="line">192</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">193</td><td class="hits"></td><td class="source">          });</td></tr><tr><td class="line">194</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">195</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">196</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">197</td><td class="hits"></td><td class="source">    // Faire une promise</td></tr><tr class="miss"><td class="line">198</td><td class="hits">0</td><td class="source">    async.waterfall([</td></tr><tr><td class="line">199</td><td class="hits"></td><td class="source">      findOneUserImage,</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source">      saveImage,</td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source">      saveOneProfileUserImage</td></tr><tr><td class="line">202</td><td class="hits"></td><td class="source">    ], function(error) {</td></tr><tr class="miss"><td class="line">203</td><td class="hits">0</td><td class="source">      console.log('test error');</td></tr><tr class="miss"><td class="line">204</td><td class="hits">0</td><td class="source">      console.log(error);</td></tr><tr class="miss"><td class="line">205</td><td class="hits">0</td><td class="source">      res.status(error ? 400 : 200).json(error ? error : null);</td></tr><tr><td class="line">206</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">207</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">208</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">209</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/home/lemelon/EIPmaster/newapp/backend/controllers/session/sessionCtrl.js">/home/lemelon/EIPmaster/newapp/backend/controllers/session/sessionCtrl.js</h2><div id="stats" class="medium"><div class="percentage">65%</div><div class="sloc">66</div><div class="hits">43</div><div class="misses">23</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">// MODULE DEPENDENCIES //////////////////////////////////////////</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">/////////////////////////////////////////////////////////////////</td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">var mongoose = require('mongoose');</td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">var User     = mongoose.model('User');</td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">var passport = require('passport');</td></tr><tr class="hit"><td class="line">7</td><td class="hits">1</td><td class="source">var async    = require('async');</td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">var moment   = require('moment');</td></tr><tr class="hit"><td class="line">9</td><td class="hits">1</td><td class="source">var elasticsearch = require('elasticsearch');</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">if (process.env.NODE_ENV === 'production') {</td></tr><tr class="miss"><td class="line">12</td><td class="hits">0</td><td class="source">  var ES = new elasticsearch.Client({</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">    host: &quot;http://paas:f669a84c8a68e09959b4e8e88df26bf5@dwalin-us-east-1.searchly.com&quot;</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">} else {</td></tr><tr class="hit"><td class="line">16</td><td class="hits">1</td><td class="source">  var ES = new elasticsearch.Client({</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">    host: &quot;localhost:9200&quot;</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">22</td><td class="hits">1</td><td class="source">module.exports = {</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">  // LOGOUT ///////////////////////////////////////////////////////</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">  logout: function(req, res) {</td></tr><tr class="miss"><td class="line">28</td><td class="hits">0</td><td class="source">    console.log('******************logout******************');</td></tr><tr class="miss"><td class="line">29</td><td class="hits">0</td><td class="source">    var incomingToken = req.headers['auth-token'];</td></tr><tr class="miss"><td class="line">30</td><td class="hits">0</td><td class="source">    if (incomingToken) {</td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="source">      var decoded = User.decode(incomingToken);</td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="source">      if (decoded.email) {</td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="source">        var decodeUser = decoded.email;</td></tr><tr class="miss"><td class="line">34</td><td class="hits">0</td><td class="source">        User.invalidateUserToken(decodeUser,</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">          function(err, user) {</td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="source">            res.status(err ? 400 : 200).json(err ?</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">              {err: 'Issue finding user.'} :</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">              true);</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">          });</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="source">        res.status(400).json({error: 'Issue decoding incoming token.'});</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">  // AUTHENTICATE /////////////////////////////////////////////////</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">  passportAuthenticate: function(req, res, next) {</td></tr><tr class="hit"><td class="line">50</td><td class="hits">3</td><td class="source">    console.log('authentification');</td></tr><tr class="hit"><td class="line">51</td><td class="hits">3</td><td class="source">    console.log(req.body);</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">  </td></tr><tr class="hit"><td class="line">53</td><td class="hits">3</td><td class="source">    User.authenticate()(req.body.email, req.body.password, function(err, user, message) {</td></tr><tr class="hit"><td class="line">54</td><td class="hits">3</td><td class="source">      console.log(err, user, message);</td></tr><tr class="hit"><td class="line">55</td><td class="hits">3</td><td class="source">      if (user === false) {</td></tr><tr class="hit"><td class="line">56</td><td class="hits">3</td><td class="source">        console.log(err);</td></tr><tr class="hit"><td class="line">57</td><td class="hits">3</td><td class="source">        return res.status(400).json({</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">          err: message.message</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="miss"><td class="line">61</td><td class="hits">0</td><td class="source">        console.log('user === true');</td></tr><tr class="miss"><td class="line">62</td><td class="hits">0</td><td class="source">        console.log(user);</td></tr><tr class="miss"><td class="line">63</td><td class="hits">0</td><td class="source">        req.user = user;</td></tr><tr class="miss"><td class="line">64</td><td class="hits">0</td><td class="source">        next();</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">  authenticate: function(req, res) {</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">71</td><td class="hits">0</td><td class="source">    function createToken(createTokenCallback) {</td></tr><tr class="miss"><td class="line">72</td><td class="hits">0</td><td class="source">      User.createUserToken(req.user.email, function(err, userToken) {</td></tr><tr class="miss"><td class="line">73</td><td class="hits">0</td><td class="source">        createTokenCallback(err ? err : null, userToken);</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">78</td><td class="hits">0</td><td class="source">    function getToken(userToken, getTokenCallback) {</td></tr><tr class="miss"><td class="line">79</td><td class="hits">0</td><td class="source">      User.getUserToken(req.user.email, userToken, function(err, user) {</td></tr><tr class="miss"><td class="line">80</td><td class="hits">0</td><td class="source">        getTokenCallback(err ? err : null, user);</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">    // Faire une promise</td></tr><tr class="miss"><td class="line">86</td><td class="hits">0</td><td class="source">    async.waterfall([createToken, getToken], function(error, result) {</td></tr><tr class="miss"><td class="line">87</td><td class="hits">0</td><td class="source">      console.log(result);</td></tr><tr class="miss"><td class="line">88</td><td class="hits">0</td><td class="source">      res.status(error ? 400 : 200).json(error ? error : {</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">        _id: result._id,</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">        email: result.email,</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">        username: result.username,</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">        token: result.token.token,</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">        reputation: result.reputation,</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">        profileImage: result.profileImage,</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">        DATE_CREATED: result.FORMATTED_DATE</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">  // REGISTER /////////////////////////////////////////////////////</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">  register: function(req, res, next) {</td></tr><tr class="hit"><td class="line">104</td><td class="hits">6</td><td class="source">    console.log('**********************Register***********************');</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">106</td><td class="hits">6</td><td class="source">    function registerUserMongo(registerUserMongoCallback) {</td></tr><tr class="hit"><td class="line">107</td><td class="hits">6</td><td class="source">      console.log('register user mongo');</td></tr><tr class="hit"><td class="line">108</td><td class="hits">6</td><td class="source">      console.log(req.body);</td></tr><tr class="hit"><td class="line">109</td><td class="hits">6</td><td class="source">      if (req.body.password === req.body.repeatPassword) {</td></tr><tr class="hit"><td class="line">110</td><td class="hits">4</td><td class="source">        console.log(req.body.username);</td></tr><tr class="hit"><td class="line">111</td><td class="hits">4</td><td class="source">        if (req.body.username === undefined || req.body.email === undefined) {</td></tr><tr class="hit"><td class="line">112</td><td class="hits">2</td><td class="source">          return registerUserMongoCallback('There is no username or email');</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">114</td><td class="hits">2</td><td class="source">        var user = new User({</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">          username: req.body.username,</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">          email: req.body.email,</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">          profileImage: null,</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">        });</td></tr><tr class="hit"><td class="line">119</td><td class="hits">2</td><td class="source">        User.register(user, req.body.password, function(error, result) {</td></tr><tr class="hit"><td class="line">120</td><td class="hits">2</td><td class="source">          registerUserMongoCallback(error ? error : null, result);</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="hit"><td class="line">123</td><td class="hits">2</td><td class="source">        registerUserMongoCallback('The confirm password does not match');</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">127</td><td class="hits">6</td><td class="source">    function registerUserES(user, registerUserESCallback) {</td></tr><tr class="hit"><td class="line">128</td><td class="hits">2</td><td class="source">      console.log('registerUserES');</td></tr><tr class="hit"><td class="line">129</td><td class="hits">2</td><td class="source">      console.log(user);</td></tr><tr class="hit"><td class="line">130</td><td class="hits">2</td><td class="source">      var FORMATTED_DATE;</td></tr><tr class="hit"><td class="line">131</td><td class="hits">2</td><td class="source">      ES.create({</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">        index: 'user',</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source">        type: 'usr',</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">        id: user._id.toHexString(),</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source">        body: {</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">          created: Date.now(),</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">          username: user.username,</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source">          profileImage: null</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">        }}, function(err, res) {</td></tr><tr class="hit"><td class="line">140</td><td class="hits">2</td><td class="source">          console.log(err, res);</td></tr><tr class="hit"><td class="line">141</td><td class="hits">2</td><td class="source">          registerUserESCallback(err ? err : null);</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">145</td><td class="hits">6</td><td class="source">    function createToken(createTokenCallback) {</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">147</td><td class="hits">2</td><td class="source">      User.createUserToken(req.body.email, function(err, usersToken) {</td></tr><tr class="hit"><td class="line">148</td><td class="hits">2</td><td class="source">        createTokenCallback(err ? err : null, usersToken);</td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">153</td><td class="hits">6</td><td class="source">    function getToken(usersToken, getTokenCallback) {</td></tr><tr class="hit"><td class="line">154</td><td class="hits">2</td><td class="source">      User.getUserToken(req.body.email, usersToken, function(err, user) {</td></tr><tr class="hit"><td class="line">155</td><td class="hits">2</td><td class="source">        getTokenCallback(err ? err : null, user);</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">159</td><td class="hits"></td><td class="source">    // Faire une promise</td></tr><tr class="hit"><td class="line">160</td><td class="hits">6</td><td class="source">    async.waterfall([</td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source">      registerUserMongo,</td></tr><tr><td class="line">162</td><td class="hits"></td><td class="source">      registerUserES,</td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source">      createToken,</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source">      getToken</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source">    ], function(error, result) {</td></tr><tr class="hit"><td class="line">166</td><td class="hits">6</td><td class="source">      res.status(error ? 400 : 200).json(error ? error : {</td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source">        _id: result._id,</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source">        email: result.email,</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source">        username: result.username,</td></tr><tr><td class="line">170</td><td class="hits"></td><td class="source">        token: result.token.token,</td></tr><tr><td class="line">171</td><td class="hits"></td><td class="source">        reputation: result.reputation,</td></tr><tr><td class="line">172</td><td class="hits"></td><td class="source">        profileImage: result.profileImage,</td></tr><tr><td class="line">173</td><td class="hits"></td><td class="source">        DATE_CREATED: result.FORMATTED_DATE,</td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">176</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">178</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/home/lemelon/EIPmaster/newapp/backend/controllers/users/findCtrl.js">/home/lemelon/EIPmaster/newapp/backend/controllers/users/findCtrl.js</h2><div id="stats" class="low"><div class="percentage">42%</div><div class="sloc">35</div><div class="hits">15</div><div class="misses">20</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">// MODULE DEPENDENCIES //////////////////////////////////////////</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">/////////////////////////////////////////////////////////////////</td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">var mongoose = require('mongoose');</td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">var User     = mongoose.model('User');</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">7</td><td class="hits">1</td><td class="source">var elasticsearch = require(&quot;elasticsearch&quot;);</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">9</td><td class="hits">1</td><td class="source">if (process.env.NODE_ENV === 'production') {</td></tr><tr class="miss"><td class="line">10</td><td class="hits">0</td><td class="source">  var ES = new elasticsearch.Client({</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">    host: &quot;http://paas:f669a84c8a68e09959b4e8e88df26bf5@dwalin-us-east-1.searchly.com&quot;</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">} else {</td></tr><tr class="hit"><td class="line">14</td><td class="hits">1</td><td class="source">  var ES = new elasticsearch.Client({</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">    host: &quot;localhost:9200&quot;</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">19</td><td class="hits">1</td><td class="source">module.exports = {</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">  show: function(req, res, next) {</td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="source">    console.log('!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!');</td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="source">    var userId = req.params.id;</td></tr><tr class="miss"><td class="line">24</td><td class="hits">0</td><td class="source">    User.findById(userId, function(err, user) {</td></tr><tr class="miss"><td class="line">25</td><td class="hits">0</td><td class="source">      res.status(err ? 400 : 200).json(err ? 'Failed to load User' : user);</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">  ////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">  // SEARCH USER //////////////////////////////////////////////////</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">  search: function(req, res) {</td></tr><tr class="hit"><td class="line">33</td><td class="hits">1</td><td class="source">    console.log(req.params);</td></tr><tr class="hit"><td class="line">34</td><td class="hits">1</td><td class="source">    if (req.query.term) {</td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="source">      console.log('search');</td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="source">      var username = req.user ? req.user.username : '';</td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="source">      var search   = req.query.term.toLowerCase();</td></tr><tr class="miss"><td class="line">38</td><td class="hits">0</td><td class="source">      ES.search({</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">      index: 'user',</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">      body: {</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">        'size' : 10,</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">        'query': {</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">          'match': {</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">            'username': search</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">    }).then(function (resp) {</td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="source">      console.log(resp);</td></tr><tr class="miss"><td class="line">50</td><td class="hits">0</td><td class="source">      res.status(200).json(resp.hits.hits);</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="hit"><td class="line">53</td><td class="hits">1</td><td class="source">      res.status(200).end();</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">  // CHECK USER EXIST /////////////////////////////////////////////</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">  userExist: function(req, res) {</td></tr><tr class="hit"><td class="line">61</td><td class="hits">1</td><td class="source">    var username = req.query.u;</td></tr><tr class="hit"><td class="line">62</td><td class="hits">1</td><td class="source">    if (username) {</td></tr><tr class="miss"><td class="line">63</td><td class="hits">0</td><td class="source">      User.find({</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">        'username': username</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">      }).exec(function(err, user) {</td></tr><tr class="miss"><td class="line">66</td><td class="hits">0</td><td class="source">        setTimeout(function() {</td></tr><tr class="miss"><td class="line">67</td><td class="hits">0</td><td class="source">          var ok = !(user.length || err);</td></tr><tr class="miss"><td class="line">68</td><td class="hits">0</td><td class="source">          res.status(ok ? 200 : 400).json({</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">                ok: ok</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">          });</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">        }, 400);</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="hit"><td class="line">74</td><td class="hits">1</td><td class="source">      res.status(400).json('No username is typed');</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">  // CHECK EMAIL EXIST ////////////////////////////////////////////</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">  emailExist: function(req, res) {</td></tr><tr class="hit"><td class="line">82</td><td class="hits">1</td><td class="source">    console.log('test');</td></tr><tr class="hit"><td class="line">83</td><td class="hits">1</td><td class="source">    if (req.query.u) {</td></tr><tr class="miss"><td class="line">84</td><td class="hits">0</td><td class="source">      var email = req.query.u;</td></tr><tr class="miss"><td class="line">85</td><td class="hits">0</td><td class="source">      User.find({</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">          'email': email</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">      }).exec(function(err, user) {</td></tr><tr class="miss"><td class="line">88</td><td class="hits">0</td><td class="source">        setTimeout(function() {</td></tr><tr class="miss"><td class="line">89</td><td class="hits">0</td><td class="source">          var ok = !(user.length || err);</td></tr><tr class="miss"><td class="line">90</td><td class="hits">0</td><td class="source">          res.status(ok ? 200 : 400).json({</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">              ok: ok</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">          });</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">        }, 500);</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="hit"><td class="line">96</td><td class="hits">1</td><td class="source">      res.status(400).json('No email is typed');</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/home/lemelon/EIPmaster/newapp/backend/models/schemas/actualitySchemas/ActualityModel.js">/home/lemelon/EIPmaster/newapp/backend/models/schemas/actualitySchemas/ActualityModel.js</h2><div id="stats" class="medium"><div class="percentage">58%</div><div class="sloc">12</div><div class="hits">7</div><div class="misses">5</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var autopopulate = require('mongoose-autopopulate');</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">exports = module.exports = function(mongoose) {</td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">  var Schema = mongoose.Schema;</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">7</td><td class="hits">1</td><td class="source">  var actualitySchema = new Schema({</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">    content: String,</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">    status: Number,</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">    creator: {</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">      type: Schema.ObjectId,</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">      ref: 'User',</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">      autopopulate: true</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">    likeCreator: {</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">      type: Schema.ObjectId,</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">      ref: 'Like',</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">      autopopulate: true</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">    date: {</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">        type: Date,</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">        default: Date.now</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">    updated: [Date]</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">  // PRE SAVE /////////////////////////////////////////////////////</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr class="hit"><td class="line">30</td><td class="hits">1</td><td class="source">  actualitySchema.pre('save', function(next, req, callback) {</td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="source">    console.log('***************presave announce*****************');</td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="source">    if (this.isNew) {</td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="source">      this.created = Date.now();</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">    }</td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="source">    this.updated.push(Date.now());</td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="source">    next();</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">39</td><td class="hits">1</td><td class="source">  actualitySchema.plugin(autopopulate);</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">41</td><td class="hits">1</td><td class="source">  mongoose.model('Actuality', actualitySchema);</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/home/lemelon/EIPmaster/newapp/backend/models/schemas/actualitySchemas/StatusModel.js">/home/lemelon/EIPmaster/newapp/backend/models/schemas/actualitySchemas/StatusModel.js</h2><div id="stats" class="medium"><div class="percentage">50%</div><div class="sloc">10</div><div class="hits">5</div><div class="misses">5</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">exports = module.exports = function(mongoose) {</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">  var Schema = mongoose.Schema;</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">  var statusSchema = new Schema({</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">      content: String,</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">      author: {</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">          type: Schema.ObjectId,</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">          ref: 'User'</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">      },</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">      date: {</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">          type: Date,</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">          default: Date.now</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">      },</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">      updated: [Date]</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">  // PRE SAVE /////////////////////////////////////////////////////</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr class="hit"><td class="line">20</td><td class="hits">1</td><td class="source">  statusSchema.pre('save', function(next, req, callback) {</td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="source">    console.log('***************presave announce*****************');</td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="source">    if (this.isNew) {</td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="source">      this.created = Date.now();</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">    }</td></tr><tr class="miss"><td class="line">25</td><td class="hits">0</td><td class="source">    this.updated.push(Date.now());</td></tr><tr class="miss"><td class="line">26</td><td class="hits">0</td><td class="source">    next();</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">29</td><td class="hits">1</td><td class="source">  mongoose.model('Status', statusSchema);</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/home/lemelon/EIPmaster/newapp/backend/models/schemas/announceSchemas/AnnounceCommentModel.js">/home/lemelon/EIPmaster/newapp/backend/models/schemas/announceSchemas/AnnounceCommentModel.js</h2><div id="stats" class="low"><div class="percentage">47%</div><div class="sloc">17</div><div class="hits">8</div><div class="misses">9</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var autopopulate = require('mongoose-autopopulate');</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">exports = module.exports = function(mongoose) {</td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">  var Schema = mongoose.Schema;</td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">  var moment = require('moment');</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">7</td><td class="hits">1</td><td class="source">  var announceCommentSchema = new Schema({</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">      content: String,</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">      rating: Boolean,</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">      creator: {</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">          type: Schema.ObjectId,</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">          ref: 'User',</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">          autopopulate: true</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">      },</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">      date: {</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">          type: Date,</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">          default: Date.now</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">      },</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">      updated: [Date],</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">      FORMATTED_DATE: String,</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">      announce: {</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">          type: Schema.ObjectId,</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">          ref: 'Announce',</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">          autopopulate: true</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">  // PRE SAVE /////////////////////////////////////////////////////</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr class="hit"><td class="line">31</td><td class="hits">1</td><td class="source">  announceCommentSchema.pre('save', function(next, req, callback) {</td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="source">    console.log('***************presave announce*****************');</td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="source">    if (this.isNew) {</td></tr><tr class="miss"><td class="line">34</td><td class="hits">0</td><td class="source">      this.created        = Date.now();</td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="source">      FORMATTED_DATE      = moment(this.DATE_CREATED).format('DD/MM/YYYY, hA:mm');</td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="source">      this.FORMATTED_DATE = FORMATTED_DATE;</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">    }</td></tr><tr class="miss"><td class="line">38</td><td class="hits">0</td><td class="source">    this.updated.push(Date.now());</td></tr><tr class="miss"><td class="line">39</td><td class="hits">0</td><td class="source">    FORMATTED_DATE      = moment(this.DATE_CREATED).format('DD/MM/YYYY, hA:mm');</td></tr><tr class="miss"><td class="line">40</td><td class="hits">0</td><td class="source">    this.FORMATTED_DATE = FORMATTED_DATE;</td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="source">    next();</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">44</td><td class="hits">1</td><td class="source">  announceCommentSchema.plugin(autopopulate);</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">46</td><td class="hits">1</td><td class="source">  mongoose.model('AnnounceComment', announceCommentSchema);</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/home/lemelon/EIPmaster/newapp/backend/models/schemas/announceSchemas/AnnounceModel.js">/home/lemelon/EIPmaster/newapp/backend/models/schemas/announceSchemas/AnnounceModel.js</h2><div id="stats" class="high"><div class="percentage">79%</div><div class="sloc">48</div><div class="hits">38</div><div class="misses">10</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var Q            = require('q');</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">var moment       = require('moment');</td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">var autopopulate = require('mongoose-autopopulate');</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">var elasticsearch = require(&quot;elasticsearch&quot;);</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">7</td><td class="hits">1</td><td class="source">if (process.env.NODE_ENV === 'production') {</td></tr><tr class="miss"><td class="line">8</td><td class="hits">0</td><td class="source">  var ES = new elasticsearch.Client({</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">    host: &quot;http://paas:f669a84c8a68e09959b4e8e88df26bf5@dwalin-us-east-1.searchly.com&quot;</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">} else {</td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">  var ES = new elasticsearch.Client({</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">    host: &quot;localhost:9200&quot;</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">17</td><td class="hits">1</td><td class="source">ES.indices.create({</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">    index: &quot;announce&quot;,</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">    body: {</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">      &quot;settings&quot;: {</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">        &quot;number_of_shards&quot;: 1, </td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">        &quot;analysis&quot;: {</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">            &quot;filter&quot;: {</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">                &quot;autocomplete_filter&quot;: { </td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">                    &quot;type&quot;:     &quot;edge_ngram&quot;,</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">                    &quot;min_gram&quot;: 1,</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">                    &quot;max_gram&quot;: 20</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">            },</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">            &quot;analyzer&quot;: {</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">                &quot;autocomplete&quot;: {</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">                    &quot;type&quot;:      &quot;custom&quot;,</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">                    &quot;tokenizer&quot;: &quot;standard&quot;,</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">                    &quot;filter&quot;: [</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">                        &quot;lowercase&quot;,</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">                        &quot;autocomplete_filter&quot; </td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">                    ]</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">}, function(err,resp,respcode){</td></tr><tr class="hit"><td class="line">44</td><td class="hits">1</td><td class="source">    console.log('create index...');</td></tr><tr class="hit"><td class="line">45</td><td class="hits">1</td><td class="source">    console.log(err,resp,respcode);</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">    </td></tr><tr class="hit"><td class="line">47</td><td class="hits">1</td><td class="source">    ES.indices.putMapping({</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">      index: 'announce', </td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">      type: 'ann',</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">      body:{ 'ann': {</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">            &quot;properties&quot;: {</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">                &quot;title&quot;: {</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">                    &quot;type&quot;:     &quot;string&quot;,</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">                    &quot;analyzer&quot;: &quot;autocomplete&quot;</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">      } }, function(err, resp, respcode) {</td></tr><tr class="hit"><td class="line">59</td><td class="hits">1</td><td class="source">        console.log('put mapping...');</td></tr><tr class="hit"><td class="line">60</td><td class="hits">1</td><td class="source">        console.log(err,resp,respcode);</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">});</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">65</td><td class="hits">1</td><td class="source">exports = module.exports = function(mongoose) {</td></tr><tr class="hit"><td class="line">66</td><td class="hits">1</td><td class="source">  var Schema = mongoose.Schema;</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">68</td><td class="hits">1</td><td class="source">  announceSchema = new Schema({</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">    title: {</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">      type: String,</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">      required: true,</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">    nbComment: Number,</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">    tags: [String],</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">    type: {</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">      type: String,</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">      required: false</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">    likeCreator: {</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">      type: Schema.ObjectId,</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">      ref: 'Like'</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">    activated: Boolean,</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">    category: String,</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">    rating: {</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">      type: Number,</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">      max: 5,</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">    content: {</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">      type: String,</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">      default: '',</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">      trim: true,</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">    slug: {</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">      type: String,</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">      lowercase: true,</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">      trim: true</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">    status: {</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">      type: Number,</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">      default: 1,</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">    FORMATTED_DATE: String,</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">    created: Date,</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">    updated: [Date],</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">    timeSave: String,</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">    creator: {</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">      type: Schema.ObjectId,</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">      ref: 'User',</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">      autopopulate: true</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">    price: {</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source">      type: Number,</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">      min : 1,</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">  // PRE SAVE /////////////////////////////////////////////////////</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr class="hit"><td class="line">120</td><td class="hits">1</td><td class="source">  announceSchema.pre('save', function(next, req, callback) {</td></tr><tr class="hit"><td class="line">121</td><td class="hits">1</td><td class="source">    console.log('***************presave announce*****************');</td></tr><tr class="hit"><td class="line">122</td><td class="hits">1</td><td class="source">    var FORMATTED_DATE;</td></tr><tr class="hit"><td class="line">123</td><td class="hits">1</td><td class="source">    if (this.isNew) {</td></tr><tr class="hit"><td class="line">124</td><td class="hits">1</td><td class="source">      this.created        = Date.now();</td></tr><tr class="hit"><td class="line">125</td><td class="hits">1</td><td class="source">      FORMATTED_DATE      = moment(this.DATE_CREATED).format('DD/MM/YYYY, hA:mm');</td></tr><tr class="hit"><td class="line">126</td><td class="hits">1</td><td class="source">      this.FORMATTED_DATE = FORMATTED_DATE;</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">128</td><td class="hits">1</td><td class="source">    this.updated.push(Date.now());</td></tr><tr class="hit"><td class="line">129</td><td class="hits">1</td><td class="source">    FORMATTED_DATE      = moment(this.DATE_CREATED).format('DD/MM/YYYY, hA:mm');</td></tr><tr class="hit"><td class="line">130</td><td class="hits">1</td><td class="source">    this.FORMATTED_DATE = FORMATTED_DATE;</td></tr><tr class="hit"><td class="line">131</td><td class="hits">1</td><td class="source">    next();</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source">  // STATICS //////////////////////////////////////////////////////</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr class="hit"><td class="line">137</td><td class="hits">1</td><td class="source">  announceSchema.statics = {</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">    organizeAnnounceData: function(announce, cb) {</td></tr><tr class="miss"><td class="line">140</td><td class="hits">0</td><td class="source">      var username     = announce.creator ?</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">      announce.creator.username :</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source">      announce.creatorUsername.username;</td></tr><tr class="miss"><td class="line">143</td><td class="hits">0</td><td class="source">      var creatorId    = announce.creator ?</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">      announce.creator :</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">      announce.creatorUsername;</td></tr><tr class="miss"><td class="line">146</td><td class="hits">0</td><td class="source">      var profileImage = announce.creator ?</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source">      announce.creator.profileImage :</td></tr><tr><td class="line">148</td><td class="hits"></td><td class="source">      announce.creatorUsername.profileImage;</td></tr><tr class="miss"><td class="line">149</td><td class="hits">0</td><td class="source">      var announcePost = {</td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source">        _id: announce._id,</td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source">        created: announce.created,</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source">        creator: {</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source">            _id: creatorId,</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source">            username: username,</td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source">            profileImage: profileImage</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source">        title: announce.title,</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source">        category: announce.category,</td></tr><tr><td class="line">159</td><td class="hits"></td><td class="source">        type: announce.type,</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source">        slug: announce.slug,</td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source">        __v: announce.__v,</td></tr><tr><td class="line">162</td><td class="hits"></td><td class="source">        updated: announce.updated,</td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source">        content: announce.content,</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source">        rating: announce.rating,</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source">        status: announce.status,</td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source">        price: announce.price,</td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source">        activated: announce.activated,</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source">        tags: announce.tags</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source">      };</td></tr><tr class="miss"><td class="line">170</td><td class="hits">0</td><td class="source">      return cb(announcePost);</td></tr><tr><td class="line">171</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">172</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">173</td><td class="hits"></td><td class="source">    findByTitle: function(title, callback) {</td></tr><tr class="miss"><td class="line">174</td><td class="hits">0</td><td class="source">      console.log('find annonce by title');</td></tr><tr class="miss"><td class="line">175</td><td class="hits">0</td><td class="source">      return this.find({</td></tr><tr><td class="line">176</td><td class="hits"></td><td class="source">        title: title</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">      }, callback);</td></tr><tr><td class="line">178</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source">   * Methods</td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">184</td><td class="hits">1</td><td class="source">  announceSchema.methods.expressiveQuery = function(creator, date, callback) {</td></tr><tr class="miss"><td class="line">185</td><td class="hits">0</td><td class="source">    console.log('-----------expressiveQuery------------------');</td></tr><tr class="miss"><td class="line">186</td><td class="hits">0</td><td class="source">    return this.find('creator', creator).where('date').gte(date).run(callback);</td></tr><tr><td class="line">187</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">189</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">190</td><td class="hits"></td><td class="source">  // PLUGINS //////////////////////////////////////////////////////</td></tr><tr><td class="line">191</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr class="hit"><td class="line">192</td><td class="hits">1</td><td class="source">  function slugGenerator(options) {</td></tr><tr class="hit"><td class="line">193</td><td class="hits">1</td><td class="source">    options = options || {};</td></tr><tr class="hit"><td class="line">194</td><td class="hits">1</td><td class="source">    var key = options.key || 'title';</td></tr><tr><td class="line">195</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">196</td><td class="hits">1</td><td class="source">    return function slugGenerator(schema) {</td></tr><tr class="hit"><td class="line">197</td><td class="hits">1</td><td class="source">      schema.path(key).set(function(v) {</td></tr><tr class="hit"><td class="line">198</td><td class="hits">1</td><td class="source">        this.slug = v.toLowerCase().replace(/[^a-z0-9]/g, '').replace(/-+/g, '');</td></tr><tr class="hit"><td class="line">199</td><td class="hits">1</td><td class="source">        return v;</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">202</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">203</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">205</td><td class="hits">1</td><td class="source">  announceSchema.plugin(slugGenerator());</td></tr><tr><td class="line">206</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">207</td><td class="hits">1</td><td class="source">  announceSchema.plugin(autopopulate);</td></tr><tr><td class="line">208</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">209</td><td class="hits"></td><td class="source">  // create the model for announce and expose it to our app ///////</td></tr><tr><td class="line">210</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr class="hit"><td class="line">211</td><td class="hits">1</td><td class="source">  mongoose.model('Announce', announceSchema);</td></tr><tr><td class="line">212</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">213</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/home/lemelon/EIPmaster/newapp/backend/models/schemas/announceSchemas/CategoryModel.js">/home/lemelon/EIPmaster/newapp/backend/models/schemas/announceSchemas/CategoryModel.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">4</div><div class="hits">4</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">exports = module.exports = function(mongoose) {</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">  var Schema = mongoose.Schema;</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">  var categorySchema = new Schema({</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">      title: String,</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">  // create the model for category and expose it to our app ///////</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">  mongoose.model('Category', categorySchema);</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/home/lemelon/EIPmaster/newapp/backend/models/schemas/chatSchemas/MessageModel.js">/home/lemelon/EIPmaster/newapp/backend/models/schemas/chatSchemas/MessageModel.js</h2><div id="stats" class="medium"><div class="percentage">59%</div><div class="sloc">22</div><div class="hits">13</div><div class="misses">9</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">exports = module.exports = function(mongoose) {</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">  var Schema = mongoose.Schema;</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">  var messageSchema = new Schema({</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">      type: {</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">          type: String,</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">          required: false</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">      },</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">      user: {</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        type: String,</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        default: '',</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        trim: true</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">      },</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">      content: {</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">          type: String,</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">          default: '',</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">          trim: true</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">      },</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">      slug: {</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">          type: String,</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">          lowercase: true,</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">          trim: true</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">      },</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">      created: Date,</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">      updated: [Date],</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">      roomCreator: {</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">          type: Schema.ObjectId,</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">          ref: 'Room'</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">      },</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">      userRec: {</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">          type: String</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">      },</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">  // PRE SAVE /////////////////////////////////////////////////////</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr class="hit"><td class="line">39</td><td class="hits">1</td><td class="source">  messageSchema.pre('save', function(next, done) {</td></tr><tr class="miss"><td class="line">40</td><td class="hits">0</td><td class="source">    console.log('_________________presave message____________________');</td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="source">    if (this.isNew) {</td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="source">      this.created = Date.now();</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">    }</td></tr><tr class="miss"><td class="line">44</td><td class="hits">0</td><td class="source">    this.updated.push(Date.now());</td></tr><tr class="miss"><td class="line">45</td><td class="hits">0</td><td class="source">    next();</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">  // STATICS //////////////////////////////////////////////////////</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr class="hit"><td class="line">51</td><td class="hits">1</td><td class="source">  messageSchema.statics = {</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">    findByContent: function(content, callback) {</td></tr><tr class="miss"><td class="line">54</td><td class="hits">0</td><td class="source">      return this.find({</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">          content: content</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">      }, callback);</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">  // METHODS //////////////////////////////////////////////////////</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr class="hit"><td class="line">63</td><td class="hits">1</td><td class="source">  messageSchema.methods.expressiveQuery = function(creator, date, callback) {</td></tr><tr class="miss"><td class="line">64</td><td class="hits">0</td><td class="source">    return this.find('creator', creator).where('date').gte(date).run(callback);</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">  // PLUGINS //////////////////////////////////////////////////////</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr class="hit"><td class="line">70</td><td class="hits">1</td><td class="source">  function slugGenerator(options) {</td></tr><tr class="hit"><td class="line">71</td><td class="hits">1</td><td class="source">    options = options || {};</td></tr><tr class="hit"><td class="line">72</td><td class="hits">1</td><td class="source">    var key = options.key || 'content';</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">74</td><td class="hits">1</td><td class="source">    return function slugGenerator(schema) {</td></tr><tr class="hit"><td class="line">75</td><td class="hits">1</td><td class="source">      schema.path(key).set(function(v) {</td></tr><tr class="miss"><td class="line">76</td><td class="hits">0</td><td class="source">        this.slug = v.toLowerCase().replace(/[^a-z0-9]/g, '').replace(/-+/g, '');</td></tr><tr class="miss"><td class="line">77</td><td class="hits">0</td><td class="source">        return v;</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">82</td><td class="hits">1</td><td class="source">  messageSchema.plugin(slugGenerator());</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">  // create the model for message and expose it to our app ///////</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr class="hit"><td class="line">87</td><td class="hits">1</td><td class="source">  mongoose.model('Message', messageSchema);</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/home/lemelon/EIPmaster/newapp/backend/models/schemas/chatSchemas/RoomModel.js">/home/lemelon/EIPmaster/newapp/backend/models/schemas/chatSchemas/RoomModel.js</h2><div id="stats" class="low"><div class="percentage">41%</div><div class="sloc">17</div><div class="hits">7</div><div class="misses">10</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">exports = module.exports = function(mongoose) {</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">  var Schema = mongoose.Schema;</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">  var roomSchema = new Schema({</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">    name: {</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">      type: String,</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">      index: true,</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">      required: true,</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">      unique: true</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">    people: [String],</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">    created: Date,</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">    updated: [Date],</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">  // PRE SAVE /////////////////////////////////////////////////////</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr class="hit"><td class="line">20</td><td class="hits">1</td><td class="source">  roomSchema.pre('save', function(next, done) {</td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="source">    console.log('***************presave room*****************');</td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="source">    if (this.isNew) {</td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="source">      this.created = Date.now();</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">    }</td></tr><tr class="miss"><td class="line">25</td><td class="hits">0</td><td class="source">    this.updated.push(Date.now());</td></tr><tr class="miss"><td class="line">26</td><td class="hits">0</td><td class="source">    next();</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">   * Statics</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">32</td><td class="hits">1</td><td class="source">  roomSchema.statics = {</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">    load: function(id, cb) {</td></tr><tr class="miss"><td class="line">34</td><td class="hits">0</td><td class="source">      console.log('*****************load room******************');</td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="source">      this.findOne({</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">          _id: id</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">      }).populate('creator').exec(cb);</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">    findByTitle: function(title, callback) {</td></tr><tr class="miss"><td class="line">40</td><td class="hits">0</td><td class="source">      console.log('find room by title');</td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="source">      return this.find({</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">          title: title</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">      }, callback);</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">   * Methods</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">50</td><td class="hits">1</td><td class="source">  roomSchema.methods.expressiveQuery = function(creator, date, callback) {</td></tr><tr class="miss"><td class="line">51</td><td class="hits">0</td><td class="source">    return this.find('creator', creator).where('date').gte(date).run(callback);</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">  // create the model for room and expose it to our app ///////</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr class="hit"><td class="line">57</td><td class="hits">1</td><td class="source">  mongoose.model('Room', roomSchema);</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/home/lemelon/EIPmaster/newapp/backend/models/schemas/notificationSchemas/FriendModel.js">/home/lemelon/EIPmaster/newapp/backend/models/schemas/notificationSchemas/FriendModel.js</h2><div id="stats" class="low"><div class="percentage">26%</div><div class="sloc">23</div><div class="hits">6</div><div class="misses">17</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">exports = module.exports = function(mongoose) {</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">  var Schema = mongoose.Schema;</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">  var friendSchema = new Schema({</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">    usernameWaitFriendRequest: {</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        type: String,</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        index: true,</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        required: false</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">    usernameAcceptedFriendRequest: {</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        type: String,</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        index: true,</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        required: false</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">    DATE_CREATED: {</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">        type: Date,</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">        default: Date.now</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">    creator: {</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">        type: Schema.ObjectId,</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">        ref: 'User'</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">    created: Date,</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    updated: [Date],</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">    slug: {</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">        type: String,</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">        lowercase: true,</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">        trim: true</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">   * Pre hook.</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">36</td><td class="hits">1</td><td class="source">  friendSchema.pre('save', function(next, done) {</td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="source">    console.log('***************presave friend*****************');</td></tr><tr class="miss"><td class="line">38</td><td class="hits">0</td><td class="source">    if (this.isNew) {</td></tr><tr class="miss"><td class="line">39</td><td class="hits">0</td><td class="source">      this.created = Date.now();</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">    }</td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="source">    this.updated.push(Date.now());</td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="source">    next();</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">   * Statics</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">48</td><td class="hits">1</td><td class="source">  friendSchema.statics = {</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">    load: function(id, cb) {</td></tr><tr class="miss"><td class="line">50</td><td class="hits">0</td><td class="source">      console.log('*****************load friend******************');</td></tr><tr class="miss"><td class="line">51</td><td class="hits">0</td><td class="source">      console.log(id);</td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="source">      this.findOne({</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">          _id: id</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">      }).populate('creator').exec(cb);</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">    saveFriend: function(idUser, username, cb) {</td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="source">      console.log(idUser);</td></tr><tr class="miss"><td class="line">58</td><td class="hits">0</td><td class="source">      this.findOneAndUpdate({</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">        $and: [</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">        {creator: idUser},</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">        {usernameWaitFriendRequest: username}</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">        ]</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">      }, {</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">        usernameAcceptedFriendRequest: username,</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">      }, {upsert: true}).exec(function(err, userOne) {</td></tr><tr class="miss"><td class="line">66</td><td class="hits">0</td><td class="source">        if (err) {</td></tr><tr class="miss"><td class="line">67</td><td class="hits">0</td><td class="source">          return cb(err);</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="miss"><td class="line">69</td><td class="hits">0</td><td class="source">          return cb(null);</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">    testIfFriendRequestDone: function(userId, cb) {</td></tr><tr class="miss"><td class="line">75</td><td class="hits">0</td><td class="source">      this.findOne({</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">        creator: userId</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">      }).exec(function(err, result) {</td></tr><tr class="miss"><td class="line">78</td><td class="hits">0</td><td class="source">        if (result &amp;&amp; result.length &gt; 0) {</td></tr><tr class="miss"><td class="line">79</td><td class="hits">0</td><td class="source">          return cb(false);</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="miss"><td class="line">81</td><td class="hits">0</td><td class="source">          return cb(true);</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">87</td><td class="hits">1</td><td class="source">  mongoose.model('Friend', friendSchema);</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/home/lemelon/EIPmaster/newapp/backend/models/schemas/notificationSchemas/NotificationModel.js">/home/lemelon/EIPmaster/newapp/backend/models/schemas/notificationSchemas/NotificationModel.js</h2><div id="stats" class="low"><div class="percentage">30%</div><div class="sloc">20</div><div class="hits">6</div><div class="misses">14</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">exports = module.exports = function(mongoose) {</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">  var Schema = mongoose.Schema;</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">  var notificationSchema = new Schema({</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">    userRec: String,</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">    userDes: String,</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">    userId: String,</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">    type: String,</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">    DATE_CREATED: {</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        type: Date,</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        default: Date.now</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">    creator: {</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        type: Schema.ObjectId,</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        ref: 'User'</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">    created: Date,</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">    updated: [Date],</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">    slug: {</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">        type: String,</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">        lowercase: true,</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">        trim: true</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">   * Pre hook.</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">30</td><td class="hits">1</td><td class="source">  notificationSchema.pre('save', function(next, done) {</td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="source">    console.log('***************presave friend*****************');</td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="source">    if (this.isNew) {</td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="source">      this.created = Date.now();</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">    }</td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="source">    this.updated.push(Date.now());</td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="source">    next();</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">   * Statics</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">42</td><td class="hits">1</td><td class="source">  notificationSchema.statics = {</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">    load: function(id, cb) {</td></tr><tr class="miss"><td class="line">44</td><td class="hits">0</td><td class="source">      console.log('*****************load notification******************');</td></tr><tr class="miss"><td class="line">45</td><td class="hits">0</td><td class="source">      this.findOne({</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">          _id: id</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">      }).populate('creator').exec(cb);</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">    findUserNotifications : function(user, cb) {</td></tr><tr class="miss"><td class="line">51</td><td class="hits">0</td><td class="source">      var sendNotifications = [];</td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="source">      this.find(user)</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">        .sort('-created')</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">        .populate('creator')</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">        .exec(function(err, notifications) {</td></tr><tr class="miss"><td class="line">56</td><td class="hits">0</td><td class="source">          if (err) {</td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="source">            cb(err, null);</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">          } else {</td></tr><tr class="miss"><td class="line">59</td><td class="hits">0</td><td class="source">            notifications.forEach(function(item) {</td></tr><tr class="miss"><td class="line">60</td><td class="hits">0</td><td class="source">              sendNotifications.push({</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">                userDes: item.userDes,</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">                userRec : item.userRec,</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">                userId: item.userId,</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">                id: item._id,</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">                type: item.type</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">              });</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">            });</td></tr><tr class="miss"><td class="line">68</td><td class="hits">0</td><td class="source">            cb(false, sendNotifications);</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">74</td><td class="hits">1</td><td class="source">  mongoose.model('Notification', notificationSchema);</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/home/lemelon/EIPmaster/newapp/backend/models/schemas/userSchemas/ImageModel.js">/home/lemelon/EIPmaster/newapp/backend/models/schemas/userSchemas/ImageModel.js</h2><div id="stats" class="medium"><div class="percentage">58%</div><div class="sloc">12</div><div class="hits">7</div><div class="misses">5</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var autopopulate = require('mongoose-autopopulate');</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">exports = module.exports = function(mongoose) {</td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">  var Schema = mongoose.Schema;</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">  var imageSchema = new Schema({</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">      name: String,</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">      profileImage: Boolean,</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">      date: {</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">          type: Date,</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">          default: Date.now</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">      },</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">      updated: [Date],</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">      creator: {</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        type: Schema.ObjectId,</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        ref:'User',</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">        autopopulate: true</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">  // PRE SAVE /////////////////////////////////////////////////////</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">  /////////////////////////////////////////////////////////////////</td></tr><tr class="hit"><td class="line">24</td><td class="hits">1</td><td class="source">  imageSchema.pre('save', function(next, req, callback) {</td></tr><tr class="miss"><td class="line">25</td><td class="hits">0</td><td class="source">    console.log('***************presave image*****************');</td></tr><tr class="miss"><td class="line">26</td><td class="hits">0</td><td class="source">    if (this.isNew) {</td></tr><tr class="miss"><td class="line">27</td><td class="hits">0</td><td class="source">      this.created = Date.now();</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">    }</td></tr><tr class="miss"><td class="line">29</td><td class="hits">0</td><td class="source">    this.updated.push(Date.now());</td></tr><tr class="miss"><td class="line">30</td><td class="hits">0</td><td class="source">    next();</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">33</td><td class="hits">1</td><td class="source">  imageSchema.plugin(autopopulate);</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">35</td><td class="hits">1</td><td class="source">  mongoose.model('Image', imageSchema);</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/home/lemelon/EIPmaster/newapp/backend/models/schemas/userSchemas/TokenModel.js">/home/lemelon/EIPmaster/newapp/backend/models/schemas/userSchemas/TokenModel.js</h2><div id="stats" class="medium"><div class="percentage">66%</div><div class="sloc">9</div><div class="hits">6</div><div class="misses">3</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">exports = module.exports = function(mongoose) {</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">  var Schema = mongoose.Schema;</td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">  var config = require('../../../db/database.js');</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">  var TokenSchema = new Schema({</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">    token: {</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        type: String</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">    DATE_CREATED: {</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        type: Date,</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        default: Date.now</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">16</td><td class="hits">1</td><td class="source">  TokenSchema.statics.hasExpired = function(created) {</td></tr><tr class="miss"><td class="line">17</td><td class="hits">0</td><td class="source">    var now  = new Date();</td></tr><tr class="miss"><td class="line">18</td><td class="hits">0</td><td class="source">    var diff = (now.getTime() - created);</td></tr><tr class="miss"><td class="line">19</td><td class="hits">0</td><td class="source">    return diff &gt; config.ttl;</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">22</td><td class="hits">1</td><td class="source">  var TokenModel = mongoose.model('Token', TokenSchema);</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/home/lemelon/EIPmaster/newapp/backend/models/schemas/userSchemas/UserModel.js">/home/lemelon/EIPmaster/newapp/backend/models/schemas/userSchemas/UserModel.js</h2><div id="stats" class="medium"><div class="percentage">55%</div><div class="sloc">85</div><div class="hits">47</div><div class="misses">38</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var elasticsearch = require('elasticsearch');</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">exports = module.exports = function(mongoose) {</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">  if (process.env.NODE_ENV === 'production') {</td></tr><tr class="miss"><td class="line">6</td><td class="hits">0</td><td class="source">    var ES = new elasticsearch.Client({</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">      host: &quot;http://paas:f669a84c8a68e09959b4e8e88df26bf5@dwalin-us-east-1.searchly.com&quot;</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">  } else {</td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">    var ES = new elasticsearch.Client({</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">      host: &quot;localhost:9200&quot;</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">15</td><td class="hits">1</td><td class="source">  ES.indices.create({</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">    index: &quot;user&quot;,</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">    body: {</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">      &quot;settings&quot;: {</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">        &quot;number_of_shards&quot;: 1, </td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">        &quot;analysis&quot;: {</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">            &quot;filter&quot;: {</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">                &quot;autocomplete_filter&quot;: { </td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">                    &quot;type&quot;:     &quot;edge_ngram&quot;,</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">                    &quot;min_gram&quot;: 1,</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">                    &quot;max_gram&quot;: 20</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">            },</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">            &quot;analyzer&quot;: {</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">                &quot;autocomplete&quot;: {</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">                    &quot;type&quot;:      &quot;custom&quot;,</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">                    &quot;tokenizer&quot;: &quot;standard&quot;,</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">                    &quot;filter&quot;: [</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">                        &quot;lowercase&quot;,</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">                        &quot;autocomplete_filter&quot; </td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">                    ]</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">}, function(err,resp,respcode){</td></tr><tr class="hit"><td class="line">42</td><td class="hits">1</td><td class="source">    console.log('create index...');</td></tr><tr class="hit"><td class="line">43</td><td class="hits">1</td><td class="source">    console.log(err,resp,respcode);</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">    </td></tr><tr class="hit"><td class="line">45</td><td class="hits">1</td><td class="source">    ES.indices.putMapping({</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">      index: 'user', </td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">      type: 'usr',</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">      body:{ 'usr': {</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">            &quot;properties&quot;: {</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">                &quot;username&quot;: {</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">                    &quot;type&quot;:     &quot;string&quot;,</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">                    &quot;analyzer&quot;: &quot;autocomplete&quot;</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">      } }, function(err, resp, respcode) {</td></tr><tr class="hit"><td class="line">57</td><td class="hits">1</td><td class="source">        console.log('put mapping...');</td></tr><tr class="hit"><td class="line">58</td><td class="hits">1</td><td class="source">        console.log(err,resp,respcode);</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">});</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">  /*</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">   * Module dependencies</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">65</td><td class="hits">1</td><td class="source">  var Schema                = mongoose.Schema;</td></tr><tr class="hit"><td class="line">66</td><td class="hits">1</td><td class="source">  var Token                 = mongoose.model('Token');</td></tr><tr class="hit"><td class="line">67</td><td class="hits">1</td><td class="source">  var moment                = require('moment');</td></tr><tr class="hit"><td class="line">68</td><td class="hits">1</td><td class="source">  var jwt                   = require('jwt-simple');</td></tr><tr class="hit"><td class="line">69</td><td class="hits">1</td><td class="source">  var passportLocalMongoose = require('passport-local-mongoose');</td></tr><tr class="hit"><td class="line">70</td><td class="hits">1</td><td class="source">  var tokenSecret           = 'bloc';</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">72</td><td class="hits">1</td><td class="source">  var UserSchema = new Schema({</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">    email: {</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">      type: String,</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">      lowercase: true,</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">      unique: true,</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">      sparse: true,</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">      index: {</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">        unique: true</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">    anonymUsername: String,</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">    token: {</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">      type: Object</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">    username: {</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">      type: String,</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">      unique: true,</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">      sparse: true,</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">    password: String,</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">    DATE_CREATE: {</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">      type: Date,</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">      default: Date.now</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">    reputation: {</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">      type: Number,</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">      max: 5</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">    profileImage: {</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">      type: String</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">    salt: String,</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">    guest: Boolean,</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">    provider: String,</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">    locked: Boolean,</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">    money: {</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">      type: Number,</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">      min:0</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">    created: Date,</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">    FORMATTED_DATE: Date</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">115</td><td class="hits">1</td><td class="source">  UserSchema.statics = {</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">    createUserToken: function(email, cb) {</td></tr><tr class="hit"><td class="line">118</td><td class="hits">2</td><td class="source">      var self = this;</td></tr><tr class="hit"><td class="line">119</td><td class="hits">2</td><td class="source">      this.findOne({email: email}, function(err, usr) {</td></tr><tr class="hit"><td class="line">120</td><td class="hits">2</td><td class="source">        if (err || !usr) {</td></tr><tr class="miss"><td class="line">121</td><td class="hits">0</td><td class="source">          console.log('err');</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">123</td><td class="hits">2</td><td class="source">        var token = self.encode({email: email});</td></tr><tr class="hit"><td class="line">124</td><td class="hits">2</td><td class="source">        usr.token = new Token({token:token});</td></tr><tr class="hit"><td class="line">125</td><td class="hits">2</td><td class="source">        usr.save(function(err, usr) {</td></tr><tr class="hit"><td class="line">126</td><td class="hits">2</td><td class="source">          cb(err ? err : false, usr.token.token);</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">    createImage: function(email, name, cb) {</td></tr><tr class="miss"><td class="line">132</td><td class="hits">0</td><td class="source">      var self = this;</td></tr><tr class="miss"><td class="line">133</td><td class="hits">0</td><td class="source">      this.findOne({email: email}, function(err, user) {</td></tr><tr class="miss"><td class="line">134</td><td class="hits">0</td><td class="source">        if (err || !user) {</td></tr><tr class="miss"><td class="line">135</td><td class="hits">0</td><td class="source">          console.log('err');</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="miss"><td class="line">137</td><td class="hits">0</td><td class="source">          console.log('_______________add image___________');</td></tr><tr class="miss"><td class="line">138</td><td class="hits">0</td><td class="source">          user.images.push({name: name});</td></tr><tr class="miss"><td class="line">139</td><td class="hits">0</td><td class="source">          console.log('___________________________________');</td></tr><tr class="miss"><td class="line">140</td><td class="hits">0</td><td class="source">          user.save(function(err, result) {</td></tr><tr class="miss"><td class="line">141</td><td class="hits">0</td><td class="source">            cb(err ? err : false, user.images);</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source">          });</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source">    getUserImages: function(email, cb) {</td></tr><tr class="miss"><td class="line">148</td><td class="hits">0</td><td class="source">      var self = this;</td></tr><tr class="miss"><td class="line">149</td><td class="hits">0</td><td class="source">      this.findOne({email: email}).exec(function(err, user) {</td></tr><tr class="miss"><td class="line">150</td><td class="hits">0</td><td class="source">        if (err || !user) {</td></tr><tr class="miss"><td class="line">151</td><td class="hits">0</td><td class="source">          cb(err, null);</td></tr><tr class="miss"><td class="line">152</td><td class="hits">0</td><td class="source">        } else if (user.images) {</td></tr><tr class="miss"><td class="line">153</td><td class="hits">0</td><td class="source">          FORMATTED_DATE      = moment(user.DATE_CREATED).format('DD/MM/YYYY');</td></tr><tr class="miss"><td class="line">154</td><td class="hits">0</td><td class="source">          user.FORMATTED_DATE = FORMATTED_DATE;</td></tr><tr class="miss"><td class="line">155</td><td class="hits">0</td><td class="source">          cb(false, user.images);</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="miss"><td class="line">157</td><td class="hits">0</td><td class="source">          cb(false, user.images);</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">159</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source">    </td></tr><tr><td class="line">162</td><td class="hits"></td><td class="source">    getUserToken: function(email, token, cb) {</td></tr><tr class="hit"><td class="line">163</td><td class="hits">2</td><td class="source">      var self = this;</td></tr><tr class="hit"><td class="line">164</td><td class="hits">2</td><td class="source">      self.findOne({email: email})</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source">      .exec(function(err, usr) {</td></tr><tr class="hit"><td class="line">166</td><td class="hits">2</td><td class="source">        if (err || !usr) {</td></tr><tr class="miss"><td class="line">167</td><td class="hits">0</td><td class="source">          console.log('ERROR');</td></tr><tr class="miss"><td class="line">168</td><td class="hits">0</td><td class="source">          cb(err, null);</td></tr><tr class="hit"><td class="line">169</td><td class="hits">2</td><td class="source">        } else if (usr.token &amp;&amp; usr.token.token &amp;&amp; token === usr.token.token) {</td></tr><tr class="hit"><td class="line">170</td><td class="hits">2</td><td class="source">          FORMATTED_DATE     = moment(usr.DATE_CREATED).format('DD/MM/YYYY');</td></tr><tr class="hit"><td class="line">171</td><td class="hits">2</td><td class="source">          usr.FORMATTED_DATE = FORMATTED_DATE;</td></tr><tr class="hit"><td class="line">172</td><td class="hits">2</td><td class="source">          cb(false, usr);</td></tr><tr><td class="line">173</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="miss"><td class="line">174</td><td class="hits">0</td><td class="source">          cb(false, usr);</td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">176</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">178</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source">    encode: function(data) {</td></tr><tr class="hit"><td class="line">180</td><td class="hits">2</td><td class="source">      return jwt.encode(data, tokenSecret);</td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source">    decode: function(data, cb) {</td></tr><tr class="hit"><td class="line">184</td><td class="hits">2</td><td class="source">      try {</td></tr><tr class="hit"><td class="line">185</td><td class="hits">2</td><td class="source">        var decoded = jwt.decode(data, tokenSecret);</td></tr><tr class="hit"><td class="line">186</td><td class="hits">1</td><td class="source">        var self = this;</td></tr><tr class="hit"><td class="line">187</td><td class="hits">1</td><td class="source">        self.findOne({email: decoded.email})</td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source">        .exec(function(err, user) {</td></tr><tr class="hit"><td class="line">189</td><td class="hits">1</td><td class="source">          console.log('test response');</td></tr><tr class="hit"><td class="line">190</td><td class="hits">1</td><td class="source">          console.log(user);</td></tr><tr class="hit"><td class="line">191</td><td class="hits">1</td><td class="source">          if (err || !user) {</td></tr><tr class="miss"><td class="line">192</td><td class="hits">0</td><td class="source">            console.log('ERROR');</td></tr><tr class="miss"><td class="line">193</td><td class="hits">0</td><td class="source">            cb(err, null);</td></tr><tr class="hit"><td class="line">194</td><td class="hits">1</td><td class="source">          } else if (user.token &amp;&amp; user.token.token) {</td></tr><tr class="hit"><td class="line">195</td><td class="hits">1</td><td class="source">            FORMATTED_DATE     = moment(user.DATE_CREATED).format('DD/MM/YYYY');</td></tr><tr class="hit"><td class="line">196</td><td class="hits">1</td><td class="source">            user.FORMATTED_DATE = FORMATTED_DATE;</td></tr><tr class="hit"><td class="line">197</td><td class="hits">1</td><td class="source">            cb(false, user);</td></tr><tr><td class="line">198</td><td class="hits"></td><td class="source">          } else {</td></tr><tr class="miss"><td class="line">199</td><td class="hits">0</td><td class="source">            cb(false, user);</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">202</td><td class="hits"></td><td class="source">      } catch (err) {</td></tr><tr class="hit"><td class="line">203</td><td class="hits">1</td><td class="source">        return cb('Invalide Token');</td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">205</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">206</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">207</td><td class="hits"></td><td class="source">    emailExist: function(email, cb) {</td></tr><tr class="miss"><td class="line">208</td><td class="hits">0</td><td class="source">      this.findOne(email, function(err, usr) {</td></tr><tr class="miss"><td class="line">209</td><td class="hits">0</td><td class="source">        if (err || !usr) {</td></tr><tr class="miss"><td class="line">210</td><td class="hits">0</td><td class="source">          cb(false);</td></tr><tr><td class="line">211</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="miss"><td class="line">212</td><td class="hits">0</td><td class="source">          cb(true);</td></tr><tr><td class="line">213</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">214</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">215</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">216</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">217</td><td class="hits"></td><td class="source">    invalidateUserToken: function(email, cb) {</td></tr><tr class="miss"><td class="line">218</td><td class="hits">0</td><td class="source">      var self = this;</td></tr><tr class="miss"><td class="line">219</td><td class="hits">0</td><td class="source">      console.log('invalidateUserToken');</td></tr><tr class="miss"><td class="line">220</td><td class="hits">0</td><td class="source">      this.findOne({email: email}, function(err, usr) {</td></tr><tr class="miss"><td class="line">221</td><td class="hits">0</td><td class="source">        if (err || !usr) {</td></tr><tr class="miss"><td class="line">222</td><td class="hits">0</td><td class="source">          console.log('err');</td></tr><tr><td class="line">223</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">224</td><td class="hits">0</td><td class="source">        usr.token = null;</td></tr><tr class="miss"><td class="line">225</td><td class="hits">0</td><td class="source">        usr.save(function(err, usr) {</td></tr><tr class="miss"><td class="line">226</td><td class="hits">0</td><td class="source">          cb(err ? err : false, err ? null : 'removed');</td></tr><tr><td class="line">227</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">228</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">229</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">230</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">231</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">232</td><td class="hits">1</td><td class="source">  UserSchema.plugin(passportLocalMongoose, {</td></tr><tr><td class="line">233</td><td class="hits"></td><td class="source">    iterations : 1, </td></tr><tr><td class="line">234</td><td class="hits"></td><td class="source">    usernameQueryFields : ['email'],</td></tr><tr><td class="line">235</td><td class="hits"></td><td class="source">    usernameLowerCase: true</td></tr><tr><td class="line">236</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">237</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">238</td><td class="hits"></td><td class="source">  // create the model for User and expose it to our app</td></tr><tr class="hit"><td class="line">239</td><td class="hits">1</td><td class="source">  mongoose.model('User', UserSchema);</td></tr><tr><td class="line">240</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">241</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/home/lemelon/EIPmaster/newapp/backend/routes/actualityRoutes.js">/home/lemelon/EIPmaster/newapp/backend/routes/actualityRoutes.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">5</div><div class="hits">5</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/*</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> * Module dependencies</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">var path          = require('path');</td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">var ActualityCtrl = require('../controllers/actualityCtrl');</td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">var auth          = require('../authentification/auth');</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> * Defines routes for application</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">var routes = [{</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">    path: '/api/actuality/',</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">    httpMethod: 'GET',</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">    middleware: [ActualityCtrl.getActualities]</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">}, {</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">    path: '/api/actuality',</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">    httpMethod: 'POST',</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">    middleware: [auth.ensureAuthenticated, ActualityCtrl.addActuality]</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">}, {</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">    path: '/api/actuality/:id',</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">    httpMethod: 'DELETE',</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">    middleware: [auth.ensureAuthenticated, ActualityCtrl.removeActuality]</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">}];</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">25</td><td class="hits">1</td><td class="source">module.exports = routes;</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/home/lemelon/EIPmaster/newapp/backend/routes/announces/announceRoutes.js">/home/lemelon/EIPmaster/newapp/backend/routes/announces/announceRoutes.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">5</div><div class="hits">5</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/*</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> * Module dependencies</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">var path          = require('path');</td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">var AnnouncesCtrl = require('../../controllers/announces/announcesCtrl');</td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">var auth          = require('../../authentification/auth');</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> * Defines routes for application</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">var routes = [{</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">    path: '/api/announces',</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">    httpMethod: 'POST',</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">    middleware: [auth.ensureAuthenticated, AnnouncesCtrl.postAnnounce]</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">}, {</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">    path: '/api/announces/:announceId',</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">    httpMethod: 'GET',</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">    middleware: [AnnouncesCtrl.show]</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">}, {</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">    path: '/api/announcesput/:announceId',</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">    httpMethod: 'PUT',</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">    middleware: [auth.ensureAuthenticated, AnnouncesCtrl.updateAnnounce]</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">}, {</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">    path: '/api/announces/:announceId',</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    httpMethod: 'DELETE',</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">    middleware: [auth.ensureAuthenticated, AnnouncesCtrl.deleteAnnounce]</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">}, {</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">    path: '/api/paginateannounces/:page',</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">    httpMethod: 'GET',</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">    middleware: [AnnouncesCtrl.listPagination]</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">}, {</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">    path: '/api/userannounces/:page',</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">    httpMethod: 'GET',</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">    middleware: [auth.ensureAuthenticated, AnnouncesCtrl.listUserPagination]</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">}, {</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">    path: '/api/statusannounce/:announceId/:status',</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">    httpMethod: 'PUT',</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">    middleware: [auth.ensureAuthenticated, AnnouncesCtrl.changeStatusAnnounce]</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">}, {</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">    path: '/api/searchannounces/:terms',</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">    httpMethod: 'GET',</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">    middleware: [AnnouncesCtrl.searchAnnounces]</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">}, {</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">    path: '/api/searchannounces',</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">    httpMethod: 'POST',</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">    middleware: [AnnouncesCtrl.searchAnnounces]</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">];</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">51</td><td class="hits">1</td><td class="source">module.exports = routes;</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/home/lemelon/EIPmaster/newapp/backend/routes/announces/announcesCommentsRoutes.js">/home/lemelon/EIPmaster/newapp/backend/routes/announces/announcesCommentsRoutes.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">5</div><div class="hits">5</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/*</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> * Module dependencies</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">var path                  = require('path');</td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">var AnnouncesCommentsCtrl = require('../../controllers/announces/announcesCommentsCtrl');</td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">var auth                  = require('../../authentification/auth');</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> * Defines routes for application</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">var routes = [{</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">    path: '/api/announceComment/:announceId',</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">    httpMethod: 'POST',</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">    middleware: [auth.ensureAuthenticated, AnnouncesCommentsCtrl.addComment]</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">}, {</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">    path: '/api/announceComment/:id',</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">    httpMethod: 'DELETE',</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">    middleware: [auth.ensureAuthenticated, AnnouncesCommentsCtrl.removeComment]</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">}, {</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">    path: '/api/announceComment/:announceId',</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">    httpMethod: 'GET',</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">    middleware: [AnnouncesCommentsCtrl.getComments]</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">}];</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">25</td><td class="hits">1</td><td class="source">module.exports = routes;</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/home/lemelon/EIPmaster/newapp/backend/routes/imageRoutes.js">/home/lemelon/EIPmaster/newapp/backend/routes/imageRoutes.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">5</div><div class="hits">5</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/*</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> * Module dependencies</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">var path      = require('path');</td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">var ImageCtrl = require('../controllers/imagesCtrl');</td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">var auth      = require('../authentification/auth');</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> * Defines routes for application</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">var routes = [{</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">    path: '/upload',</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">    httpMethod: 'POST',</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">    middleware: [auth.ensureAuthenticated, ImageCtrl.upload]</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">}, {</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">    path: '/api/images',</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">    httpMethod: 'GET',</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">    middleware: [auth.ensureAuthenticated, ImageCtrl.getImages]</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">}, {</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">    path: '/api/images/:imageId',</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">    httpMethod: 'DELETE',</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">    middleware: [auth.ensureAuthenticated, ImageCtrl.deleteImage]</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">}, {</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">    path: '/api/images/:userId',</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    httpMethod: 'GET',</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">    middleware: [auth.ensureAuthenticated, ImageCtrl.getImages]</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">}, {</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">    path: '/api/images/:imageName/:imageId/:defaultImage',</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">    httpMethod: 'PUT',</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">    middleware: [auth.ensureAuthenticated, ImageCtrl.changeImageStatus]</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">}];</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">33</td><td class="hits">1</td><td class="source">module.exports = routes;</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/home/lemelon/EIPmaster/newapp/backend/routes/routes.js">/home/lemelon/EIPmaster/newapp/backend/routes/routes.js</h2><div id="stats" class="high"><div class="percentage">90%</div><div class="sloc">41</div><div class="hits">37</div><div class="misses">4</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/*</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> * Module dependencies</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">var _             = require('underscore');</td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">var path          = require('path');</td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">var express       = require('express');</td></tr><tr class="hit"><td class="line">7</td><td class="hits">1</td><td class="source">var auth          = require('../authentification/auth');</td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">var AnnouncesCtrl = require('../controllers/announces/announcesCtrl');</td></tr><tr class="hit"><td class="line">9</td><td class="hits">1</td><td class="source">var FriendsCtrl   = require('../controllers/friendsCtrl');</td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">var MessagesCtrl  = require('../controllers/sockets/messageCtrl');</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> * Expose routes</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">15</td><td class="hits">1</td><td class="source">var router = express.Router();</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> * Defines routes for application</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">20</td><td class="hits">1</td><td class="source">var indexRoutes = [</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">{</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">  path: '/partials/*',</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">  httpMethod: 'GET',</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">  middleware: [</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    function(req, res) {</td></tr><tr class="miss"><td class="line">26</td><td class="hits">0</td><td class="source">      console.log('_____________get /partials/_____');</td></tr><tr class="miss"><td class="line">27</td><td class="hits">0</td><td class="source">      var requestedView = path.join('./', req.url);</td></tr><tr class="miss"><td class="line">28</td><td class="hits">0</td><td class="source">      res.render(requestedView);</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">  ]</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">}, {</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">  path: '/*',</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">  httpMethod: 'GET',</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">  middleware: [</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">    function(req, res) {</td></tr><tr class="hit"><td class="line">36</td><td class="hits">1</td><td class="source">      res.render('index');</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">  ]},</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">];</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">41</td><td class="hits">1</td><td class="source">module.exports = function(app) {</td></tr><tr class="hit"><td class="line">42</td><td class="hits">1</td><td class="source">  console.log('********************************routes*************************************');</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">44</td><td class="hits">1</td><td class="source">  var announceRoutes          = require('./announces/announceRoutes');</td></tr><tr class="hit"><td class="line">45</td><td class="hits">1</td><td class="source">  var messageRoutes           = require('./sockets/messageRoutes');</td></tr><tr class="hit"><td class="line">46</td><td class="hits">1</td><td class="source">  var roomsRoutes             = require('./sockets/roomsRoutes');</td></tr><tr class="hit"><td class="line">47</td><td class="hits">1</td><td class="source">  var imageRoutes             = require('./imageRoutes');</td></tr><tr class="hit"><td class="line">48</td><td class="hits">1</td><td class="source">  var userRoutes              = require('./users/userRoutes');</td></tr><tr class="hit"><td class="line">49</td><td class="hits">1</td><td class="source">  var findRoutes              = require('./users/findRoutes');</td></tr><tr class="hit"><td class="line">50</td><td class="hits">1</td><td class="source">  var sessionRoutes           = require('./sessions/sessionRoutes');</td></tr><tr class="hit"><td class="line">51</td><td class="hits">1</td><td class="source">  var announcesCommentsRoutes = require('./announces/announcesCommentsRoutes');</td></tr><tr class="hit"><td class="line">52</td><td class="hits">1</td><td class="source">  var notificationRoutes      = require('./sockets/notificationRoutes');</td></tr><tr class="hit"><td class="line">53</td><td class="hits">1</td><td class="source">  var likeRoutes              = require('./sockets/likeRoutes');</td></tr><tr class="hit"><td class="line">54</td><td class="hits">1</td><td class="source">  var statusRoutes            = require('./statusRoutes');</td></tr><tr class="hit"><td class="line">55</td><td class="hits">1</td><td class="source">  var actualityRoutes         = require('./actualityRoutes');</td></tr><tr class="hit"><td class="line">56</td><td class="hits">1</td><td class="source">  var friendsRoutes           = require('./sockets/friendsRoutes');</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">58</td><td class="hits">1</td><td class="source">  var routes = announceRoutes</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">  .concat(friendsRoutes)</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">  .concat(imageRoutes)</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">  .concat(findRoutes)</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">  .concat(notificationRoutes)</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">  .concat(likeRoutes)</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">  .concat(statusRoutes)</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">  .concat(actualityRoutes)</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">  .concat(messageRoutes)</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">  .concat(roomsRoutes)</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">  .concat(sessionRoutes)</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">  .concat(announcesCommentsRoutes)</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">  .concat(indexRoutes);</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">72</td><td class="hits">1</td><td class="source">  _.each(routes, function(route) {</td></tr><tr class="hit"><td class="line">73</td><td class="hits">50</td><td class="source">    var args = _.flatten([route.path, route.middleware]);</td></tr><tr class="hit"><td class="line">74</td><td class="hits">50</td><td class="source">    switch (route.httpMethod.toUpperCase()) {</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">      case 'GET':</td></tr><tr class="hit"><td class="line">76</td><td class="hits">23</td><td class="source">        app.get.apply(app, args);</td></tr><tr class="hit"><td class="line">77</td><td class="hits">23</td><td class="source">        break;</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">      case 'POST':</td></tr><tr class="hit"><td class="line">79</td><td class="hits">13</td><td class="source">        app.post.apply(app, args);</td></tr><tr class="hit"><td class="line">80</td><td class="hits">13</td><td class="source">        break;</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">      case 'PUT':</td></tr><tr class="hit"><td class="line">82</td><td class="hits">4</td><td class="source">        app.put.apply(app, args);</td></tr><tr class="hit"><td class="line">83</td><td class="hits">4</td><td class="source">        break;</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">      case 'DELETE':</td></tr><tr class="hit"><td class="line">85</td><td class="hits">10</td><td class="source">        app.delete.apply(app, args);</td></tr><tr class="hit"><td class="line">86</td><td class="hits">10</td><td class="source">        break;</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">      default:</td></tr><tr class="miss"><td class="line">88</td><td class="hits">0</td><td class="source">        throw new Error('Invalid HTTP method specified for route ' +</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">            route.path);</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/home/lemelon/EIPmaster/newapp/backend/routes/sessions/sessionRoutes.js">/home/lemelon/EIPmaster/newapp/backend/routes/sessions/sessionRoutes.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">5</div><div class="hits">5</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/*</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> * Module dependencies</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">var path        = require('path');</td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">var passport    = require('passport');</td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">var SessionCtrl = require('../../controllers/session/sessionCtrl');</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> * Defines routes for application</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">var routes = [</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">  /*</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">   * Authentication routes</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">  {</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">      path: '/auth/logout',</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">      httpMethod: 'DELETE',</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">      middleware: [SessionCtrl.logout]</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">   * Post method to register a new user</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">  {</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">      path: '/auth/register',</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">      httpMethod: 'POST',</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">      middleware: [SessionCtrl.register]</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">   * Login method</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">  {</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">      path: '/auth/login',</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">      httpMethod: 'POST',</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">      middleware: [SessionCtrl.passportAuthenticate, SessionCtrl.authenticate]</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">];</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">39</td><td class="hits">1</td><td class="source">module.exports = routes;</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/home/lemelon/EIPmaster/newapp/backend/routes/sockets/friendsRoutes.js">/home/lemelon/EIPmaster/newapp/backend/routes/sockets/friendsRoutes.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">5</div><div class="hits">5</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/*</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> * Module dependencies</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">var path        = require('path');</td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">var FriendsCtrl = require('../../controllers/friendsCtrl');</td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">var auth        = require('../../authentification/auth');</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> * Defines routes for application</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">var routes = [</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">{</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">    path: '/api/friends/:friendId/:user',</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">    httpMethod: 'DELETE',</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">    middleware: [auth.ensureAuthenticated, FriendsCtrl.deleteFriend]</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">}, {</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">    path: '/api/friends/:user',</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">    httpMethod: 'GET',</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">    middleware: [auth.ensureAuthenticated, FriendsCtrl.testIfFriend]</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">}, {</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">    path: '/api/countfriends/:idUser',</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">    httpMethod: 'GET',</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">    middleware: [auth.ensureAuthenticated, FriendsCtrl.countFriends]</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">}, {</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    path: '/api/getfriends/',</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">    httpMethod: 'GET',</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">    middleware: [auth.ensureAuthenticated, FriendsCtrl.getFriendsFromUser]</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">}, {</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">    path: '/api/friends/',</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">    httpMethod: 'POST',</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">    middleware: [auth.ensureAuthenticated, FriendsCtrl.postFriend]</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">];</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">35</td><td class="hits">1</td><td class="source">module.exports = routes;</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/home/lemelon/EIPmaster/newapp/backend/routes/sockets/messageRoutes.js">/home/lemelon/EIPmaster/newapp/backend/routes/sockets/messageRoutes.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">5</div><div class="hits">5</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/*</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> * Module dependencies</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">var path         = require('path');</td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">var MessagesCtrl = require('../../controllers/sockets/messageCtrl');</td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">var auth         = require('../../authentification/auth');</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> * Defines routes for application</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">var routes = [{</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        path: '/api/messages',</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        httpMethod: 'POST',</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        middleware: [MessagesCtrl.create]</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">    {</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">        path: '/api/messages/:messageId',</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">        httpMethod: 'GET',</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">        middleware: [MessagesCtrl.all]</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">    {</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">        path: '/api/messages/user/:messageUsername',</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">        httpMethod: 'GET',</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">        middleware: [MessagesCtrl.userMessage]</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">];</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">28</td><td class="hits">1</td><td class="source">module.exports = routes;</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/home/lemelon/EIPmaster/newapp/backend/routes/sockets/notificationRoutes.js">/home/lemelon/EIPmaster/newapp/backend/routes/sockets/notificationRoutes.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">5</div><div class="hits">5</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/*</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> * Module dependencies</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">var path             = require('path');</td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">var NotificationCtrl = require('../../controllers/sockets/notificationCtrl');</td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">var auth             = require('../../authentification/auth');</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> * Defines routes for application</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">var routes = [{</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">  path: '/api/notifications/',</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">  httpMethod: 'GET',</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">  middleware: [auth.ensureAuthenticated, NotificationCtrl.getNotifications]</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">}, {</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">  path: '/api/notifications/',</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">  httpMethod: 'POST',</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">  middleware: [auth.ensureAuthenticated, NotificationCtrl.saveNotification]</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">}, {</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">  path: '/api/notifications/:notificationToDelete',</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">  httpMethod: 'DELETE',</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">  middleware: [auth.ensureAuthenticated, NotificationCtrl.deleteNotification]</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">}];</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">25</td><td class="hits">1</td><td class="source">module.exports = routes;</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/home/lemelon/EIPmaster/newapp/backend/routes/sockets/roomsRoutes.js">/home/lemelon/EIPmaster/newapp/backend/routes/sockets/roomsRoutes.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">5</div><div class="hits">5</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/*</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> * Module dependencies</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">var path      = require('path');</td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">var RoomsCtrl = require('../../controllers/sockets/roomCtrl');</td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">var auth      = require('../../authentification/auth');</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> * Defines routes for application</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">var routes = [</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">  {</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">    path: '/api/rooms',</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">    httpMethod: 'POST',</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">    middleware: [auth.ensureAuthenticated, RoomsCtrl.create]</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">  {</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">    path: '/api/rooms/:roomId',</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">    httpMethod: 'PUT',</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">    middleware: [auth.ensureAuthenticated, RoomsCtrl.update]</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">  {</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">    path: '/api/rooms/:roomId',</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">    httpMethod: 'DELETE',</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    middleware: [auth.ensureAuthenticated, RoomsCtrl.destroy]</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">  {</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">    path: '/api/rooms',</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">    httpMethod: 'GET',</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">    middleware: [auth.ensureAuthenticated, RoomsCtrl.all]</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">];</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">34</td><td class="hits">1</td><td class="source">module.exports = routes;</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/home/lemelon/EIPmaster/newapp/backend/routes/statusRoutes.js">/home/lemelon/EIPmaster/newapp/backend/routes/statusRoutes.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">5</div><div class="hits">5</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/*</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> * Module dependencies</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">var path       = require('path');</td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">var StatusCtrl = require('../controllers/statusCtrl');</td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">var auth       = require('../authentification/auth');</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> * Defines routes for application</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">var routes = [{</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">    path: '/api/status/:statusId',</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">    httpMethod: 'GET',</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">    middleware: [StatusCtrl.getStatus]</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">}, {</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">    path: '/api/status/:statusId',</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">    httpMethod: 'POST',</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">    middleware: [auth.ensureAuthenticated, StatusCtrl.addStatus]</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">}, {</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">    path: '/api/status/:id',</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">    httpMethod: 'DELETE',</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">    middleware: [auth.ensureAuthenticated, StatusCtrl.deleteStatus]</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">}];</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">25</td><td class="hits">1</td><td class="source">module.exports = routes;</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/home/lemelon/EIPmaster/newapp/backend/routes/users/findRoutes.js">/home/lemelon/EIPmaster/newapp/backend/routes/users/findRoutes.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">5</div><div class="hits">5</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/*</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> * Module dependencies</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">var path     = require('path');</td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">var FindCtrl = require('../../controllers/users/findCtrl');</td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">var auth     = require('../../authentification/auth');</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> * Defines routes for application</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">var routes = [</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">{</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">    path: '/api/usershow/:id',</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">    httpMethod: 'GET',</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">    middleware: [FindCtrl.show]</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">},</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">{</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">    path: '/search',</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">    httpMethod: 'GET',</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">    middleware: [FindCtrl.search]</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">}, {</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">    path: '/auth/username-exists',</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">    httpMethod: 'GET',</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">    middleware: [FindCtrl.userExist]</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">}, {</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">    path: '/auth/email-exists',</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">    httpMethod: 'GET',</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">    middleware: [FindCtrl.emailExist]</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">}];</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">31</td><td class="hits">1</td><td class="source">module.exports = routes;</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div></div></div></body></html>